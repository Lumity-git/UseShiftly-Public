<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Employee Directory - Hotel Scheduler</title>
    <link rel="stylesheet" href="style.css">
  </head>
  <body>
    <div class="header">
      <div class="header-content">
        <div class="logo">üè® Hotel Scheduler</div>
        <nav class="nav-links" id="navigation">
          <!-- Navigation will be populated based on user role -->
        </nav>
        <div class="user-info">
          <span id="userName">Loading...</span>
          <button class="btn btn-danger btn-small" onclick="logout()">
            Logout
          </button>
        </div>
      </div>
    </div>

    <div class="container">

      <div class="filters">
        <div class="filter-row">
          <div class="filter-group">
            <label for="searchTerm">Search Employee</label>
            <input
              type="text"
              id="searchTerm"
              placeholder="Search by name, email, or phone"
            />
          </div>
          <div class="filter-group">
            <label for="departmentFilter">Department</label>
            <select id="departmentFilter">
              <option value="">All Departments</option>
            </select>
          </div>
          <div class="filter-group">
            <label for="roleFilter">Role</label>
            <select id="roleFilter">
              <option value="">All Roles</option>
              <option value="ADMIN">Admin</option>
              <option value="MANAGER">Manager</option>
              <option value="EMPLOYEE">Employee</option>
            </select>
          </div>
          <div class="filter-group">
            <label for="statusFilter">Status</label>
            <select id="statusFilter">
              <option value="">All Statuses</option>
              <option value="true">Active</option>
              <option value="false">Inactive</option>
            </select>
          </div>
        </div>
        <div class="action-buttons" id="actionButtons">
          <!-- Buttons will be populated based on user role -->
        </div>
      </div>

      <div id="alertContainer"></div>

      <div id="employeesContainer">
        <div class="loading">
          <div class="spinner"></div>
          <p>Loading employees...</p>
        </div>
      </div>

      <!-- Employee Registration Invitation Section (Admin/Manager only) -->
      <div
        id="invitationSection"
        class="invitation-section"
        style="display: none"
      >
        <h3 class="invitation-title">üìß Employee Registration Invitations</h3>
        <p>
          Create secure invitation links for new employees to register with
          proper documentation.
        </p>

        <button class="btn btn-primary" onclick="openInvitationModal()">
          ‚ûï Create Invitation Link
        </button>

        <div id="pendingInvitations" class="pending-invitations">
          <!-- Pending invitations will be loaded here -->
        </div>
      </div>
    </div>

    <!-- Employee Modal -->
    <div id="employeeModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title" id="employeeModalTitle">Employee Details</h3>
          <button class="close" onclick="closeEmployeeModal()">&times;</button>
        </div>
        <form id="employeeForm">
          <div class="form-row">
            <div class="form-group">
              <label for="firstName">First Name</label>
              <input type="text" id="firstName" name="firstName" required />
            </div>
            <div class="form-group">
              <label for="lastName">Last Name</label>
              <input type="text" id="lastName" name="lastName" required />
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="email">Email Address</label>
              <input type="email" id="email" name="email" required />
            </div>
            <div class="form-group">
              <label for="phoneNumber">Phone Number</label>
              <input type="tel" id="phoneNumber" name="phoneNumber" />
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="role">Role</label>
              <select id="role" name="role" required>
                <option value="EMPLOYEE">Employee</option>
                <option value="MANAGER">Manager</option>
                <option value="ADMIN">Admin</option>
              </select>
            </div>
            <div class="form-group">
              <label for="department">Department</label>
              <select id="department" name="departmentId">
                <option value="">Select Department</option>
              </select>
            </div>
          </div>
          <div class="form-group">
            <label for="active">Status</label>
            <select id="active" name="active">
              <option value="true">Active</option>
              <option value="false">Inactive</option>
            </select>
          </div>
          <div class="action-buttons">
            <button type="submit" class="btn btn-primary">
              üíæ Save Employee
            </button>
            <button
              type="button"
              class="btn btn-secondary"
              onclick="closeEmployeeModal()"
            >
              ‚ùå Cancel
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Invitation Modal -->
    <div id="invitationModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title">Create Employee Invitation</h3>
          <button class="close" onclick="closeInvitationModal()">
            &times;
          </button>
        </div>
        <form id="invitationForm">
          <div class="form-row">
            <div class="form-group">
              <label for="inviteFirstName">First Name</label>
              <input
                type="text"
                id="inviteFirstName"
                name="firstName"
                required
              />
            </div>
            <div class="form-group">
              <label for="inviteLastName">Last Name</label>
              <input type="text" id="inviteLastName" name="lastName" required />
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="inviteEmail">Email Address</label>
              <input type="email" id="inviteEmail" name="email" required />
            </div>
            <div class="form-group">
              <label for="invitePhone">Phone Number</label>
              <input type="tel" id="invitePhone" name="phoneNumber" required />
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="inviteRole">Default Role</label>
              <select id="inviteRole" name="role" required>
                <option value="EMPLOYEE">Employee</option>
                <option value="MANAGER">Manager</option>
              </select>
            </div>
            <div class="form-group">
              <label for="inviteDepartment">Department</label>
              <select id="inviteDepartment" name="departmentId" required>
                <option value="">Select Department</option>
              </select>
            </div>
          </div>
          <div class="form-group">
            <label for="inviteNotes">Notes for HR/Legal</label>
            <textarea
              id="inviteNotes"
              name="notes"
              rows="3"
              placeholder="Documentation requirements, position details, etc."
            ></textarea>
          </div>
          <div class="form-group">
            <label for="expiryDays">Invitation Expires In (Days)</label>
            <select id="expiryDays" name="expiryDays">
              <option value="7">7 Days</option>
              <option value="14" selected>14 Days</option>
              <option value="30">30 Days</option>
            </select>
          </div>
          <div class="action-buttons">
            <button type="submit" class="btn btn-primary">
              üìß Generate Invitation Link
            </button>
            <button
              type="button"
              class="btn btn-secondary"
              onclick="closeInvitationModal()"
            >
              ‚ùå Cancel
            </button>
          </div>
        </form>
      </div>
    </div>

    <script src="auto-logout.js"></script>
    <script src="auth-manager.js"></script>
    <script>
      let currentUser = null;
      const API_BASE_URL = "http://localhost:8080/api";

      // Initialize page
      document.addEventListener("DOMContentLoaded", async function () {
        if (!authManager.checkAuth(["MANAGER", "ADMIN"])) return;

        loadUserInfo();
        loadDepartments();
        loadEmployees();
        setupEventListeners();
        setupActionButtons();

        // Load invitations if user is admin/manager
        if (canManageEmployees()) {
          loadPendingInvitations();
          document.getElementById("invitationSection").style.display = "block";
        }
      });

      function setupEventListeners() {
        document
          .getElementById("searchTerm")
          .addEventListener("input", filterEmployees);
        document
          .getElementById("departmentFilter")
          .addEventListener("change", filterEmployees);
        document
          .getElementById("roleFilter")
          .addEventListener("change", filterEmployees);
        document
          .getElementById("statusFilter")
          .addEventListener("change", filterEmployees);
        document
          .getElementById("employeeForm")
          .addEventListener("submit", handleEmployeeSubmit);
        document
          .getElementById("invitationForm")
          .addEventListener("submit", handleInvitationSubmit);
      }

      function setupActionButtons() {
        const actionButtons = document.getElementById("actionButtons");

        if (canManageEmployees()) {
          actionButtons.innerHTML = `
                          <button class="btn btn-primary" onclick="openCreateEmployeeModal()">
                              ‚ûï Add Employee
                          </button>
                          <button class="btn btn-secondary" onclick="loadEmployees()">
                              üîÑ Refresh
                          </button>
                          <button class="btn btn-success" onclick="exportEmployees()">
                              üìä Export
                          </button>
                      `;
        } else {
          actionButtons.innerHTML = `
                          <button class="btn btn-secondary" onclick="loadEmployees()">
                              üîÑ Refresh
                          </button>
                      `;
        }
      }

      // Authentication
      async function checkAuth() {
        const token = localStorage.getItem("authToken");
        const userInfo = localStorage.getItem("userInfo");

        if (!token || !userInfo) {
          window.location.href = "login.html";
          return false;
        }

        const user = JSON.parse(userInfo);

        try {
          // Validate token by making a test API call
          const response = await fetch(
            "http://localhost:8080/api/auth/validate",
            {
              method: "GET",
              headers: {
                Authorization: `Bearer ${token}`,
                "Content-Type": "application/json",
              },
            }
          );

          if (!response.ok) {
                localStorage.removeItem("authToken");
                localStorage.removeItem("userInfo");
                window.location.href = "login.html";
            return false;
          }

          return true;
        } catch (error) {
          console.error("Auth validation failed:", error);
            localStorage.removeItem("authToken");
            localStorage.removeItem("userInfo");
            window.location.href = "login.html";
          return false;
        }
      }

      function loadUserInfo() {
        const userInfo = localStorage.getItem("userInfo");
        if (userInfo) {
          currentUser = JSON.parse(userInfo);
          document.getElementById(
            "userName"
          ).textContent = `${currentUser.firstName} ${currentUser.lastName}`;
          setupNavigation(currentUser.role);
        }
      }

      function setupNavigation(userRole) {
        const navigation = document.getElementById("navigation");
        let navLinks = "";

        // Common links for all users
        navLinks += '<a href="dashboard.html" class="nav-link">Dashboard</a>';
        navLinks += '<a href="shifts.html" class="nav-link">Shifts</a>';
        navLinks += '<a href="trades.html" class="nav-link">Trades</a>';
        navLinks +=
          '<a href="notifications.html" class="nav-link">Notifications</a>';

        // Manager and Admin only links
        if (userRole === "MANAGER" || userRole === "ADMIN") {
          navLinks +=
            '<a href="employees.html" class="nav-link active">Employees</a>';
          navLinks += '<a href="reports.html" class="nav-link">Reports</a>';
          navLinks +=
            '<a href="departments.html" class="nav-link">Departments</a>';
        }

        navigation.innerHTML = navLinks;
      }

      function logout() {
        localStorage.removeItem("authToken");
        localStorage.removeItem("userInfo");
        window.location.href = "login.html";
      }

      // API Helpers
      async function apiRequest(endpoint, options = {}) {
        const token = localStorage.getItem("authToken");
        const url = `${API_BASE_URL}${endpoint}`;

        const config = {
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${token}`,
            ...options.headers,
          },
          ...options,
        };

        try {
          const response = await fetch(url, config);

          if (response.status === 401) {
                logout();
            return;
          }

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          return await response.json();
        } catch (error) {
          console.error("API Request failed:", error);
          showAlert("Network error. Please check your connection.", "error");
          throw error;
        }
      }

      // Load data
      async function loadDepartments() {
        try {
          departments = await apiRequest("/departments");
          populateDepartmentSelects();
        } catch (error) {
          console.error("Failed to load departments:", error);
        }
      }

      async function loadEmployees() {
        try {
          employees = await apiRequest("/employees");
          console.log("Loaded employees:", employees); // Add this line
          renderEmployees();
        } catch (error) {
          console.error("Failed to load employees:", error);
          document.getElementById("employeesContainer").innerHTML =
            '<div class="alert alert-error">Failed to load employees. Please try again.</div>';
        }
      }

      async function loadPendingInvitations() {
        try {
          // Use correct backend API for active invitations
          const invitations = await apiRequest("/auth/active-invitations");
          renderPendingInvitations(invitations);
        } catch (error) {
          console.error("Failed to load active invitations:", error);
        }
      }

      // Populate selects
      function populateDepartmentSelects() {
        const selects = ["departmentFilter", "department", "inviteDepartment"];
        selects.forEach((selectId) => {
          const select = document.getElementById(selectId);
          if (!select) return;

          if (selectId === "departmentFilter") {
            select.innerHTML = '<option value="">All Departments</option>';
          } else {
            select.innerHTML = '<option value="">Select Department</option>';
          }

          departments.forEach((dept) => {
            const option = document.createElement("option");
            option.value = dept.id;
            option.textContent = dept.name;
            select.appendChild(option);
          });
        });
      }

      // Render employees
      function renderEmployees(filteredEmployees = employees) {
        const container = document.getElementById("employeesContainer");

        if (filteredEmployees.length === 0) {
          container.innerHTML =
            '<div class="alert alert-info">No employees found for the selected criteria.</div>';
          return;
        }

        const employeesHtml = filteredEmployees
          .map(function (employee) {
            let html = '<div class="employee-card">';
            html += '<div class="employee-header">';
            html += "<div>";
            html +=
              '<div class="employee-name">' +
              employee.firstName +
              " " +
              employee.lastName +
              "</div>";
            html +=
              '<div class="employee-role role-' +
              employee.role.toLowerCase() +
              '">' +
              employee.role +
              "</div>";
            html += "</div>";
            html +=
              '<div class="employee-status">' +
              (employee.active ? "‚úÖ Active" : "‚ùå Inactive") +
              "</div>";
            html += "</div>";
            html += '<div class="employee-info">';
            html +=
              '<div class="employee-detail"><strong>Email:</strong> <span>' +
              employee.email +
              "</span></div>";
            html +=
              '<div class="employee-detail"><strong>Phone:</strong> <span>' +
              (employee.phoneNumber || "Not provided") +
              "</span></div>";
            html +=
              '<div class="employee-detail"><strong>Department:</strong> <span>' +
              (employee.departmentName || "Unassigned") +
              "</span></div>";
            html +=
              '<div class="employee-detail"><strong>Joined:</strong> <span>' +
              formatDate(employee.createdAt) +
              "</span></div>";
            html += "</div>";
            html += '<div class="employee-actions">';
            html +=
              '<button class="btn btn-primary btn-small" onclick="viewEmployeeSchedule(' +
              employee.id +
              ')">üìÖ Schedule</button>';
            if (canManageEmployees()) {
              html +=
                '<button class="btn btn-secondary btn-small" onclick="editEmployee(' +
                employee.id +
                ')">‚úèÔ∏è Edit</button>';
              html +=
                '<button class="btn ' +
                (employee.active ? "btn-warning" : "btn-success") +
                ' btn-small" onclick="toggleEmployeeStatus(' +
                employee.id +
                ", " +
                !employee.active +
                ')">' +
                (employee.active ? "‚è∏Ô∏è Deactivate" : "‚ñ∂Ô∏è Activate") +
                "</button>";
            }
            html += "</div>";
            html += "</div>";
            return html;
          })
          .join("");
        container.innerHTML =
          '<div class="employees-grid">' + employeesHtml + "</div>";
      }

      function renderPendingInvitations(invitations) {
        const container = document.getElementById("pendingInvitations");

        if (invitations.length === 0) {
          container.innerHTML = "<p>No pending invitations.</p>";
          return;
        }

        const invitationsHtml = invitations
          .map(function (invitation) {
            let html = '<div class="invitation-card">';
            html +=
              '<div class="employee-detail"><strong>Name:</strong> <span>' +
              invitation.firstName +
              " " +
              invitation.lastName +
              "</span></div>";
            html +=
              '<div class="employee-detail"><strong>Email:</strong> <span>' +
              invitation.email +
              "</span></div>";
            html +=
              '<div class="employee-detail"><strong>Role:</strong> <span>' +
              invitation.role +
              "</span></div>";
            html +=
              '<div class="employee-detail"><strong>Expires:</strong> <span>' +
              formatDate(invitation.expiresAt) +
              "</span></div>";
            html += '<div class="invitation-actions">';
            html +=
              '<button class="btn btn-primary btn-small" onclick="copyInvitationLink(\'' +
              invitation.token +
              "')\">üìã Copy Link</button>";
            html +=
              '<button class="btn btn-secondary btn-small" onclick="resendInvitation(\'' +
              invitation.id +
              "')\">üìß Resend</button>";
            html +=
              '<button class="btn btn-danger btn-small" onclick="revokeInvitation(\'' +
              invitation.id +
              "')\">üóëÔ∏è Revoke</button>";
            html += "</div>";
            html += "</div>";
            return html;
          })
          .join("");
        container.innerHTML = invitationsHtml;
      }

      // Filter employees
      function filterEmployees() {
        const searchTerm = document
          .getElementById("searchTerm")
          .value.toLowerCase();
        const departmentFilter =
          document.getElementById("departmentFilter").value;
        const roleFilter = document.getElementById("roleFilter").value;
        const statusFilter = document.getElementById("statusFilter").value;

        const filtered = employees.filter((employee) => {
          const matchesSearch =
            employee.firstName.toLowerCase().includes(searchTerm) ||
            employee.lastName.toLowerCase().includes(searchTerm) ||
            employee.email.toLowerCase().includes(searchTerm) ||
            (employee.phoneNumber && employee.phoneNumber.includes(searchTerm));

          const matchesDepartment =
            !departmentFilter || employee.departmentId == departmentFilter;
          const matchesRole = !roleFilter || employee.role === roleFilter;
          const matchesStatus =
            !statusFilter || employee.active.toString() === statusFilter;

          return (
            matchesSearch && matchesDepartment && matchesRole && matchesStatus
          );
        });

        renderEmployees(filtered);
      }

      // Modal functions
      function openCreateEmployeeModal() {
        editingEmployeeId = null;
        document.getElementById("employeeModalTitle").textContent =
          "Add New Employee";
        document.getElementById("employeeForm").reset();
        document.getElementById("employeeModal").style.display = "block";
      }

      function closeEmployeeModal() {
        document.getElementById("employeeModal").style.display = "none";
        editingEmployeeId = null;
      }

      function openInvitationModal() {
        document.getElementById("invitationForm").reset();
        document.getElementById("invitationModal").style.display = "block";
      }

      function closeInvitationModal() {
        document.getElementById("invitationModal").style.display = "none";
      }

      async function editEmployee(employeeId) {
        try {
          const employee = await apiRequest(`/employees/${employeeId}`);
          editingEmployeeId = employeeId;

          document.getElementById("employeeModalTitle").textContent =
            "Edit Employee";
          document.getElementById("firstName").value = employee.firstName;
          document.getElementById("lastName").value = employee.lastName;
          document.getElementById("email").value = employee.email;
          document.getElementById("phoneNumber").value =
            employee.phoneNumber || "";
          document.getElementById("role").value = employee.role;
          document.getElementById("department").value =
            employee.departmentId || "";
          document.getElementById("active").value = employee.active.toString();

          document.getElementById("employeeModal").style.display = "block";
        } catch (error) {
          showAlert("Failed to load employee details", "error");
        }
      }

      async function handleEmployeeSubmit(e) {
        e.preventDefault();

        const formData = new FormData(e.target);
        const employeeData = {
          firstName: formData.get("firstName"),
          lastName: formData.get("lastName"),
          email: formData.get("email"),
          phoneNumber: formData.get("phoneNumber") || null,
          role: formData.get("role"),
          departmentId: formData.get("departmentId")
            ? parseInt(formData.get("departmentId"))
            : null,
          active: formData.get("active") === "true",
        };

        try {
          if (editingEmployeeId) {
            await apiRequest(`/employees/${editingEmployeeId}`, {
              method: "PUT",
              body: JSON.stringify(employeeData),
            });
            showAlert("Employee updated successfully!", "success");
          } else {
            await apiRequest("/employees", {
              method: "POST",
              body: JSON.stringify(employeeData),
            });
            showAlert("Employee created successfully!", "success");
          }

          closeEmployeeModal();
          loadEmployees();
        } catch (error) {
          showAlert("Failed to save employee. Please try again.", "error");
        }
      }

      async function handleInvitationSubmit(e) {
        e.preventDefault();

        const formData = new FormData(e.target);
        const invitationData = {
          firstName: formData.get("firstName"),
          lastName: formData.get("lastName"),
          email: formData.get("email"),
          phoneNumber: formData.get("phoneNumber"),
          role: formData.get("role"),
          departmentId: parseInt(formData.get("departmentId")),
          notes: formData.get("notes"),
          expiryDays: parseInt(formData.get("expiryDays")),
        };

        try {
          const response = await apiRequest("/auth/generate-invitation", {
            method: "POST",
            body: JSON.stringify(invitationData),
          });

          showAlert("Invitation created successfully!", "success");
          closeInvitationModal();
          loadPendingInvitations();

          // Show the invitation link
          const inviteUrl = `${window.location.origin}/register.html?code=${response.invitationCode}&token=${response.invitationToken}`;
          prompt(
            "Invitation link created! Copy this link to send to the employee:",
            inviteUrl
          );
        } catch (error) {
          showAlert("Failed to create invitation. Please try again.", "error");
        }
      }

      async function toggleEmployeeStatus(employeeId, active) {
        if (!active) {
            if (!confirm("Are you sure you want to deactivate this employee?")) return;
            try {
                await apiRequest(`/employees/${employeeId}`, {
                    method: "DELETE"
                });
                showAlert("Employee deactivated successfully!", "success");
                loadEmployees();
            } catch (error) {
                showAlert("Failed to deactivate employee", "error");
            }
        } else {
            // Optionally implement activation endpoint in backend, or show error
            showAlert("Activation is not supported. Please contact admin.", "error");
        }
      }

      function viewEmployeeSchedule(employeeId) {
        window.location.href = `shifts.html?employeeId=${employeeId}`;
      }

      async function copyInvitationLink(token, code) {
        const inviteUrl = `${window.location.origin}/register.html?code=${code}&token=${token}`;
        try {
          await navigator.clipboard.writeText(inviteUrl);
          showAlert("Invitation link copied to clipboard!", "success");
        } catch (error) {
          prompt("Copy this invitation link:", inviteUrl);
        }
      }

      async function resendInvitation(invitationId) {
        try {
          // No direct resend endpoint in backend, so just show info for now
          showAlert("Resend functionality not implemented in backend.", "info");
        } catch (error) {
          showAlert("Failed to resend invitation", "error");
        }
      }

      async function revokeInvitation(invitationId) {
        if (!confirm("Are you sure you want to revoke this invitation?")) return;
        try {
            await apiRequest(`/auth/delete-invitation/${invitationId}`, {
                method: "DELETE",
            });
            showAlert("Invitation revoked successfully!", "success");
            loadPendingInvitations();
        } catch (error) {
            showAlert("Failed to revoke invitation", "error");
        }
      }

      function showAlert(message, type = "info") {
        const alertContainer = document.getElementById("alertContainer");
        const alertClass = type === "error" ? "alert-error" : "alert-success";
        alertContainer.innerHTML = `
            <div class="alert ${alertClass}">
                ${message}
            </div>
        `;
        setTimeout(() => {
            alertContainer.innerHTML = "";
        }, 5000);
    }

    function formatDate(dateString) {
      if (!dateString) return "N/A";
      const date = new Date(dateString);
      if (isNaN(date.getTime())) return dateString;
      return date.toLocaleDateString() + " " + date.toLocaleTimeString();
    }

    function canManageEmployees() {
      return currentUser && (currentUser.role === "MANAGER" || currentUser.role === "ADMIN");
    }
    </script>
  </body>
</html>
