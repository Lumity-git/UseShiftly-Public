<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Change Password - Hotel Scheduler</title>
    <link rel="stylesheet" href="style.css">
</head>
<body class="login-page">
    <div class="login-container">
        <div class="login-right">
            <div class="login-header">
                <h2>Change Your Password</h2>
                <p>For security, you must set a new password before continuing.</p>
            </div>
            <div id="alert" class="alert"></div>
            <form id="changePasswordForm">
                <div class="form-group">
                    <label for="newPassword">New Password</label>
                    <input type="password" id="newPassword" name="newPassword" required placeholder="Enter new password">
                </div>
                <div class="form-group">
                    <label for="confirmPassword">Confirm New Password</label>
                    <input type="password" id="confirmPassword" name="confirmPassword" required placeholder="Confirm new password">
                </div>
                <button type="submit" class="login-btn" id="changeBtn">Change Password</button>
            </form>
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <span>Updating password...</span>
            </div>
        </div>
    </div>
    <script>
        const API_BASE_URL = 'http://localhost:8080/api';
        const changeForm = document.getElementById('changePasswordForm');
        const newPasswordInput = document.getElementById('newPassword');
        const confirmPasswordInput = document.getElementById('confirmPassword');
        const changeBtn = document.getElementById('changeBtn');
        const alertDiv = document.getElementById('alert');
        const loadingDiv = document.getElementById('loading');

        function showAlert(message, type = 'error') {
            alertDiv.textContent = message;
            alertDiv.className = `alert ${type}`;
            alertDiv.style.display = 'block';
        }
        function hideAlert() {
            alertDiv.style.display = 'none';
        }
        function showLoading() {
            changeBtn.style.display = 'none';
            loadingDiv.style.display = 'block';
        }
        function hideLoading() {
            changeBtn.style.display = 'block';
            loadingDiv.style.display = 'none';
        }

        changeForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const newPassword = newPasswordInput.value.trim();
            const confirmPassword = confirmPasswordInput.value.trim();
            if (!newPassword || !confirmPassword) {
                showAlert('Please fill in all fields');
                return;
            }
            if (newPassword !== confirmPassword) {
                showAlert('Passwords do not match');
                return;
            }
            // Password policy: 1 special char, 1 uppercase, 1 number, min 8 chars
            const passwordPolicy = /^(?=.*[A-Z])(?=.*\d)(?=.*[!@#$%^&*()_+\-=[\]{};':"\\|,.<>/?]).{8,}$/;
            if (!passwordPolicy.test(newPassword)) {
                showAlert('Password must be at least 8 characters, include 1 uppercase letter, 1 number, and 1 special character.');
                return;
            }
            showLoading();
            hideAlert();
            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch(`${API_BASE_URL}/auth/change-password`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ newPassword })
                });
                const data = await response.json();
                if (response.ok) {
                    showAlert('Password changed successfully!', 'success');
                    // Remove mustChangePassword from userInfo
                    const userInfo = JSON.parse(localStorage.getItem('userInfo') || '{}');
                    userInfo.mustChangePassword = false;
                    localStorage.setItem('userInfo', JSON.stringify(userInfo));
                    setTimeout(() => {
                        if (userInfo.role === 'EMPLOYEE') {
                            window.location.href = '/frontend/employee-dashboard.html';
                        } else {
                            window.location.href = '/frontend/dashboard.html';
                        }
                    }, 1200);
                } else {
                    showAlert(data.message || 'Failed to change password');
                }
            } catch (error) {
                showAlert('Unable to connect to server. Please try again.');
            } finally {
                hideLoading();
            }
        });
        newPasswordInput.addEventListener('input', hideAlert);
        confirmPasswordInput.addEventListener('input', hideAlert);
        window.addEventListener('load', () => {
            newPasswordInput.focus();
        });
    </script>
</body>
</html>
