<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, in        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .calendar-controls {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .view-toggle {
            display: flex;
            background: #f8f9fa;
            border-radius: 6px;
            overflow: hidden;
        }

        .view-btn {
            padding: 8px 16px;
            border: none;
            background: transparent;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .view-btn.active {
            background: #667eea;
            color: white;
        }

        .view-btn:hover:not(.active) {
            background: #e9ecef;
        }scale=1.0">
    <title>My Shifts - Hotel Scheduler</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .header {
            background: white;
            padding: 15px 0;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            color: #2c3e50;
        }

        .nav-links {
            display: flex;
            gap: 20px;
        }

        .nav-link {
            color: #7f8c8d;
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 6px;
            transition: all 0.3s ease;
        }

        .nav-link:hover, .nav-link.active {
            background: #3498db;
            color: white;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .role-badge {
            background: #27ae60;
            color: white;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .logout-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: #c0392b;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .page-header {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }

        .page-header h1 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 2.5rem;
        }

        .page-header p {
            color: #7f8c8d;
            font-size: 1.1rem;
        }

        .calendar-container {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            margin-bottom: 30px;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .calendar-nav {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .nav-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.3s ease;
        }

        .nav-btn:hover {
            background: #2980b9;
        }

        .current-month {
            font-size: 1.5rem;
            font-weight: 600;
            color: #2c3e50;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: #ddd;
            border-radius: 8px;
            overflow: hidden;
        }

        .calendar-day-header {
            background: #34495e;
            color: white;
            padding: 15px;
            text-align: center;
            font-weight: 600;
        }

        .calendar-day {
            background: white;
            padding: 15px;
            min-height: 100px;
            border: 1px solid #eee;
            position: relative;
        }

        .calendar-day.other-month {
            background: #f8f9fa;
            color: #bbb;
        }

        .calendar-day.today {
            background: #e3f2fd;
        }

        .day-number {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .shift-indicator {
            background: #3498db;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.7rem;
            margin-bottom: 2px;
            display: block;
        }

        .shift-indicator.morning {
            background: #f39c12;
        }

        .shift-indicator.afternoon {
            background: #27ae60;
        }

        .shift-indicator.evening {
            background: #9b59b6;
        }

        .shift-indicator.night {
            background: #34495e;
        }

        /* Two-week view specific styles */
        .two-week-day {
            min-height: 120px;
            padding: 10px;
        }

        .two-week-day .day-number {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 2px;
        }

        .two-week-day .day-name {
            font-size: 0.8rem;
            color: #666;
            margin-bottom: 8px;
        }

        .shift-detail {
            background: #f8f9fa;
            border-radius: 4px;
            padding: 4px 6px;
            margin-bottom: 4px;
            font-size: 0.75rem;
        }

        .shift-detail.morning {
            background: #fff3cd;
            border-left: 3px solid #ffc107;
        }

        .shift-detail.afternoon {
            background: #d1ecf1;
            border-left: 3px solid #17a2b8;
        }

        .shift-detail.evening {
            background: #f8d7da;
            border-left: 3px solid #dc3545;
        }

        .shift-detail .shift-time {
            font-weight: bold;
            color: #333;
        }

        .shift-detail .shift-dept {
            color: #666;
            font-size: 0.7rem;
        }

        .shifts-list {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }

        .shifts-list h2 {
            color: #2c3e50;
            margin-bottom: 20px;
        }

        .shift-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border: 1px solid #eee;
            border-radius: 8px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }

        .shift-item:hover {
            background: #f8f9fa;
            border-color: #3498db;
        }

        .shift-details {
            flex: 1;
        }

        .shift-date {
            font-weight: 600;
            color: #2c3e50;
            font-size: 1.1rem;
            margin-bottom: 5px;
        }

        .shift-time {
            color: #7f8c8d;
            margin-bottom: 5px;
        }

        .shift-department {
            color: #3498db;
            font-size: 0.9rem;
        }

        .shift-actions {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .btn-primary {
            background: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background: #2980b9;
        }

        .btn-warning {
            background: #f39c12;
            color: white;
        }

        .btn-warning:hover {
            background: #e67e22;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 0.9rem;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .status-confirmed {
            background: #d4edda;
            color: #155724;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-cancelled {
            background: #f8d7da;
            color: #721c24;
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 15px;
            }

            .nav-links {
                flex-wrap: wrap;
                justify-content: center;
            }

            .calendar-grid {
                font-size: 0.9rem;
            }

            .calendar-day {
                min-height: 80px;
                padding: 10px;
            }

            .shift-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }

            .shift-actions {
                width: 100%;
                justify-content: flex-end;
            }
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgb(0,0,0);
            background-color: rgba(0,0,0,0.4);
            padding-top: 60px;
        }

        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 500px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }

        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <div class="logo">üè® Hotel Scheduler</div>
            <nav class="nav-links">
                <a href="employee-dashboard.html" class="nav-link">My Dashboard</a>
                <a href="employee-shifts.html" class="nav-link active">My Shifts</a>
                <a href="employee-trades.html" class="nav-link">Shift Trades</a>
                <a href="employee-notifications.html" class="nav-link">Notifications</a>
            </nav>
            <div class="user-info">
                <span class="role-badge">Employee</span>
                <span id="userName">Loading...</span>
                <button class="logout-btn" onclick="logout()">Logout</button>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="page-header">
            <h1>üìÖ My Shifts</h1>
            <p>View your schedule, manage your shifts, and request trades</p>
        </div>

        <div class="calendar-container">
        <div class="calendar-header">
            <h2>Schedule Calendar (2 Weeks)</h2>
            <div class="calendar-nav">
                <button class="nav-btn" onclick="previousPeriod()">‚Äπ</button>
                <span class="current-period" id="currentPeriod">Loading...</span>
                <button class="nav-btn" onclick="nextPeriod()">‚Ä∫</button>
            </div>
        </div>

            <div class="calendar-grid" id="calendarGrid">
                <!-- Calendar will be generated here -->
            </div>
        </div>

            <div class="shifts-list">
                <h2>üìã Upcoming Shifts</h2>
                <div id="shiftsList">
                    <!-- Real shift data will be rendered here -->
                </div>
            </div>
    </div>

    <script src="auto-logout.js"></script>
    <script src="auth-manager.js"></script>
    <script>
        const API_BASE_URL = 'http://localhost:8080/api';
        let currentUser = null;
        let currentDate = new Date();
        let currentWeekStart = null;

        document.addEventListener('DOMContentLoaded', async function() {
            const isAuthenticated = await authManager.checkAuth('EMPLOYEE');
            if (!isAuthenticated) return;

            loadUserInfo();
            // Always use 2-week view
            const today = new Date();
            currentWeekStart = new Date(today);
            currentWeekStart.setDate(today.getDate() - today.getDay()); // Start of current week
            await loadMyShifts();
        });

        async function checkAuth() {
            const token = localStorage.getItem('authToken');
            console.debug('[checkAuth] token:', token);
            if (!token) {
                console.debug('[checkAuth] No token, redirecting to login');
                window.location.href = 'login.html';
                return false;
            }
            try {
                const response = await fetch(`${API_BASE_URL}/auth/validate`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                console.debug('[checkAuth] validate response:', response.status);
                if (!response.ok) {
                    console.debug('[checkAuth] Token invalid, removing and redirecting');
                    localStorage.removeItem('authToken');
                    localStorage.removeItem('userInfo');
                    window.location.href = 'login.html';
                    return false;
                }
                return true;
            } catch (error) {
                console.error('[checkAuth] Auth validation failed:', error);
                localStorage.removeItem('authToken');
                localStorage.removeItem('userInfo');
                window.location.href = 'login.html';
                return false;
            }
        }

        function loadUserInfo() {
            const userInfo = localStorage.getItem('userInfo');
            if (userInfo) {
                currentUser = JSON.parse(userInfo);
                document.getElementById('userName').textContent = `${currentUser.firstName} ${currentUser.lastName}`;
            }
        }

        async function loadMyShifts() {
            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch(`${API_BASE_URL}/shifts/my-shifts`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const shifts = await response.json();
                    renderTwoWeekCalendar(shifts);
                    renderShiftsList(shifts);
                }
            } catch (error) {
                console.error('Error loading shifts:', error);
            }
        }

        function renderTwoWeekCalendar(shifts) {
            const calendarGrid = document.getElementById('calendarGrid');
            const currentPeriod = document.getElementById('currentPeriod');
            calendarGrid.innerHTML = '';

            // Calculate the two-week period
            const startDate = new Date(currentWeekStart);
            const endDate = new Date(startDate);
            endDate.setDate(startDate.getDate() + 13); // 14 days total

            // Update period display
            const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun",
                "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
            const startStr = `${monthNames[startDate.getMonth()]} ${startDate.getDate()}`;
            const endStr = `${monthNames[endDate.getMonth()]} ${endDate.getDate()}, ${endDate.getFullYear()}`;
            currentPeriod.textContent = `${startStr} - ${endStr}`;

            // Add day headers
            const dayHeaders = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            dayHeaders.forEach(day => {
                const dayHeader = document.createElement('div');
                dayHeader.className = 'calendar-day-header';
                dayHeader.textContent = day;
                calendarGrid.appendChild(dayHeader);
            });

            // Generate 14 days in 2 weeks
            for (let i = 0; i < 14; i++) {
                const dayDate = new Date(startDate);
                dayDate.setDate(startDate.getDate() + i);

                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day two-week-day';

                if (dayDate.toDateString() === new Date().toDateString()) {
                    dayElement.classList.add('today');
                }

                // Find shifts for this day
                const dayShifts = shifts.filter(shift => {
                    const shiftDate = new Date(shift.startTime);
                    return shiftDate.toDateString() === dayDate.toDateString();
                });

                dayElement.innerHTML = `
                    <div class="day-number">${dayDate.getDate()}</div>
                    <div class="day-name">${dayDate.toLocaleDateString('en-US', { weekday: 'short' })}</div>
                    ${dayShifts.map(shift => `
                        <div class="shift-detail ${getShiftType(shift)}">
                            <div class="shift-time">${formatTime(shift.startTime)} - ${formatTime(shift.endTime)}</div>
                            <div class="shift-dept">${shift.departmentName || ''}</div>
                        </div>
                    `).join('')}
                `;

                calendarGrid.appendChild(dayElement);
            }
        }

        function renderShiftsList(shifts) {
            const list = document.getElementById('shiftsList');
            list.innerHTML = '';
            if (!shifts || shifts.length === 0) {
                list.innerHTML = '<div style="text-align:center;color:#888;">No upcoming shifts found.</div>';
                return;
            }
            // Only show actionable shifts/trades:
            // - If tradeStatus exists, only show if tradeStatus is PENDING or POSTED
            // - Hide if tradeStatus is PENDING_APPROVAL, APPROVED, REJECTED, CANCELLED
            const visibleShifts = shifts.filter(shift => {
                if (shift.tradeStatus) {
                    // Only show if tradeStatus is PENDING or POSTED
                    // Hide PENDING_APPROVAL, APPROVED, REJECTED, CANCELLED
                    return ["PENDING", "POSTED"].includes(shift.tradeStatus);
                }
                return true;
            });
            visibleShifts.forEach(shift => {
                const item = document.createElement('div');
                item.className = 'shift-item';
                let actions = `<span class="status-badge ${getStatusClass(shift.status)}">${shift.status}</span>`;
                // Show Trade/Post button for scheduled or available shifts and not part of a trade
                if ((shift.status === 'SCHEDULED' || shift.status === 'AVAILABLE_FOR_PICKUP') && (!shift.tradeStatus || shift.tradeStatus === 'POSTED')) {
                    actions += `<button class="btn btn-warning btn-small" onclick="openTradePostModal(${shift.id})">Trade / Post Shift</button>`;
                }
                // Show Cancel Post button for posted shifts by current user, not yet picked up/confirmed, and tradeStatus is POSTED
                if (shift.status === 'POSTED' && shift.postedBy === currentUser.id && (!shift.tradeStatus || shift.tradeStatus === 'POSTED')) {
                    actions += `<button class="btn btn-danger btn-small" onclick="cancelPost(${shift.id})">Cancel Post</button>`;
                }
                // Show Cancel Trade button for posted trades to everyone or specific employee, if current user is the posting employee and tradeStatus is PENDING
                if (shift.tradeStatus === 'PENDING' && shift.postedBy === currentUser.id) {
                    actions += `<button class="btn btn-danger btn-small" onclick="cancelTrade(${shift.tradeId})">Cancel Trade</button>`;
                }
                // Show Cancel Pickup button for picked up but not confirmed shifts
                if (shift.status === 'PICKED_UP' && shift.pickedUpBy === currentUser.id && (!shift.tradeStatus || shift.tradeStatus === 'PENDING')) {
                    actions += `<button class="btn btn-danger btn-small" onclick="cancelPickup(${shift.id})">Cancel Pickup</button>`;
                }
                // Show Pick Up button for available shifts not assigned to current user and not posted by current user, and tradeStatus is POSTED
                if (shift.status === 'AVAILABLE_FOR_PICKUP' && shift.employeeId !== currentUser.id && shift.postedBy !== currentUser.id && (!shift.tradeStatus || shift.tradeStatus === 'POSTED')) {
                    actions += `<button class="btn btn-success btn-small" onclick="pickupShift(${shift.id})">Pick Up</button>`;
                }
                item.innerHTML = `
                    <div class="shift-details">
                        <div class="shift-date">${formatDate(shift.startTime)}</div>
                        <div class="shift-time">${formatTime(shift.startTime)} - ${formatTime(shift.endTime)}</div>
                        <div class="shift-department">${shift.departmentName || ''}</div>
                    </div>
                    <div class="shift-actions">${actions}</div>
                `;
                list.appendChild(item);
            });
        }

        function cancelPost(shiftId) {
            if (!confirm('Are you sure you want to cancel your post for this shift?')) return;
            fetch(`${API_BASE_URL}/shifts/${shiftId}/cancel-post`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('authToken')}`,
                    'Content-Type': 'application/json'
                }
            })
            .then(res => {
                if (res.ok) {
                    alert('Your shift post has been cancelled.');
                    autoRefreshShifts();
                } else {
                    res.json().then(data => alert(data.message || 'Failed to cancel post.'));
                }
            })
            .catch(() => alert('Network error. Please try again.'));
        }

        function cancelPickup(shiftId) {
            if (!confirm('Are you sure you want to cancel your pickup for this shift?')) return;
            fetch(`${API_BASE_URL}/shifts/${shiftId}/cancel-pickup`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('authToken')}`,
                    'Content-Type': 'application/json'
                }
            })
            .then(res => {
                if (res.ok) {
                    alert('Your pickup has been cancelled.');
                    loadMyShifts();
                } else {
                    res.json().then(data => alert(data.message || 'Failed to cancel pickup.'));
                }
            })
            .catch(() => alert('Network error. Please try again.'));
        }

        function pickupShift(shiftId) {
            // Backend expects POST /api/shifts/{id}/pick-up
            if (!confirm('Are you sure you want to pick up this shift?')) return;
            const token = localStorage.getItem('authToken');
            if (!token) {
                window.location.href = 'login.html';
                return;
            }
            fetch(`${API_BASE_URL}/shifts/${shiftId}/pick-up`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            })
            .then(res => {
                if (res.ok) {
                    alert('Shift picked up successfully!');
                    autoRefreshShifts();
                } else if (res.status === 401) {
                    alert('Session expired or unauthorized. Please log in again.');
                    localStorage.removeItem('authToken');
                    localStorage.removeItem('userInfo');
                    window.location.href = 'login.html';
                } else {
                    res.json().then(data => {
                        alert(data.message || 'Failed to pick up shift.');
                    });
                }
            })
            .catch(() => {
                alert('Network error. Please try again.');
            });
        }

        function openTradePostModal(shiftId) {
            // Create modal if not exists
            let modal = document.getElementById('tradePostModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'tradePostModal';
                modal.className = 'modal';
                modal.innerHTML = `
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3 class="modal-title">Trade / Post Shift</h3>
                            <button class="close" onclick="closeTradePostModal()">&times;</button>
                        </div>
                        <div id="tradePostModalBody"></div>
                    </div>
                `;
                document.body.appendChild(modal);
            }
            showTradePostOptions(shiftId);
            modal.style.display = 'block';
        }

        function closeTradePostModal() {
            const modal = document.getElementById('tradePostModal');
            if (modal) modal.style.display = 'none';
        }

        function showTradePostOptions(shiftId) {
            const body = document.getElementById('tradePostModalBody');
            body.innerHTML = `
                <div style="margin-bottom:20px;">
                    <button class="btn btn-primary" onclick="postToEveryone(${shiftId})">Post to Everyone</button>
                    <button class="btn btn-secondary" onclick="showPickPerson(${shiftId})">Post to Specific Person</button>
                </div>
                <div id="pickPersonContainer"></div>
            `;
        }

        function showPickPerson(shiftId) {
            // Fetch eligible coworkers from backend
            fetchEmployees().then(employees => {
                const container = document.getElementById('pickPersonContainer');
                if (employees.length === 0) {
                    container.innerHTML = '<div>No eligible employees found.</div>';
                    return;
                }
                container.innerHTML = `
                    <label for="pickPersonSelect">Select Employee:</label>
                    <select id="pickPersonSelect">
                        <option value="">-- Select --</option>
                        ${employees.map(e => `<option value="${e.id}">${e.firstName} ${e.lastName} (${e.role})</option>`).join('')}
                    </select>
                    <button class="btn btn-success" onclick="submitPostToPerson(${shiftId})">Send Shift Offer</button>
                `;
            });
        }

        function fetchEmployees() {
            // Use new backend endpoint for eligible coworkers
            return fetch(`${API_BASE_URL}/employees/eligible-for-trade`, {
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('authToken')}`,
                    'Content-Type': 'application/json'
                }
            }).then(res => res.json());
        }

        function postToEveryone(shiftId) {
            fetch(`${API_BASE_URL}/shifts/${shiftId}/post-to-everyone`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('authToken')}`,
                    'Content-Type': 'application/json'
                }
            })
            .then(res => {
                if (res.ok) {
                    alert('Shift posted to everyone! You are still responsible for this shift until someone picks it up and it is confirmed. If no one picks up the shift in time, you are expected to show up for your scheduled shift.');
                    closeTradePostModal();
                    autoRefreshShifts();
                } else {
                    res.json().then(data => alert(data.message || 'Failed to post shift.'));
                }
            })
            .catch(() => alert('Network error. Please try again.'));
        }

        function submitPostToPerson(shiftId) {
            const select = document.getElementById('pickPersonSelect');
            const employeeId = select.value;
            if (!employeeId) {
                alert('Please select an employee.');
                return;
            }
            fetch(`${API_BASE_URL}/shifts/${shiftId}/trade`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('authToken')}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ targetEmployeeId: employeeId })
            })
            .then(async res => {
                if (res.ok) {
                    alert('Shift offer sent! The employee must accept before a manager can approve or deny the shift change. You are still responsible for this shift until it is accepted and confirmed. If the offer is not accepted in time, you are expected to show up for your scheduled shift.');
                    closeTradePostModal();
                    autoRefreshShifts();
                } else if (res.status === 401) {
                    // Unauthorized: token expired or invalid
                    alert('Session expired or unauthorized. Please log in again.');
                    localStorage.removeItem('authToken');
                    localStorage.removeItem('userInfo');
                    window.location.href = 'login.html';
                } else {
                    let data;
                    try {
                        data = await res.json();
                    } catch (e) {
                        data = null;
                    }
                    alert((data && data.message) ? data.message : 'Failed to send shift offer.');
                }
            })
            .catch(() => alert('Network error. Please try again.'));
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const tradePostModal = document.getElementById('tradePostModal');
            if (event.target === tradePostModal) {
                closeTradePostModal();
            }
        }

        function formatDate(dateStr) {
            const d = new Date(dateStr);
            return d.toLocaleDateString(undefined, { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        }
        function formatTime(dateStr) {
            const d = new Date(dateStr);
            return d.toLocaleTimeString(undefined, { hour: '2-digit', minute: '2-digit' });
        }
        function getStatusClass(status) {
            if (status === 'CONFIRMED') return 'status-confirmed';
            if (status === 'PENDING') return 'status-pending';
            if (status === 'CANCELLED') return 'status-cancelled';
            if (status === 'AVAILABLE_FOR_PICKUP') return 'status-pending'; // Use pending style for available
            return '';
        }
        function getShiftType(shift) {
            // Optionally infer shift type by time
            const hour = new Date(shift.startTime).getHours();
            if (hour < 12) return 'morning';
            if (hour < 17) return 'afternoon';
            if (hour < 22) return 'evening';
            return 'night';
        }

        function generateCalendar() {
            const calendarGrid = document.getElementById('calendarGrid');
            const currentPeriod = document.getElementById('currentPeriod');
            
            // Clear calendar
            calendarGrid.innerHTML = '';
            
            if (viewMode === 'month') {
                generateMonthView(calendarGrid, currentPeriod);
            } else {
                generateTwoWeekView(calendarGrid, currentPeriod);
            }
        }

        function generateMonthView(calendarGrid, currentPeriod) {
            // Update month display
            const monthNames = ["January", "February", "March", "April", "May", "June",
                "July", "August", "September", "October", "November", "December"];
            currentPeriod.textContent = `${monthNames[currentDate.getMonth()]} ${currentDate.getFullYear()}`;
            
            // Add day headers
            const dayHeaders = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            dayHeaders.forEach(day => {
                const dayHeader = document.createElement('div');
                dayHeader.className = 'calendar-day-header';
                dayHeader.textContent = day;
                calendarGrid.appendChild(dayHeader);
            });
            
            // Get first day of month and number of days
            const firstDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());
            
            // Generate 42 days (6 weeks)
            for (let i = 0; i < 42; i++) {
                const dayDate = new Date(startDate);
                dayDate.setDate(startDate.getDate() + i);
                
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';
                
                if (dayDate.getMonth() !== currentDate.getMonth()) {
                    dayElement.classList.add('other-month');
                }
                
                if (dayDate.toDateString() === new Date().toDateString()) {
                    dayElement.classList.add('today');
                }
                
                dayElement.innerHTML = `
                    <div class="day-number">${dayDate.getDate()}</div>
                    ${getShiftIndicators(dayDate)}
                `;
                
                calendarGrid.appendChild(dayElement);
            }
        }

        function generateTwoWeekView(calendarGrid, currentPeriod) {
            // Calculate the two-week period
            const startDate = new Date(currentWeekStart);
            const endDate = new Date(startDate);
            endDate.setDate(startDate.getDate() + 13); // 14 days total
            
            // Update period display
            const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun",
                "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
            const startStr = `${monthNames[startDate.getMonth()]} ${startDate.getDate()}`;
            const endStr = `${monthNames[endDate.getMonth()]} ${endDate.getDate()}, ${endDate.getFullYear()}`;
            currentPeriod.textContent = `${startStr} - ${endStr}`;
            
            // Add day headers
            const dayHeaders = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            dayHeaders.forEach(day => {
                const dayHeader = document.createElement('div');
                dayHeader.className = 'calendar-day-header';
                dayHeader.textContent = day;
                calendarGrid.appendChild(dayHeader);
            });
            
            // Generate 14 days in 2 weeks
            for (let i = 0; i < 14; i++) {
                const dayDate = new Date(startDate);
                dayDate.setDate(startDate.getDate() + i);
                
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day two-week-day';
                
                if (dayDate.toDateString() === new Date().toDateString()) {
                    dayElement.classList.add('today');
                }
                
                // Different layout for 2-week view with more detail
                const shifts = getDetailedShiftInfo(dayDate);
                dayElement.innerHTML = `
                    <div class="day-number">${dayDate.getDate()}</div>
                    <div class="day-name">${dayDate.toLocaleDateString('en-US', { weekday: 'short' })}</div>
                    ${shifts}
                `;
                
                calendarGrid.appendChild(dayElement);
            }
        }

        function getShiftIndicators(date) {
            // Mock shift data - in real implementation, this would come from API
            const shifts = {
                '2025-07-12': ['afternoon'],
                '2025-07-13': ['morning'],
                '2025-07-15': ['afternoon'],
                '2025-07-18': ['evening'],
                '2025-07-20': ['morning']
            };
            
            const dateString = date.toISOString().split('T')[0];
            const dayShifts = shifts[dateString] || [];
            
            return dayShifts.map(shift => 
                `<span class="shift-indicator ${shift}">${shift}</span>`
            ).join('');
        }

        function getDetailedShiftInfo(date) {
            // Mock detailed shift data for 2-week view
            const shifts = {
                '2025-07-12': [{ time: '2:00 PM - 10:00 PM', dept: 'Front Desk', type: 'afternoon' }],
                '2025-07-13': [{ time: '8:00 AM - 4:00 PM', dept: 'Front Desk', type: 'morning' }],
                '2025-07-15': [{ time: '2:00 PM - 10:00 PM', dept: 'Front Desk', type: 'afternoon' }],
                '2025-07-18': [{ time: '10:00 PM - 6:00 AM', dept: 'Security', type: 'evening' }],
                '2025-07-20': [{ time: '6:00 AM - 2:00 PM', dept: 'Housekeeping', type: 'morning' }]
            };
            
            const dateString = date.toISOString().split('T')[0];
            const dayShifts = shifts[dateString] || [];
            
            return dayShifts.map(shift => 
                `<div class="shift-detail ${shift.type}">
                    <div class="shift-time">${shift.time}</div>
                    <div class="shift-dept">${shift.dept}</div>
                </div>`
            ).join('');
        }

        // View mode functions
        function setView(mode) {
            viewMode = mode;
            
            // Update button states
            document.getElementById('monthViewBtn').classList.toggle('active', mode === 'month');
            document.getElementById('twoWeekViewBtn').classList.toggle('active', mode === 'twoWeek');
            
            // Initialize week start for 2-week view
            if (mode === 'twoWeek' && !currentWeekStart) {
                const today = new Date();
                currentWeekStart = new Date(today);
                currentWeekStart.setDate(today.getDate() - today.getDay()); // Start of current week
            }
            
            generateCalendar();
        }

        function previousPeriod() {
            if (viewMode === 'month') {
                currentDate.setMonth(currentDate.getMonth() - 1);
            } else {
                currentWeekStart.setDate(currentWeekStart.getDate() - 14);
            }
            generateCalendar();
        }

        function nextPeriod() {
            if (viewMode === 'month') {
                currentDate.setMonth(currentDate.getMonth() + 1);
            } else {
                currentWeekStart.setDate(currentWeekStart.getDate() + 14);
            }
            generateCalendar();
        }

        function previousMonth() {
            currentDate.setMonth(currentDate.getMonth() - 1);
            generateCalendar();
        }

        function nextMonth() {
            currentDate.setMonth(currentDate.getMonth() + 1);
            generateCalendar();
        }

        function requestTrade(shiftId) {
            if (confirm('Do you want to request a trade for this shift?')) {
                window.location.href = `shift-trades.html?trade=${shiftId}`;
            }
        }

        function cancelShift(shiftId) {
            if (confirm('Do you want to request time off for this shift?')) {
                alert('Time off request submitted. Your manager will review it.');
            }
        }

        function logout() {
            localStorage.removeItem('authToken');
            localStorage.removeItem('userInfo');
            window.location.href = 'login.html';
        }

        // Add auto-refresh for shifts after trade/post/cancel actions
        function autoRefreshShifts(delay = 2000) {
            setTimeout(() => {
                loadMyShifts();
            }, delay);
        }
    </script>
</body>
</html>
