<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, in        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .calendar-controls {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .view-toggle {
            display: flex;
            background: #f8f9fa;
            border-radius: 6px;
            overflow: hidden;
        }

        .view-btn {
            padding: 8px 16px;
            border: none;
            background: transparent;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .view-btn.active {
            background: #667eea;
            color: white;
        }

        .view-btn:hover:not(.active) {
            background: #e9ecef;
        }scale=1.0">
    <title>My Shifts - Shiftly Scheduler</title>
    <link rel="stylesheet" href="style.css">
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        document.body.classList.add('employee-shifts');
      });
    </script>
</head>
<body>
    <div id="headerContainer"></div>
    <script src="nav-manager.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", function() {
        fetch("header.html")
          .then(res => res.text())
          .then(html => {
            document.getElementById("headerContainer").innerHTML = html;
            renderNavLinks("employee-shifts.html");
            initEmployeeShiftsPage();
          });
      });
    </script>

    <div class="container">
        <div class="calendar-container">
        <div class="calendar-header">
            <h2>Schedule Calendar (2 Weeks)</h2>
            <div class="calendar-nav">
                <button class="nav-btn" onclick="previousPeriod()">â€¹</button>
                <span class="current-period" id="currentPeriod">Loading...</span>
                <button class="nav-btn" onclick="nextPeriod()">â€º</button>
            </div>
        </div>

            <div class="calendar-grid" id="calendarGrid">
                <!-- Calendar will be generated here -->
            </div>
        </div>

            <div class="shifts-list">
                <h2>ðŸ“‹ Upcoming Shifts</h2>
                <div id="shiftsList">
                    <!-- Real shift data will be rendered here -->
                </div>
            </div>
    </div>

    <script src="auto-logout.js"></script>
    <script src="auth-manager.js"></script>
    <script>
        const API_BASE_URL = window.location.origin + '/api';

        let currentUser = null;
        let currentDate = new Date();
        let currentWeekStart = null;

        async function initEmployeeShiftsPage() {
            const isAuthenticated = await checkAuth('EMPLOYEE');
            if (!isAuthenticated) return;

            loadUserInfo();
            // Always use 2-week view
            const today = new Date();
            currentWeekStart = new Date(today);
            currentWeekStart.setDate(today.getDate() - today.getDay()); // Start of current week
            await loadMyShifts();
        }

        async function checkAuth(role) {
            const token = localStorage.getItem('authToken');
            const userInfo = localStorage.getItem('userInfo');
            if (!token || !userInfo) {
                window.location.href = 'login.html';
                return false;
            }
            try {
                const response = await fetch(`${API_BASE_URL}/auth/validate`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                if (response.status === 401) {
                    // Try to refresh token if backend supports
                    const refreshResponse = await fetch(`${API_BASE_URL}/auth/refresh`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    });
                    if (refreshResponse.ok) {
                        const data = await refreshResponse.json();
                        if (data.token) {
                            localStorage.setItem('authToken', data.token);
                            if (data.userInfo) {
                                localStorage.setItem('userInfo', JSON.stringify(data.userInfo));
                            }
                            // Check role after refresh
                            const refreshedUser = data.userInfo || JSON.parse(localStorage.getItem('userInfo') || '{}');
                            if (refreshedUser.role !== role) {
                                window.location.href = 'login.html';
                                return false;
                            }
                            return true;
                        }
                    }
                    localStorage.removeItem('authToken');
                    localStorage.removeItem('userInfo');
                    window.location.href = 'login.html';
                    return false;
                }
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                if (data.token) {
                    localStorage.setItem('authToken', data.token);
                }
                if (data.userInfo) {
                    localStorage.setItem('userInfo', JSON.stringify(data.userInfo));
                }
                // Check role
                const validatedUser = data.userInfo || JSON.parse(localStorage.getItem('userInfo') || '{}');
                if (validatedUser.role !== role) {
                    window.location.href = 'login.html';
                    return false;
                }
                return true;
            } catch (error) {
                console.error('Auth validation failed:', error);
                localStorage.removeItem('authToken');
                localStorage.removeItem('userInfo');
                window.location.href = 'login.html';
                return false;
            }
        }

        async function checkAuth() {
            const token = localStorage.getItem('authToken');
            console.debug('[checkAuth] token:', token);
            if (!token) {
                console.debug('[checkAuth] No token, redirecting to login');
                window.location.href = 'login.html';
                return false;
            }
            try {
                const response = await fetch(`${API_BASE_URL}/auth/validate`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                console.debug('[checkAuth] validate response:', response.status);
                if (!response.ok) {
                    console.debug('[checkAuth] Token invalid, removing and redirecting');
                    localStorage.removeItem('authToken');
                    localStorage.removeItem('userInfo');
                    window.location.href = 'login.html';
                    return false;
                }
                return true;
            } catch (error) {
                console.error('[checkAuth] Auth validation failed:', error);
                localStorage.removeItem('authToken');
                localStorage.removeItem('userInfo');
                window.location.href = 'login.html';
                return false;
            }
        }

        function loadUserInfo() {
            const userInfo = localStorage.getItem('userInfo');
            if (userInfo) {
                currentUser = JSON.parse(userInfo);
                document.getElementById('userName').textContent = `${currentUser.firstName} ${currentUser.lastName}`;
            }
        }

        async function loadMyShifts() {
            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch(`${API_BASE_URL}/shifts/my-shifts`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const shifts = await response.json();
                    renderTwoWeekCalendar(shifts);
                    renderShiftsList(shifts);
                }
            } catch (error) {
                console.error('Error loading shifts:', error);
            }
        }

        function renderTwoWeekCalendar(shifts) {
            const calendarGrid = document.getElementById('calendarGrid');
            const currentPeriod = document.getElementById('currentPeriod');
            calendarGrid.innerHTML = '';

            // Calculate the two-week period
            const startDate = new Date(currentWeekStart);
            const endDate = new Date(startDate);
            endDate.setDate(startDate.getDate() + 13); // 14 days total

            // Update period display
            const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun",
                "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
            const startStr = `${monthNames[startDate.getMonth()]} ${startDate.getDate()}`;
            const endStr = `${monthNames[endDate.getMonth()]} ${endDate.getDate()}, ${endDate.getFullYear()}`;
            currentPeriod.textContent = `${startStr} - ${endStr}`;

            // Add day headers
            const dayHeaders = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            dayHeaders.forEach(day => {
                const dayHeader = document.createElement('div');
                dayHeader.className = 'calendar-day-header';
                dayHeader.textContent = day;
                calendarGrid.appendChild(dayHeader);
            });

            // Generate 14 days in 2 weeks
            for (let i = 0; i < 14; i++) {
                const dayDate = new Date(startDate);
                dayDate.setDate(startDate.getDate() + i);

                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day two-week-day';

                if (dayDate.toDateString() === new Date().toDateString()) {
                    dayElement.classList.add('today');
                }

                // Find shifts for this day
                const dayShifts = shifts.filter(shift => {
                    const shiftDate = new Date(shift.startTime);
                    return shiftDate.toDateString() === dayDate.toDateString();
                });

                dayElement.innerHTML = `
                    <div class="day-number">${dayDate.getDate()}</div>
                    <div class="day-name">${dayDate.toLocaleDateString('en-US', { weekday: 'short' })}</div>
                    ${dayShifts.map(shift => `
                        <div class="shift-detail ${getShiftType(shift)}">
                            <div class="shift-time">${formatTime(shift.startTime)} - ${formatTime(shift.endTime)}</div>
                            <div class="shift-dept">${shift.departmentName || ''}</div>
                        </div>
                    `).join('')}
                `;

                calendarGrid.appendChild(dayElement);
            }
        }

        function renderShiftsList(shifts) {
            const list = document.getElementById('shiftsList');
            list.innerHTML = '';
            if (!shifts || shifts.length === 0) {
                list.innerHTML = '<div style="text-align:center;color:#888;">No upcoming shifts found.</div>';
                return;
            }
            // Show actionable shifts/trades and also show PENDING_APPROVAL for sender
            const visibleShifts = shifts.filter(shift => {
                if (shift.tradeStatus) {
                    if (["PENDING", "POSTED"].includes(shift.tradeStatus)) return true;
                    if (shift.tradeStatus === "PENDING_APPROVAL" && shift.postedBy === currentUser.id) return true;
                    return false;
                }
                return true;
            });
            visibleShifts.forEach(shift => {
                const item = document.createElement('div');
                let isCompleted = shift.status === 'COMPLETED' || new Date(shift.endTime) < new Date();
                item.className = 'shift-item' + (isCompleted ? ' shift-completed' : '');
                let badgeText = shift.status;
                let badgeClass = getStatusClass(shift.status);
                if (shift.tradeStatus === "PENDING_APPROVAL") {
                    badgeText = "Pending Approval by Manager";
                    badgeClass = "status-pending-approval";
                }
                let actions = `<span class="status-badge ${badgeClass}">${badgeText}</span>`;
                if (!isCompleted) {
                    if (shift.status === 'SCHEDULED' && (!shift.tradeStatus || shift.tradeStatus === 'POSTED')) {
                        actions += `<button class="btn btn-warning btn-small" onclick="openTradePostModal(${shift.id})">Trade / Post Shift</button>`;
                    }
                    if (shift.status === 'POSTED' && shift.postedBy === currentUser.id && (!shift.tradeStatus || shift.tradeStatus === 'POSTED')) {
                        actions += `<button class="btn btn-danger btn-small" onclick="cancelPost(${shift.id})">Cancel Post</button>`;
                    }
                    if (shift.tradeStatus === 'PENDING' && shift.postedBy === currentUser.id) {
                        actions += `<button class="btn btn-danger btn-small" onclick="cancelTrade(${shift.tradeId})">Cancel Trade</button>`;
                    }
                    if (shift.status === 'PICKED_UP' && shift.pickedUpBy === currentUser.id && (!shift.tradeStatus || shift.tradeStatus === 'PENDING')) {
                        actions += `<button class="btn btn-danger btn-small" onclick="cancelPickup(${shift.id})">Cancel Pickup</button>`;
                    }
                    if (shift.status === 'AVAILABLE_FOR_PICKUP' && shift.employeeId !== currentUser.id && shift.postedBy !== currentUser.id && (!shift.tradeStatus || shift.tradeStatus === 'POSTED')) {
                        actions += `<button class="btn btn-success btn-small" onclick="pickupShift(${shift.id})">Pick Up</button>`;
                    }
                    if (shift.status === 'AVAILABLE_FOR_PICKUP') {
                        actions += `<button class="btn btn-danger btn-small" onclick="cancelPickup(${shift.id})">Cancel Pickup</button>`;
                    }
                }
                item.innerHTML = `
                    <div class="shift-details">
                        <div class="shift-date">${formatDate(shift.startTime)}</div>
                        <div class="shift-time">${formatTime(shift.startTime)} - ${formatTime(shift.endTime)}</div>
                        <div class="shift-department">${shift.departmentName || ''}</div>
                    </div>
                    <div class="shift-actions">${actions}</div>
                `;
                if (isCompleted) {
                    item.style.background = '#eee';
                    item.style.color = '#888';
                }
                list.appendChild(item);
            });
        }

        function cancelPost(shiftId) {
            if (!confirm('Are you sure you want to cancel your post for this shift?')) return;
            fetch(`${API_BASE_URL}/shifts/${shiftId}/cancel-post`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('authToken')}`,
                    'Content-Type': 'application/json'
                }
            })
            .then(res => {
                if (res.ok) {
                    alert('Your shift post has been cancelled.');
                    autoRefreshShifts();
                } else {
                    res.json().then(data => alert(data.message || 'Failed to cancel post.'));
                }
            })
            .catch(() => alert('Network error. Please try again.'));
        }

        function cancelPickup(shiftId) {
            if (!confirm('Are you sure you want to cancel your pickup for this shift?')) return;
            fetch(`${API_BASE_URL}/shifts/${shiftId}/cancel-pickup`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('authToken')}`,
                    'Content-Type': 'application/json'
                }
            })
            .then(res => {
        if (res.ok) {
            alert('Your pickup has been cancelled.');
            // Optimistically update shift status in the UI to SCHEDULED
            updateShiftStatusLocally(shiftId, 'SCHEDULED');
            autoRefreshShifts();
        } else {
            res.json().then(data => alert(data.message || 'Failed to cancel pickup.'));
        }
    })
    .catch(() => alert('Network error. Please try again.'));
        }

        function pickupShift(shiftId) {
            // Backend expects POST /api/shifts/{id}/pick-up
            if (!confirm('Are you sure you want to pick up this shift?')) return;
            const token = localStorage.getItem('authToken');
            if (!token) {
                window.location.href = 'login.html';
                return;
            }
            fetch(`${API_BASE_URL}/shifts/${shiftId}/pick-up`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            })
            .then(res => {
                if (res.ok) {
                    alert('Shift picked up successfully!');
                    autoRefreshShifts();
                } else if (res.status === 401) {
                    alert('Session expired or unauthorized. Please log in again.');
                    localStorage.removeItem('authToken');
                    localStorage.removeItem('userInfo');
                    window.location.href = 'login.html';
                } else {
                    res.json().then(data => {
                        alert(data.message || 'Failed to pick up shift.');
                    });
                }
            })
            .catch(() => {
                alert('Network error. Please try again.');
            });
        }

        function openTradePostModal(shiftId) {
            // Create modal if not exists
            let modal = document.getElementById('tradePostModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'tradePostModal';
                modal.className = 'modal';
                modal.innerHTML = `
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3 class="modal-title">Trade / Post Shift</h3>
                            <button class="close" onclick="closeTradePostModal()">&times;</button>
                        </div>
                        <div id="tradePostModalBody"></div>
                    </div>
                `;
                document.body.appendChild(modal);
            }
            showTradePostOptions(shiftId);
            modal.style.display = 'block';
        }

        function closeTradePostModal() {
            const modal = document.getElementById('tradePostModal');
            if (modal) modal.style.display = 'none';
        }

        function showTradePostOptions(shiftId) {
            const body = document.getElementById('tradePostModalBody');
            body.innerHTML = `
                <div style="margin-bottom:20px;">
                    <button class="btn btn-primary" onclick="postToEveryone(${shiftId})">Post to Everyone</button>
                    <button class="btn btn-secondary" onclick="showPickPerson(${shiftId})">Post to Specific Person</button>
                </div>
                <div id="pickPersonContainer"></div>
            `;
        }

        function showPickPerson(shiftId) {
            // Fetch eligible coworkers from backend
            fetchEmployees().then(employees => {
                // Only show regular employees (exclude ADMIN, MANAGER, SUPER_ADMIN) and exclude current user
                const eligible = employees.filter(e => e.role === 'EMPLOYEE' && e.id !== currentUser.id);
                const container = document.getElementById('pickPersonContainer');
                if (eligible.length === 0) {
                    container.innerHTML = '<div>No eligible employees found.</div>';
                    return;
                }
                container.innerHTML = `
                    <label for="pickPersonSelect">Select Employee:</label>
                    <select id="pickPersonSelect">
                        <option value="">-- Select --</option>
                        ${eligible.map(e => `<option value="${e.id}">${e.firstName} ${e.lastName} (${e.role})</option>`).join('')}
                    </select>
                    <button class="btn btn-success" onclick="submitPostToPerson(${shiftId})">Send Shift Offer</button>
                `;
            });
        }

        function fetchEmployees() {
            // Use new backend endpoint for eligible coworkers
            return fetch(`${API_BASE_URL}/employees/eligible-for-trade`, {
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('authToken')}`,
                    'Content-Type': 'application/json'
                }
            }).then(res => res.json());
        }

        function postToEveryone(shiftId) {
            fetch(`${API_BASE_URL}/shifts/${shiftId}/post-to-everyone`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('authToken')}`,
                    'Content-Type': 'application/json'
                }
            })
            .then(res => {
                if (res.ok) {
                    // Optimistically update UI: set status to PENDING for this shift
                    updateShiftStatusLocally(shiftId, 'PENDING');
                    alert('Shift posted to everyone! You are still responsible for this shift until someone picks it up and it is confirmed. If no one picks up the shift in time, you are expected to show up for your scheduled shift.');
                    closeTradePostModal();
                    autoRefreshShifts();
                } else {
                    res.json().then(data => alert(data.message || 'Failed to post shift.'));
                }
            })
            .catch(() => alert('Network error. Please try again.'));
        }

        // Helper to optimistically update shift status in the UI
        function updateShiftStatusLocally(shiftId, newTradeStatus) {
            const list = document.getElementById('shiftsList');
            if (!list) return;
            const items = list.getElementsByClassName('shift-item');
            for (let item of items) {
                // Find the shift by matching the shiftId in the details
                const details = item.querySelector('.shift-details .shift-date');
                if (details && item.innerHTML.includes(`openTradePostModal(${shiftId})`)) {
                    // Find the badge and update its text and class
                    const badge = item.querySelector('.status-badge');
                    if (badge) {
                        badge.textContent = 'Pending';
                        badge.className = 'status-badge status-pending';
                    }
                }
            }
        }

        function submitPostToPerson(shiftId) {
            const select = document.getElementById('pickPersonSelect');
            const employeeId = select.value;
            if (!employeeId) {
                alert('Please select an employee.');
                return;
            }
            fetch(`${API_BASE_URL}/shifts/${shiftId}/trade`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('authToken')}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ targetEmployeeId: employeeId })
            })
            .then(async res => {
                if (res.ok) {
                    alert('Shift offer sent! The employee must accept before a manager can approve or deny the shift change. You are still responsible for this shift until it is accepted and confirmed. If the offer is not accepted in time, you are expected to show up for your scheduled shift.');
                    closeTradePostModal();
                    autoRefreshShifts();
                } else if (res.status === 401) {
                    // Unauthorized: token expired or invalid
                    alert('Session expired or unauthorized. Please log in again.');
                    localStorage.removeItem('authToken');
                    localStorage.removeItem('userInfo');
                    window.location.href = 'login.html';
                } else {
                    let data;
                    try {
                        data = await res.json();
                    } catch (e) {
                        data = null;
                    }
                    alert((data && data.message) ? data.message : 'Failed to send shift offer.');
                }
            })
            .catch(() => alert('Network error. Please try again.'));
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const tradePostModal = document.getElementById('tradePostModal');
            if (event.target === tradePostModal) {
                closeTradePostModal();
            }
        }

        function formatDate(dateStr) {
            const d = new Date(dateStr);
            return d.toLocaleDateString(undefined, { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        }
        function formatTime(dateStr) {
            const d = new Date(dateStr);
            return d.toLocaleTimeString(undefined, { hour: '2-digit', minute: '2-digit' });
        }
        function getStatusClass(status) {
            if (status === 'CONFIRMED') return 'status-confirmed';
            if (status === 'PENDING') return 'status-pending';
            if (status === 'CANCELLED') return 'status-cancelled';
            if (status === 'AVAILABLE_FOR_PICKUP') return 'status-pending'; // Use pending style for available
            return '';
        }
        function getShiftType(shift) {
            // Optionally infer shift type by time
            const hour = new Date(shift.startTime).getHours();
            if (hour < 12) return 'morning';
            if (hour < 17) return 'afternoon';
            if (hour < 22) return 'evening';
            return 'night';
        }

        function generateCalendar() {
            const calendarGrid = document.getElementById('calendarGrid');
            const currentPeriod = document.getElementById('currentPeriod');
            
            // Clear calendar
            calendarGrid.innerHTML = '';
            
            if (viewMode === 'month') {
                generateMonthView(calendarGrid, currentPeriod);
            } else {
                generateTwoWeekView(calendarGrid, currentPeriod);
            }
        }

        function generateMonthView(calendarGrid, currentPeriod) {
            // Update month display
            const monthNames = ["January", "February", "March", "April", "May", "June",
                "July", "August", "September", "October", "November", "December"];
            currentPeriod.textContent = `${monthNames[currentDate.getMonth()]} ${currentDate.getFullYear()}`;
            
            // Add day headers
            const dayHeaders = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            dayHeaders.forEach(day => {
                const dayHeader = document.createElement('div');
                dayHeader.className = 'calendar-day-header';
                dayHeader.textContent = day;
                calendarGrid.appendChild(dayHeader);
            });
            
            // Get first day of month and number of days
            const firstDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());
            
            // Generate 42 days (6 weeks)
            for (let i = 0; i < 42; i++) {
                const dayDate = new Date(startDate);
                dayDate.setDate(startDate.getDate() + i);
                
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';
                
                if (dayDate.getMonth() !== currentDate.getMonth()) {
                    dayElement.classList.add('other-month');
                }
                
                if (dayDate.toDateString() === new Date().toDateString()) {
                    dayElement.classList.add('today');
                }
                
                dayElement.innerHTML = `
                    <div class="day-number">${dayDate.getDate()}</div>
                    ${getShiftIndicators(dayDate)}
                `;
                
                calendarGrid.appendChild(dayElement);
            }
        }

        function generateTwoWeekView(calendarGrid, currentPeriod) {
            // Calculate the two-week period
            const startDate = new Date(currentWeekStart);
            const endDate = new Date(startDate);
            endDate.setDate(startDate.getDate() + 13); // 14 days total
            
            // Update period display
            const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun",
                "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
            const startStr = `${monthNames[startDate.getMonth()]} ${startDate.getDate()}`;
            const endStr = `${monthNames[endDate.getMonth()]} ${endDate.getDate()}, ${endDate.getFullYear()}`;
            currentPeriod.textContent = `${startStr} - ${endStr}`;
            
            // Add day headers
            const dayHeaders = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            dayHeaders.forEach(day => {
                const dayHeader = document.createElement('div');
                dayHeader.className = 'calendar-day-header';
                dayHeader.textContent = day;
                calendarGrid.appendChild(dayHeader);
            });
            
            // Generate 14 days in 2 weeks
            for (let i = 0; i < 14; i++) {
                const dayDate = new Date(startDate);
                dayDate.setDate(startDate.getDate() + i);
                
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day two-week-day';
                
                if (dayDate.toDateString() === new Date().toDateString()) {
                    dayElement.classList.add('today');
                }
                
                // Different layout for 2-week view with more detail
                const shifts = getDetailedShiftInfo(dayDate);
                dayElement.innerHTML = `
                    <div class="day-number">${dayDate.getDate()}</div>
                    <div class="day-name">${dayDate.toLocaleDateString('en-US', { weekday: 'short' })}</div>
                    ${shifts}
                `;
                
                calendarGrid.appendChild(dayElement);
            }
        }

        function getShiftIndicators(date) {
            // Mock shift data - in real implementation, this would come from API
            const shifts = {
                '2025-07-12': ['afternoon'],
                '2025-07-13': ['morning'],
                '2025-07-15': ['afternoon'],
                '2025-07-18': ['evening'],
                '2025-07-20': ['morning']
            };
            
            const dateString = date.toISOString().split('T')[0];
            const dayShifts = shifts[dateString] || [];
            
            return dayShifts.map(shift => 
                `<span class="shift-indicator ${shift}">${shift}</span>`
            ).join('');
        }

        function getDetailedShiftInfo(date) {
            // Mock detailed shift data for 2-week view
            const shifts = {
                '2025-07-12': [{ time: '2:00 PM - 10:00 PM', dept: 'Front Desk', type: 'afternoon' }],
                '2025-07-13': [{ time: '8:00 AM - 4:00 PM', dept: 'Front Desk', type: 'morning' }],
                '2025-07-15': [{ time: '2:00 PM - 10:00 PM', dept: 'Front Desk', type: 'afternoon' }],
                '2025-07-18': [{ time: '10:00 PM - 6:00 AM', dept: 'Security', type: 'evening' }],
                '2025-07-20': [{ time: '6:00 AM - 2:00 PM', dept: 'Housekeeping', type: 'morning' }]
            };
            
            const dateString = date.toISOString().split('T')[0];
            const dayShifts = shifts[dateString] || [];
            
            return dayShifts.map(shift => 
                `<div class="shift-detail ${shift.type}">
                    <div class="shift-time">${shift.time}</div>
                    <div class="shift-dept">${shift.dept}</div>
                </div>`
            ).join('');
        }

        // View mode functions
        function setView(mode) {
            viewMode = mode;
            
            // Update button states
            document.getElementById('monthViewBtn').classList.toggle('active', mode === 'month');
            document.getElementById('twoWeekViewBtn').classList.toggle('active', mode === 'twoWeek');
            
            // Initialize week start for 2-week view
            if (mode === 'twoWeek' && !currentWeekStart) {
                const today = new Date();
                currentWeekStart = new Date(today);
                currentWeekStart.setDate(today.getDate() - today.getDay()); // Start of current week
            }
            
            generateCalendar();
        }

        function previousPeriod() {
            if (viewMode === 'month') {
                currentDate.setMonth(currentDate.getMonth() - 1);
            } else {
                currentWeekStart.setDate(currentWeekStart.getDate() - 14);
            }
            generateCalendar();
        }

        function nextPeriod() {
            if (viewMode === 'month') {
                currentDate.setMonth(currentDate.getMonth() + 1);
            } else {
                currentWeekStart.setDate(currentWeekStart.getDate() + 14);
            }
            generateCalendar();
        }

        function previousMonth() {
            currentDate.setMonth(currentDate.getMonth() - 1);
            generateCalendar();
        }

        function nextMonth() {
            currentDate.setMonth(currentDate.getMonth() + 1);
            generateCalendar();
        }

        function requestTrade(shiftId) {
            if (confirm('Do you want to request a trade for this shift?')) {
                window.location.href = `shift-trades.html?trade=${shiftId}`;
            }
        }

        function cancelShift(shiftId) {
            if (confirm('Do you want to request time off for this shift?')) {
                alert('Time off request submitted. Your manager will review it.');
            }
        }

        function logout() {
            localStorage.removeItem('authToken');
            localStorage.removeItem('userInfo');
            window.location.href = 'login.html';
        }

        // Add auto-refresh for shifts after trade/post/cancel actions
        function autoRefreshShifts(delay = 2000) {
            setTimeout(() => {
                loadMyShifts();
            }, delay);
        }
    </script>
    <style>
.shift-completed {
    background: #eee !important;
    color: #888 !important;
    pointer-events: none;
    opacity: 0.7;
}
    </style>
</body>
</html>
