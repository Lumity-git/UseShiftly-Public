<!DOCTYPE html>
<html lang="en">

<head>
    <style>
        .custom-tooltip {
            position: absolute;
            background: #222;
            color: #fff;
            padding: 7px 14px;
            border-radius: 7px;
            font-size: 14px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.13);
            z-index: 1003;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.18s;
            white-space: nowrap;
        }
    </style>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shift Management - Shiftly Scheduler</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .shift-row-completed {
            background: #eee !important;
            color: #888 !important;
            pointer-events: none;
            opacity: 0.7;
        }
    </style>
</head>

<body>
    <div id="headerContainer"></div>
    <script src="nav-manager.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", function() {
        fetch("header.html")
          .then(res => res.text())
          .then(html => {
            document.getElementById("headerContainer").innerHTML = html;
            if (typeof renderNavLinks === 'function') {
              renderNavLinks("shifts.html");
            }
            if (typeof initShiftsPage === 'function') {
              initShiftsPage();
            }
            if (typeof loadUserInfo === 'function') {
              loadUserInfo();
            }
          });
        initCustomTooltips();
      });
      function initCustomTooltips() {
        let tooltip;
        function showTooltip(e) {
          const text = e.target.getAttribute('data-tooltip');
          if (!text) return;
          if (!tooltip) {
            tooltip = document.createElement('div');
            tooltip.className = 'custom-tooltip';
            document.body.appendChild(tooltip);
          }
          tooltip.textContent = text;
          tooltip.style.opacity = '1';
          const rect = e.target.getBoundingClientRect();
          tooltip.style.left = (rect.left + window.scrollX + rect.width / 2 - tooltip.offsetWidth / 2) + 'px';
          tooltip.style.top = (rect.top + window.scrollY - tooltip.offsetHeight - 8) + 'px';
        }
        function hideTooltip() {
          if (tooltip) tooltip.style.opacity = '0';
        }
        document.querySelectorAll('[data-tooltip]').forEach(btn => {
          btn.addEventListener('mouseenter', showTooltip);
          btn.addEventListener('mouseleave', hideTooltip);
          btn.addEventListener('focus', showTooltip);
          btn.addEventListener('blur', hideTooltip);
        });
      }
    </script>

    <div class="container">

        <div class="filters">
            <div class="filter-row">
                <div class="filter-group">
                    <label for="startDate">Start Date</label>
                    <input type="date" id="startDate" name="startDate">
                </div>
                <div class="filter-group">
                    <label for="endDate">End Date</label>
                    <input type="date" id="endDate" name="endDate">
                </div>
                <div class="filter-group">
                    <label for="departmentFilter">Department</label>
                    <select id="departmentFilter" name="departmentFilter">
                        <option value="">All Departments</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="employeeFilter">Employee</label>
                    <select id="employeeFilter" name="employeeFilter">
                        <option value="">All Employees</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="statusFilter">Status</label>
                    <select id="statusFilter" name="statusFilter">
                        <option value="">All Statuses</option>
                        <option value="SCHEDULED">Scheduled</option>
                        <option value="COMPLETED">Completed</option>
                        <option value="CANCELLED">Cancelled</option>
                        <option value="AVAILABLE_FOR_PICKUP">Available</option>
                    </select>
                </div>
            </div>
            <div class="action-buttons">
                <button class="btn btn-primary" onclick="openCreateShiftModal()">
                    ‚ûï Create New Shift
                </button>
                <button class="btn btn-secondary" onclick="loadShifts()">
                    üîÑ Refresh
                </button>
                <button class="btn btn-success" onclick="exportShifts()">
                    üìä Export
                </button>
                <button class="btn btn-warning" onclick="openAutoScheduleModal()" disabled
                    style="opacity:0.6;cursor:not-allowed;" data-tooltip="Coming soon">
                    ü§ñ Auto Schedule
                </button>
            </div>
            <!-- Auto-Schedule Modal -->
            <div id="autoScheduleModal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 class="modal-title">Auto-Schedule Shifts</h3>
                        <button class="close" onclick="closeAutoScheduleModal()">&times;</button>
                    </div>
                    <form id="autoScheduleForm">
                        <div class="form-group">
                            <label for="autoScheduleDepartment">Department</label>
                            <select id="autoScheduleDepartment" name="departmentId" required></select>
                        </div>
                        <div class="form-group">
                            <label for="autoScheduleStart">Start Date</label>
                            <input type="date" id="autoScheduleStart" name="startDate" required>
                        </div>
                        <div class="form-group">
                            <label for="autoScheduleEnd">End Date</label>
                            <input type="date" id="autoScheduleEnd" name="endDate" required>
                        </div>
                        <div class="form-group">
                            <label for="autoScheduleShiftStartTime">Shift Start Time</label>
                            <input type="time" id="autoScheduleShiftStartTime" name="shiftStartTime" required>
                        </div>
                        <div class="form-group">
                            <label for="autoScheduleShiftEndTime">Shift End Time</label>
                            <input type="time" id="autoScheduleShiftEndTime" name="shiftEndTime" required>
                        </div>
                        <div class="action-buttons">
                            <button type="submit" class="btn btn-warning">ü§ñ Run Auto-Schedule</button>
                            <button type="button" class="btn btn-secondary"
                                onclick="closeAutoScheduleModal()">Cancel</button>
                        </div>
                    </form>
                    <div id="autoScheduleResult"></div>
                </div>
            </div>
            <script>
                // Auto-Schedule Modal logic
                function openAutoScheduleModal() {
                    const modal = document.getElementById('autoScheduleModal');
                    if (!modal) return;
                    // Populate department select
                    const deptSelect = document.getElementById('autoScheduleDepartment');
                    deptSelect.innerHTML = '';
                    departments.forEach(dept => {
                        const option = document.createElement('option');
                        option.value = dept.id;
                        option.textContent = dept.name;
                        deptSelect.appendChild(option);
                    });
                    // Set default dates
                    const start = document.getElementById('startDate').value;
                    const end = document.getElementById('endDate').value;
                    document.getElementById('autoScheduleStart').value = start;
                    document.getElementById('autoScheduleEnd').value = end;
                    document.getElementById('autoScheduleResult').innerHTML = '';
                    modal.style.display = 'block';
                    // Attach submit event robustly (remove previous, add new)
                    const form = document.getElementById('autoScheduleForm');
                    if (form) {
                        form.removeEventListener('submit', handleAutoScheduleSubmit);
                        form.addEventListener('submit', handleAutoScheduleSubmit);
                    }
                }

                function closeAutoScheduleModal() {
                    const modal = document.getElementById('autoScheduleModal');
                    if (modal) modal.style.display = 'none';
                }

                async function handleAutoScheduleSubmit(e) {
                    e.preventDefault();
                    
                    const deptId = document.getElementById('autoScheduleDepartment').value;
                    const startDate = document.getElementById('autoScheduleStart').value;
                    const endDate = document.getElementById('autoScheduleEnd').value;
                    let shiftStartTime = document.getElementById('autoScheduleShiftStartTime').value;
                    let shiftEndTime = document.getElementById('autoScheduleShiftEndTime').value;
                    if (!deptId || !startDate || !endDate || !shiftStartTime || !shiftEndTime) {
                        showAlert('Please fill out all fields for auto-scheduling.', 'error');
                        return;
                    }
                    // Validate time range
                    // If end time is "00:00", treat as midnight of next day
                    let startParts = shiftStartTime.split(':').map(Number);
                    let endParts = shiftEndTime.split(':').map(Number);
                    let startMinutes = startParts[0] * 60 + startParts[1];
                    let endMinutes = endParts[0] * 60 + endParts[1];
                    let validTime = true;
                    if (shiftEndTime === "00:00") {
                        // Treat as 24:00 (next day)
                        endMinutes = 24 * 60;
                    }
                    if (endMinutes <= startMinutes) {
                        validTime = false;
                    }
                    if (!validTime) {
                        showAlert('End time must be after start time. If you want a shift ending at midnight, use 23:59 or "00:00" (midnight next day).', 'error');
                        return;
                    }
                    try {
                        const resultDiv = document.getElementById('autoScheduleResult');
                        resultDiv.innerHTML = '<div class="loading"><div class="spinner"></div>Running auto-scheduling...</div>';
                        const token = localStorage.getItem('authToken');
                        const url = `${API_BASE_URL}/auto-scheduling`;
            
                        let sendEndTime = shiftEndTime;
                        if (shiftEndTime === "00:00") {
                            sendEndTime = "23:59";
                        }
                        const body = {
                            departmentId: parseInt(deptId),
                            startDate,
                            endDate,
                            shiftStartTime,
                            shiftEndTime: sendEndTime
                        };
                     
                        const response = await fetch(url, {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(body)
                        });
                
                        if (response.status === 401 || response.status === 403) {
                            logout();
                            return;
                        }
                        if (!response.ok) {
                            let errorText = '';
                            try {
                                errorText = await response.text();
                            } catch (e) { }
                            console.error('Auto-scheduling failed:', response.status, errorText);
                            resultDiv.innerHTML = `<div class="alert alert-error">Auto-scheduling failed (${response.status}). ${errorText ? errorText : 'Please try again.'}</div>`;
                            return;
                        }
                        const data = await response.json();
               
                        if (data.totalShiftsScheduled === 0) {
                            resultDiv.innerHTML = `<div class="alert alert-error">No shifts were scheduled. Please check your department, date range, and shift times. Try adjusting the start/end time or ensure employees are available.</div>`;
                        } else {
                            resultDiv.innerHTML = `<div class="alert alert-success">Auto-scheduling complete!<br>
                    Shifts scheduled: <b>${data.totalShiftsScheduled}</b><br>
                    Unassigned shifts: <b>${data.totalUnassigned}</b></div>`;
                        }
                        loadShifts();
                    } catch (error) {
                        console.error('Auto-scheduling JS error:', error);
                        document.getElementById('autoScheduleResult').innerHTML = `<div class="alert alert-error">Auto-scheduling failed. ${error && error.message ? error.message : ''}</div>`;
                    }
                }
            </script>
        </div>

        <div id="alertContainer"></div>

        <div id="shiftsContainer">
            <div class="loading">
                <div class="spinner"></div>
                <p>Loading shifts...</p>
            </div>
        </div>
    </div>

    <!-- Create/Edit Shift Modal -->
    <div id="shiftModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="shiftModalTitle">Create New Shift</h3>
                <button class="close" onclick="closeShiftModal()">&times;</button>
            </div>
            <form id="shiftForm">
                <div class="form-group">
                    <label for="shiftStartTime">Start Time</label>
                    <input type="datetime-local" id="shiftStartTime" name="startTime" required>
                </div>
                <div class="form-group">
                    <label for="shiftEndTime">End Time</label>
                    <input type="datetime-local" id="shiftEndTime" name="endTime" required>
                </div>
                <div class="form-group">
                    <label for="employeeSearch">Search Employee</label>
                    <input type="text" id="employeeSearch" placeholder="Type to search..."
                        style="margin-bottom:6px;width:100%;font-size:14px;">
                    <label for="shiftEmployee">Employee</label>
                    <select id="shiftEmployee" name="employeeId" required>
                        <option value="">Select Employee</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="shiftDepartment">Department</label>
                    <select id="shiftDepartment" name="departmentId" required>
                        <option value="">Select Department</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="shiftNotes">Notes</label>
                    <textarea id="shiftNotes" name="notes" placeholder="Optional notes about this shift"></textarea>
                </div>
                <div class="action-buttons">
                    <button type="submit" class="btn btn-primary">
                        üíæ Save Shift
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="closeShiftModal()">
                        ‚ùå Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Trade/Post Shift Modal -->
    <div id="tradePostModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="tradePostModalTitle">Trade Shift</h3>
                <button class="close" onclick="closeTradePostModal()">&times;</button>
            </div>
            <div id="tradePostModalBody">
                <!-- Content will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <script src="auto-logout.js"></script>
    <script src="auth-manager.js"></script>
    <script>
        const API_BASE_URL = window.location.origin + '/api';
        let currentUser = null;
        let shifts = [];
        let employees = [];
        let departments = [];
        let editingShiftId = null;
        let tradeOrPostShiftId = null;

        // Example employee availability data (replace with backend fetch if available)
        // Remove static example, use backend fetch

        // Initialize page after header loads
        async function initShiftsPage() {
            const isAuthenticated = await checkAuth(['MANAGER', 'ADMIN']);
            if (!isAuthenticated) return;

            loadUserInfo();
            setDefaultDates();
            await loadDepartments();
            await loadEmployees();
            await loadShifts();

            // Add event listeners
            document.getElementById('startDate').addEventListener('change', loadShifts);
            document.getElementById('endDate').addEventListener('change', loadShifts);
            document.getElementById('departmentFilter').addEventListener('change', loadShifts);
            document.getElementById('employeeFilter').addEventListener('change', loadShifts);
            document.getElementById('statusFilter').addEventListener('change', loadShifts);
            document.getElementById('shiftForm').addEventListener('submit', handleShiftSubmit);
            document.getElementById('shiftEmployee').addEventListener('change', showSelectedEmployeeAvailability);
        }

        // Authentication
        async function checkAuth(roles) {
            const token = localStorage.getItem('authToken');
            const userInfo = localStorage.getItem('userInfo');

            if (!token || !userInfo) {
                window.location.href = 'login.html';
                return false;
            }

            const user = JSON.parse(userInfo);

            // Redirect employees to their own shifts page
            if (user.role === 'EMPLOYEE') {
                window.location.href = 'employee-shifts.html';
                return false;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/auth/validate`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                if (response.status === 401) {
                    // Try to refresh token if backend supports
                    const refreshResponse = await fetch(`${API_BASE_URL}/auth/refresh`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    });
                    if (refreshResponse.ok) {
                        const data = await refreshResponse.json();
                        if (data.token) {
                            localStorage.setItem('authToken', data.token);
                            if (data.userInfo) {
                                localStorage.setItem('userInfo', JSON.stringify(data.userInfo));
                            }
                            // Check role after refresh
                            const refreshedUser = data.userInfo || JSON.parse(localStorage.getItem('userInfo') || '{}');
                            if (!roles.includes(refreshedUser.role)) {
                                window.location.href = 'login.html';
                                return false;
                            }
                            return true;
                        }
                    }
                    localStorage.removeItem('authToken');
                    localStorage.removeItem('userInfo');
                    window.location.href = 'login.html';
                    return false;
                }
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                if (data.token) {
                    localStorage.setItem('authToken', data.token);
                }
                if (data.userInfo) {
                    localStorage.setItem('userInfo', JSON.stringify(data.userInfo));
                }
                // Check role
                const validatedUser = data.userInfo || JSON.parse(localStorage.getItem('userInfo') || '{}');
                if (!roles.includes(validatedUser.role)) {
                    window.location.href = 'login.html';
                    return false;
                }
                return true;
            } catch (error) {
                console.error('Auth validation failed:', error);
                localStorage.removeItem('authToken');
                localStorage.removeItem('userInfo');
                window.location.href = 'login.html';
                return false;
            }
        }

        function loadUserInfo() {
            const userInfo = localStorage.getItem('userInfo');
            if (userInfo) {
                currentUser = JSON.parse(userInfo);
                document.getElementById('userName').textContent = `${currentUser.firstName} ${currentUser.lastName}`;
            }
        }

        // Navigation is now handled by header.html; remove old nav link code

        function logout() {
            localStorage.removeItem('authToken');
            localStorage.removeItem('userInfo');
            window.location.href = 'login.html';
        }

        // API Helpers
        async function apiRequest(endpoint, options = {}) {
            const token = localStorage.getItem('authToken');
            const url = `${API_BASE_URL}${endpoint}`;

            const config = {
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`,
                    ...options.headers
                },
                ...options
            };

            try {
                const response = await fetch(url, config);

                if (response.status === 401) {
                    logout();
                    return;
                }

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                return await response.json();
            } catch (error) {
                console.error('API Request failed:', error);
                showAlert('Network error. Please check your connection.', 'error');
                throw error;
            }
        }

        // Load data
        async function loadDepartments() {
            try {
                departments = await apiRequest('/departments');
                populateDepartmentSelects();
            } catch (error) {
                console.error('Failed to load departments:', error);
            }
        }

        async function loadEmployees(buildingId = null) {
            try {
                let endpoint = '/employees';
                if (currentUser?.role === 'MANAGER') {
                    endpoint = '/employees/my-building';
                } else if (currentUser?.role === 'ADMIN' && buildingId) {
                    endpoint = `/employees/by-building/${buildingId}`;
                }
                if (currentUser?.role === 'ADMIN' && !buildingId) {
                    employees = [];
                    populateEmployeeSelects(true); // true = disable
                    return;
                }
                employees = await apiRequest(endpoint);
                populateEmployeeSelects(false); // false = enable
            } catch (error) {
                console.error('Failed to load employees:', error);
            }
        }

        async function loadShifts() {
            try {
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;
                const departmentId = document.getElementById('departmentFilter').value;
                const employeeId = document.getElementById('employeeFilter').value;
                const status = document.getElementById('statusFilter').value;

                let endpoint = '/shifts?';
                const params = new URLSearchParams();
                if (startDate) params.append('startDate', startDate);
                if (endDate) params.append('endDate', endDate);
                if (departmentId) params.append('departmentId', departmentId);
                // Only filter by employeeId if one is selected
                if (employeeId && employeeId !== '') params.append('employeeId', employeeId);
                if (status) params.append('status', status);
                endpoint += params.toString();

                shifts = await apiRequest(endpoint);
                renderShifts();
            } catch (error) {
                console.error('Failed to load shifts:', error);
                document.getElementById('shiftsContainer').innerHTML =
                    '<div class="alert alert-error">Failed to load shifts. Please try again.</div>';
            }
        }

        // Populate selects
        function populateDepartmentSelects() {
            const selects = ['departmentFilter', 'shiftDepartment'];
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (selectId === 'departmentFilter') {
                    select.innerHTML = '<option value="">All Departments</option>';
                } else {
                    select.innerHTML = '<option value="">Select Department</option>';
                }

                departments.forEach(dept => {
                    const option = document.createElement('option');
                    option.value = dept.id;
                    option.textContent = dept.name;
                    select.appendChild(option);
                });
            });
        }

        function getShiftRowClass(shift) {
            // Mark completed shifts gray and disable actions
            let isCompleted = shift.status === 'COMPLETED' || new Date(shift.endTime) < new Date();
            return isCompleted ? 'shift-row-completed' : '';
        }

        // Add JS to filter employee select options
        function updateEmployeeOptionsCache() {
            const select = document.getElementById('shiftEmployee');
            if (select) {
                allEmployeeOptions = Array.from(select.options).map(opt => ({ value: opt.value, text: opt.textContent }));
            }
        }
        document.addEventListener('DOMContentLoaded', function () {
            // After employees are loaded, cache all options
            setTimeout(() => {
                updateEmployeeOptionsCache();
                const select = document.getElementById('shiftEmployee');
                if (select) {
                    select.addEventListener('change', function () {
                        showSelectedEmployeeAvailability();
                    });
                }
            }, 500);
            const searchInput = document.getElementById('employeeSearch');
            if (searchInput) {
                searchInput.addEventListener('input', function () {
                    const term = searchInput.value.toLowerCase();
                    const select = document.getElementById('shiftEmployee');
                    if (!select) return;
                    // If search is empty, restore all options
                    if (!term) {
                        select.innerHTML = '';
                        allEmployeeOptions.forEach(opt => {
                            const option = document.createElement('option');
                            option.value = opt.value;
                            option.textContent = opt.text;
                            select.appendChild(option);
                        });
                        closeAvailabilityMiniModal();
                        return;
                    }
                    let filtered = allEmployeeOptions.filter(opt => opt.text.toLowerCase().includes(term));
                    // If no match, restore all options
                    if (filtered.length === 0) {
                        select.innerHTML = '';
                        allEmployeeOptions.forEach(opt => {
                            const option = document.createElement('option');
                            option.value = opt.value;
                            option.textContent = opt.text;
                            select.appendChild(option);
                        });
                        closeAvailabilityMiniModal();
                        return;
                    }
                    select.innerHTML = '';
                    filtered.forEach(opt => {
                        const option = document.createElement('option');
                        option.value = opt.value;
                        option.textContent = opt.text;
                        select.appendChild(option);
                    });
                    // Auto-select if exact match
                    const exact = filtered.find(opt => opt.text.toLowerCase() === term);
                    if (exact) {
                        select.value = exact.value;
                        showSelectedEmployeeAvailability();
                    } else {
                        closeAvailabilityMiniModal();
                    }
                });
            }
        });
        // Update cache after employees are loaded
        function populateEmployeeSelects(disable = false) {
            const selects = ['employeeFilter', 'shiftEmployee'];
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (selectId === 'employeeFilter') {
                    select.innerHTML = '<option value="">All Employees</option>';
                } else {
                    select.innerHTML = '<option value="">Select Employee</option>';
                }
                if (employees.length > 0) {
                    employees.forEach(emp => {
                        const option = document.createElement('option');
                        option.value = emp.id;
                        option.textContent = `${emp.firstName} ${emp.lastName}`;
                        select.appendChild(option);
                    });
                    select.disabled = false;
                } else {
                    select.disabled = disable;
                }
            });
            updateEmployeeOptionsCache();
        }

        // Render shifts
        function renderShifts() {
            const container = document.getElementById('shiftsContainer');
            if (shifts.length === 0) {
                container.innerHTML = '<div class="alert alert-info">No shifts found for the selected criteria.</div>';
                return;
            }
            container.innerHTML = '<div class="shifts-grid"></div>';
            const grid = container.querySelector('.shifts-grid');
            const batchSize = 20;
            let i = 0;
            function renderBatch() {
                const end = Math.min(i + batchSize, shifts.length);
                for (; i < end; i++) {
                    const shift = shifts[i];
                    // Custom status badge for tradeStatus PENDING_APPROVAL
                    let statusText = formatStatus(shift.status);
                    let statusClass = `status-${shift.status ? shift.status.toLowerCase() : ''}`;
                    if (shift.tradeStatus === 'PENDING_APPROVAL' && shift.postedBy === currentUser?.id) {
                        statusText = 'Pending Approval by Manager';
                        statusClass = 'status-pending-approval';
                    }
                    const card = document.createElement('div');
                    card.className = 'shift-card';
                    card.innerHTML = `
                        <div class="shift-header">
                            <div class="shift-time">
                                ${formatDateTime(shift.startTime)} - ${formatTime(shift.endTime)}
                            </div>
                            <span class="shift-status ${statusClass}">
                                ${statusText}
                            </span>
                        </div>
                        <div class="shift-info">
                            <div class="shift-detail">
                                <strong>Employee:</strong>
                                <span>${shift.employeeName || 'Unassigned'}</span>
                            </div>
                            <div class="shift-detail">
                                <strong>Department:</strong>
                                <span>${shift.departmentName}</span>
                            </div>
                            <div class="shift-detail">
                                <strong>Duration:</strong>
                                <span>${calculateDuration(shift.startTime, shift.endTime)} hours</span>
                            </div>
                            ${shift.notes ? `
                            <div class="shift-detail">
                                <strong>Notes:</strong>
                                <span>${shift.notes}</span>
                            </div>
                            ` : ''}
                        </div>
                        <div class="shift-actions">
                            ${(typeof canManageShifts === 'function' && canManageShifts()) ? `
                                <button class="btn btn-primary btn-small" onclick="editShift(${shift.id})">
                                    ‚úèÔ∏è Edit
                                </button>
                                <button class="btn btn-danger btn-small" onclick="deleteShift(${shift.id})">
                                    üóëÔ∏è Delete
                                </button>
                            ` : ''}
                            ${(shift.status === 'SCHEDULED' && shift.employeeId === currentUser?.id) ? `
                                <button class="btn btn-warning btn-small" onclick="openTradeModal(${shift.id})">
                                    üîÅ Trade
                                </button>
                                <button class="btn btn-success btn-small" onclick="openPostShiftModal(${shift.id})">
                                    üì¢ Post Shift
                                </button>
                            ` : ''}
                            ${(shift.status === 'AVAILABLE_FOR_PICKUP' && shift.employeeId !== currentUser?.id) ? `
                                <button class="btn btn-success btn-small" onclick="pickupShift(${shift.id})">
                                    ‚úã Pick Up
                                </button>
                            ` : ''}
                        </div>
                    `;
                    grid.appendChild(card);
                }
                if (i < shifts.length) {
                    setTimeout(renderBatch, 0);
                }
            }
            renderBatch();
        }

        // Modal functions
        function openCreateShiftModal() {
            editingShiftId = null;
            document.getElementById('shiftModalTitle').textContent = 'Create New Shift';
            document.getElementById('shiftForm').reset();
            document.getElementById('shiftModal').style.display = 'block';
            // Remove previous warning if present
            let warning = document.getElementById('dateWarning');
            if (warning) warning.remove();
            // Attach submit event listener robustly
            const shiftForm = document.getElementById('shiftForm');
            if (shiftForm) {
                shiftForm.removeEventListener('submit', handleShiftSubmit);
                shiftForm.addEventListener('submit', handleShiftSubmit);
            }
            // Add listener to start date input for past date check
            setTimeout(() => {
                const startInput = document.getElementById('shiftStartTime');
                if (startInput) {
                    startInput.addEventListener('change', function () {
                        let selected = new Date(startInput.value);
                        let now = new Date();
                        let warning = document.getElementById('dateWarning');
                        if (warning) warning.remove();
                        if (selected < now) {
                            let warnDiv = document.createElement('div');
                            warnDiv.id = 'dateWarning';
                            warnDiv.style.color = 'red';
                            warnDiv.style.margin = '8px 0';
                            warnDiv.textContent = 'That day has passed. Please choose a day in the future.';
                            startInput.parentNode.insertBefore(warnDiv, startInput.nextSibling);
                        }
                    });
                }
            }, 10);
            // If admin, show building select and filter employees by building/department
            if (currentUser?.role === 'ADMIN') {
                let form = document.getElementById('shiftForm');
                let buildingGroup = document.getElementById('buildingGroup');
                if (!buildingGroup) {
                    buildingGroup = document.createElement('div');
                    buildingGroup.className = 'form-group';
                    buildingGroup.id = 'buildingGroup';
                    buildingGroup.innerHTML = `
                    <label for="shiftBuilding">Building</label>
                    <select id="shiftBuilding" name="buildingId" required>
                        <option value="">Select Building</option>
                    </select>
                `;
                    form.insertBefore(buildingGroup, form.firstChild);
                }
                // Fetch buildings for admin and populate select
                const buildingSelect = document.getElementById('shiftBuilding');
                buildingSelect.innerHTML = '<option value="">Select Building</option>';
                (async function () {
                    try {
                        const token = localStorage.getItem('authToken');
                        const response = await fetch(`${API_BASE_URL}/buildings/my-buildings`, {
                            method: 'GET',
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json'
                            }
                        });
                        if (response.ok) {
                            const buildings = await response.json();
                            if (Array.isArray(buildings)) {
                                const seenBuildingIds = new Set();
                                buildings.forEach(b => {
                                    if (!seenBuildingIds.has(b.id)) {
                                        const option = document.createElement('option');
                                        option.value = b.id;
                                        option.textContent = b.name;
                                        buildingSelect.appendChild(option);
                                        seenBuildingIds.add(b.id);
                                    }
                                });
                            }
                        }
                    } catch (err) {
                        // Optionally show error
                    }
                })();
                buildingSelect.style.display = '';
                // Add change listener to building and department selects to filter employees and departments
                buildingSelect.addEventListener('change', async function () {
                    populateDepartmentsForBuilding();
                    // Fetch employees for selected building and update dropdown
                    const selectedBuildingId = buildingSelect.value;
                    if (selectedBuildingId) {
                        await loadEmployees(selectedBuildingId);
                    } else {
                        employees = [];
                        populateEmployeeSelects();
                    }
                    filterEmployeeOptionsByBuildingDept();
                });
                const deptSelect = document.getElementById('shiftDepartment');
                deptSelect.addEventListener('change', function () {
                    filterEmployeeOptionsByBuildingDept();
                });
                // Initial filter for departments and employees
                setTimeout(async () => {
                    populateDepartmentsForBuilding();
                    const selectedBuildingId = document.getElementById('shiftBuilding')?.value;
                    if (selectedBuildingId) {
                        await loadEmployees(selectedBuildingId);
                    } else {
                        employees = [];
                        populateEmployeeSelects(true); // disable
                    }
                    filterEmployeeOptionsByBuildingDept();
                }, 10);
                // Helper to filter departments by selected building (for admin)
                function populateDepartmentsForBuilding() {
                    const deptSelect = document.getElementById('shiftDepartment');
                    if (!deptSelect) return;
                    deptSelect.innerHTML = '<option value="">Select Department</option>';
                    let buildingId = document.getElementById('shiftBuilding')?.value;
                    const seenDeptIds = new Set();
                    departments.forEach(dept => {
                        if (buildingId && String(dept.buildingId) !== String(buildingId)) return;
                        if (seenDeptIds.has(dept.id)) return;
                        const option = document.createElement('option');
                        option.value = dept.id;
                        option.textContent = dept.name;
                        deptSelect.appendChild(option);
                        seenDeptIds.add(dept.id);
                    });
                    // If no departments for building, keep only default option
                    if (deptSelect.options.length === 1) {
                        deptSelect.selectedIndex = 0;
                    }
                }
            } else if (currentUser?.role === 'MANAGER') {
                let buildingGroup = document.getElementById('buildingGroup');
                if (buildingGroup) {
                    buildingGroup.style.display = 'none';
                }
                const deptSelect = document.getElementById('shiftDepartment');
                deptSelect.innerHTML = '<option value="">Select Department</option>';
                const seenDeptIds = new Set();
                departments.forEach(dept => {
                    if (String(dept.buildingId) === String(currentUser.buildingId) && !seenDeptIds.has(dept.id)) {
                        const option = document.createElement('option');
                        option.value = dept.id;
                        option.textContent = dept.name;
                        deptSelect.appendChild(option);
                        seenDeptIds.add(dept.id);
                    }
                });
                deptSelect.addEventListener('change', function () {
                    filterEmployeeOptionsByBuildingDept(currentUser.buildingId);
                });
                setTimeout(() => {
                    filterEmployeeOptionsByBuildingDept(currentUser.buildingId);
                }, 10);
            }
            // If an employee is selected, show their availability
            setTimeout(() => {
                const select = document.getElementById('shiftEmployee');
                if (select && select.value) {
                    showSelectedEmployeeAvailability();
                }
            }, 10);
        }

        function filterEmployeeOptionsByBuildingDept() {
            // Accept buildingId as argument for manager filtering
            let buildingId = arguments.length > 0 ? arguments[0] : (document.getElementById('shiftBuilding')?.value);
            const deptId = document.getElementById('shiftDepartment')?.value;
            const select = document.getElementById('shiftEmployee');
            if (!select) return;
            select.innerHTML = '<option value="">Select Employee</option>';
            const seenEmpIds = new Set();
            employees.forEach(emp => {
                // For admin, filter by selected building
                if (currentUser?.role === 'ADMIN') {
                    if (buildingId && String(emp.buildingId) !== String(buildingId)) return;
                }
                // For both admin/manager, filter by department if selected
                if (deptId && String(emp.departmentId) !== String(deptId)) return;
                if (seenEmpIds.has(emp.id)) return;
                const option = document.createElement('option');
                option.value = emp.id;
                option.textContent = `${emp.firstName} ${emp.lastName}`;
                select.appendChild(option);
                seenEmpIds.add(emp.id);
            });
            // Always update cache after changing options
            updateEmployeeOptionsCache();
        }

        // Show selected employee's availability in modal
        async function showSelectedEmployeeAvailability() {
            const select = document.getElementById('shiftEmployee');
            const employeeId = select.value;
            // Hide modal if no employee selected
            if (!employeeId) {
                closeAvailabilityMiniModal();
                return;
            }
            // Auto-select department for selected employee
            const emp = employees.find(e => String(e.id) === String(employeeId));
            if (emp && emp.departmentId) {
                const deptSelect = document.getElementById('shiftDepartment');
                if (deptSelect) {
                    deptSelect.value = String(emp.departmentId);
                }
            }
            // Fetch and display availability modal
            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch(`${API_BASE_URL}/employees/${employeeId}/availability`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                if (response.status === 401 || response.status === 403) {
                    logout();
                    return;
                }
                if (!response.ok) {
                    closeAvailabilityMiniModal();
                    return;
                }
                const data = await response.json();
                showAvailabilityMiniModal(data, emp);
            } catch (error) {
                closeAvailabilityMiniModal();
            }
        }

        // Mini modal for employee availability
        function showAvailabilityMiniModal(availability, employee) {
            let modal = document.getElementById('availabilityMiniModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'availabilityMiniModal';
                modal.className = 'modal mini-modal';
                modal.style.position = 'fixed';
                // Use previous fixed position for reliability
                modal.style.left = 'calc(50vw - 520px)';
                modal.style.top = 'calc(50vh - 180px)';
                modal.style.zIndex = '1002';
                modal.style.width = '220px';
                modal.style.background = '#fff';
                modal.style.border = 'none';
                modal.style.boxShadow = '0 4px 16px rgba(0,0,0,0.13)';
                modal.style.borderRadius = '12px';
                modal.style.padding = '0';
                modal.innerHTML = `
                    <div id="availabilityModalInner" style="padding:14px 14px 10px 14px;">
                        <div style="display:flex;justify-content:space-between;align-items:center;">
                            <h4 id="availabilityModalTitle" style="margin:0;font-size:15px;font-weight:600;color:#2a2a2a;">${employee ? employee.firstName + ' ' + employee.lastName : 'Employee'} Availability</h4>
                            <button onclick="closeAvailabilityMiniModal()" style="background:none;border:none;font-size:18px;line-height:1;color:#888;cursor:pointer;">&times;</button>
                        </div>
                        <div id="availabilityContent"></div>
                    </div>
                `;
                document.body.appendChild(modal);
            } else {
                modal.style.display = 'block';
                // Update position in case window size changes
                modal.style.left = 'calc(50vw - 520px)';
                modal.style.top = 'calc(50vh - 180px)';
                modal.style.width = '220px';
                // Update the name/title on every call
                const title = modal.querySelector('#availabilityModalTitle');
                if (title) {
                    title.textContent = `${employee ? employee.firstName + ' ' + employee.lastName : 'Employee'} Availability`;
                }
            }
            // Fill content
            const content = modal.querySelector('#availabilityContent');
            if (!availability || availability.length === 0) {
                content.innerHTML = '<div style="margin-top:10px;color:#888;font-size:13px;">No availability set for this employee.</div>';
            } else {
                content.innerHTML = `
                    <table style="width:100%;margin-top:10px;font-size:13px;border-collapse:separate;border-spacing:0 4px;">
                        <thead>
                            <tr style="background:#f7f7f7;color:#444;font-weight:500;">
                                <th style="padding:4px 6px;border-radius:6px 0 0 6px;text-align:left;">Day</th>
                                <th style="padding:4px 6px;text-align:left;">Start</th>
                                <th style="padding:4px 6px;border-radius:0 6px 6px 0;text-align:left;">End</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${availability.map(a => `<tr style="background:#fff;"><td style="padding:4px 6px;">${a.day}</td><td style="padding:4px 6px;">${a.startTime}</td><td style="padding:4px 6px;">${a.endTime}</td></tr>`).join('')}
                        </tbody>
                    </table>
                `;
            }
        }

        function closeAvailabilityMiniModal() {
            const modal = document.getElementById('availabilityMiniModal');
            if (modal) modal.style.display = 'none';
        }

        function closeShiftModal() {
            document.getElementById('shiftModal').style.display = 'none';
            editingShiftId = null;
            closeAvailabilityMiniModal();
        }

        async function editShift(shiftId) {
            try {
                const shift = await apiRequest(`/shifts/${shiftId}`);
                editingShiftId = shiftId;

                document.getElementById('shiftModalTitle').textContent = 'Edit Shift';
                document.getElementById('shiftStartTime').value = formatForInput(shift.startTime);
                document.getElementById('shiftEndTime').value = formatForInput(shift.endTime);
                document.getElementById('shiftEmployee').value = shift.employeeId || '';
                document.getElementById('shiftDepartment').value = shift.departmentId;
                document.getElementById('shiftNotes').value = shift.notes || '';

                document.getElementById('shiftModal').style.display = 'block';
                // Attach submit event listener robustly
                const shiftForm = document.getElementById('shiftForm');
                if (shiftForm) {
                    shiftForm.removeEventListener('submit', handleShiftSubmit);
                    shiftForm.addEventListener('submit', handleShiftSubmit);
                }
            } catch (error) {
                showAlert('Failed to load shift details', 'error');
            }
        }

        function openTradeModal(shiftId) {
            tradeOrPostShiftId = shiftId;
            showTradePostBox('trade');
        }

        function openPostShiftModal(shiftId) {
            tradeOrPostShiftId = shiftId;
            showTradePostBox('post');
        }

        function showTradePostBox(mode) {
            // Create modal if not exists
            let modal = document.getElementById('tradePostModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'tradePostModal';
                modal.className = 'modal';
                modal.innerHTML = `
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3 class="modal-title" id="tradePostModalTitle">${mode === 'trade' ? 'Trade Shift' : 'Post Shift'}</h3>
                            <button class="close" onclick="closeTradePostModal()">&times;</button>
                        </div>
                        <div id="tradePostModalBody"></div>
                    </div>
                `;
                document.body.appendChild(modal);
            }
            document.getElementById('tradePostModalTitle').textContent = mode === 'trade' ? 'Trade Shift' : 'Post Shift';
            const body = document.getElementById('tradePostModalBody');
            body.innerHTML = `
                <div style="margin-bottom:20px;">
                    <button class="btn btn-primary" onclick="showPickPerson()">Pick a Person</button>
                    <button class="btn btn-secondary" onclick="postToEveryone()">Post to Everyone</button>
                </div>
                <div id="pickPersonContainer"></div>
            `;
            modal.style.display = 'block';
        }

        function closeTradePostModal() {
            const modal = document.getElementById('tradePostModal');
            if (modal) modal.style.display = 'none';
            document.getElementById('pickPersonContainer').innerHTML = '';
            tradeOrPostShiftId = null;
        }

        function showPickPerson() {
            // Filter employees (exclude self only)
            const eligible = employees.filter(e => e.id !== currentUser.id);
            const container = document.getElementById('pickPersonContainer');
            if (eligible.length === 0) {
                container.innerHTML = '<div>No eligible employees found.</div>';
                return;
            }
            container.innerHTML = `
                <label for="pickPersonSelect">Select Employee:</label>
                <select id="pickPersonSelect">
                    <option value="">-- Select --</option>
                    ${eligible.map(e => `<option value="${e.id}">${e.firstName} ${e.lastName} (${e.role})</option>`).join('')}
                </select>
                <button class="btn btn-success" onclick="submitTradeToPerson()">Send Trade Request</button>
            `;
        }

        async function submitTradeToPerson() {
            const select = document.getElementById('pickPersonSelect');
            const employeeId = select.value;
            if (!employeeId) return showAlert('Please select an employee.', 'error');
            try {
                await apiRequest(`/shifts/${tradeOrPostShiftId}/trade`, {
                    method: 'POST',
                    body: JSON.stringify({ targetEmployeeId: employeeId })
                });
                showAlert('Trade request sent!', 'success');
                closeTradePostModal();
                loadShifts();
            } catch (error) {
                showAlert('Failed to send trade request.', 'error');
            }
        }

        async function postToEveryone() {
            try {
                await apiRequest(`/shifts/${tradeOrPostShiftId}/post-to-everyone`, {
                    method: 'POST'
                });
                showAlert('Shift posted to everyone!', 'success');
                closeTradePostModal();
                loadShifts();
            } catch (error) {
                showAlert('Failed to post shift.', 'error');
            }
        }

        async function handleShiftSubmit(e) {
            console.log('handleShiftSubmit fired');
            e.preventDefault();
            const formData = new FormData(e.target);
            // Convert local datetime-local input (CST) to UTC ISO string for backend
            function cstLocalToUTCISOString(localDateTimeStr) {
                // localDateTimeStr: 'YYYY-MM-DDTHH:mm'
                // Treat input as CST (America/Chicago), convert to UTC ISO string
                // Create a Date object from the input string as if it is CST
                // Use toLocaleString to get the CST time, then create a Date object from that
                const cstDate = new Date(new Date(localDateTimeStr + ':00').toLocaleString('en-US', { timeZone: 'America/Chicago' }));
                // Now get the UTC ISO string
                return new Date(cstDate.getTime() - cstDate.getTimezoneOffset() * 60000).toISOString();
            }

            const startTimeStr = formData.get('startTime');
            const endTimeStr = formData.get('endTime');
            // For duration calculation, treat as CST
            const startTime = new Date(new Date(startTimeStr + ':00').toLocaleString('en-US', { timeZone: 'America/Chicago' }));
            const endTime = new Date(new Date(endTimeStr + ':00').toLocaleString('en-US', { timeZone: 'America/Chicago' }));
            const durationHours = (endTime - startTime) / (1000 * 60 * 60);
            if (isNaN(durationHours) || durationHours <= 0) {
                showAlert('End time must be after start time. Duration cannot be negative or zero.', 'error');
                return;
            }

            const shiftData = {
                startTime: cstLocalToUTCISOString(startTimeStr),
                endTime: cstLocalToUTCISOString(endTimeStr),
                employeeId: formData.get('employeeId') || null,
                departmentId: parseInt(formData.get('departmentId')),
                notes: formData.get('notes') || null
            };

            try {
                if (editingShiftId) {
                    await apiRequest(`/shifts/${editingShiftId}`, {
                        method: 'PUT',
                        body: JSON.stringify(shiftData)
                    });
                    showAlert('Shift updated successfully!', 'success');
                } else {
                    await apiRequest('/shifts', {
                        method: 'POST',
                        body: JSON.stringify(shiftData)
                    });
                    showAlert('Shift created successfully!', 'success');
                }
                closeShiftModal();
                loadShifts();
            } catch (error) {
                showAlert('Failed to save shift. Please try again.', 'error');
            }
        }

        async function deleteShift(shiftId) {
            if (!confirm('Are you sure you want to delete this shift?')) return;
            try {
                // Use the correct API endpoint and method from ShiftController
                const response = await fetch(`${API_BASE_URL}/shifts/${shiftId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`,
                        'Content-Type': 'application/json'
                    }
                });
                if (response.status === 401 || response.status === 403) {
                    logout();
                    return;
                }
                if (response.ok) {
                    showAlert('Shift deleted successfully!', 'success');
                    setTimeout(() => { loadShifts(); }, 100);
                } else {
                    let errorMsg = 'Failed to delete shift';
                    try {
                        const error = await response.json();
                        if (error && error.message) errorMsg = error.message;
                    } catch (e) { }
                    showAlert(errorMsg, 'error');
                }
            } catch (error) {
                showAlert('Failed to delete shift. Please try again.', 'error');
            }
        }

        async function pickupShift(shiftId) {
            if (!confirm('Are you sure you want to pick up this shift?')) return;
            try {
                const response = await fetch(`${API_BASE_URL}/shifts/${shiftId}/pick-up`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`,
                        'Content-Type': 'application/json'
                    }
                });
                if (response.status === 401 || response.status === 403) {
                    logout();
                    return;
                }
                if (response.ok) {
                    showAlert('Shift picked up successfully!', 'success');
                    loadShifts();
                } else {
                    let errorMsg = 'Failed to pick up shift';
                    try {
                        const error = await response.json();
                        if (error && error.message) errorMsg = error.message;
                    } catch (e) { }
                    showAlert(errorMsg, 'error');
                }
            } catch (error) {
                showAlert('Failed to pick up shift. Please try again.', 'error');
            }
        }

        // Utility functions
        function canManageShifts() {
            return currentUser?.role === 'ADMIN' || currentUser?.role === 'MANAGER';
        }

        function setDefaultDates() {
            const today = new Date();
            const nextWeek = new Date(today);
            nextWeek.setDate(today.getDate() + 7);

            document.getElementById('startDate').value = today.toISOString().split('T')[0];
            document.getElementById('endDate').value = nextWeek.toISOString().split('T')[0];
        }

        // Ensure all filter controls trigger loadShifts and preserve selections
        document.getElementById('startDate').addEventListener('change', function () {
            loadShifts();
        });
        document.getElementById('endDate').addEventListener('change', function () {
            loadShifts();
        });
        document.getElementById('departmentFilter').addEventListener('change', function () {
            loadShifts();
        });
        document.getElementById('employeeFilter').addEventListener('change', function () {
            loadShifts();
        });
        document.getElementById('statusFilter').addEventListener('change', function () {
            loadShifts();
        });
        // On page load, set default dates and load selections
        function setDefaultDatesAndSelections() {
            const today = new Date();
            const nextWeek = new Date(today);
            nextWeek.setDate(today.getDate() + 7);
            document.getElementById('startDate').value = today.toISOString().split('T')[0];
            document.getElementById('endDate').value = nextWeek.toISOString().split('T')[0];
        }
        document.addEventListener('DOMContentLoaded', function () {
            setDefaultDatesAndSelections();
            loadShifts();
        });

        function formatDateTime(dateTime) {
            // Always display in CST (America/Chicago)
            return new Date(dateTime).toLocaleString('en-US', {
                month: 'short',
                day: 'numeric',
                hour: 'numeric',
                minute: '2-digit',
                hour12: true,
                timeZone: 'America/Chicago'
            });
        }

        function formatTime(dateTime) {
            // Always display in CST (America/Chicago)
            return new Date(dateTime).toLocaleString('en-US', {
                hour: 'numeric',
                minute: '2-digit',
                hour12: true,
                timeZone: 'America/Chicago'
            });
        }

        function formatForInput(dateTime) {
            // Convert UTC string to CST datetime-local input value (YYYY-MM-DDTHH:MM)
            const dt = new Date(dateTime);
            // Get CST offset using America/Chicago
            const options = { timeZone: 'America/Chicago', year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', hour12: false };
            const parts = new Intl.DateTimeFormat('en-US', options).formatToParts(dt);
            const get = (type) => parts.find(p => p.type === type)?.value;
            const year = get('year');
            const month = get('month');
            const day = get('day');
            const hour = get('hour');
            const minute = get('minute');
            return `${year}-${month}-${day}T${hour}:${minute}`;
        }

        function formatStatus(status) {
            return status.replace(/_/g, ' ').toLowerCase()
                .replace(/\b\w/g, l => l.toUpperCase());
        }

        function calculateDuration(start, end) {
            const startTime = new Date(start);
            const endTime = new Date(end);
            const diffMs = endTime - startTime;
            return (diffMs / (1000 * 60 * 60)).toFixed(1);
        }

        function showAlert(message, type = 'info') {
            const alertContainer = document.getElementById('alertContainer');
            const alertClass = type === 'error' ? 'alert-error' : 'alert-success';

            alertContainer.innerHTML = `
                <div class="alert ${alertClass}">
                    ${message}
                </div>
            `;

            setTimeout(() => {
                alertContainer.innerHTML = '';
            }, 5000);
        }

        async function exportShifts() {
            try {
                if (!shifts || shifts.length === 0) {
                    showAlert('No shifts to export.', 'error');
                    return;
                }
                // Prepare Excel data
                const headers = ['ID', 'Start Time', 'End Time', 'Employee', 'Department', 'Status', 'Notes'];
                const rows = shifts.map(shift => [
                    shift.id,
                    new Date(shift.startTime).toLocaleString(),
                    new Date(shift.endTime).toLocaleString(),
                    shift.employeeName || '',
                    shift.departmentName || '',
                    shift.status,
                    shift.notes || ''
                ]);
                // Build worksheet
                let csvContent = [headers.join(','), ...rows.map(r => r.map(v => `"${v}"`).join(','))].join('\n');
                // Convert CSV to Excel file
                const blob = new Blob([csvContent], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `shifts-${new Date().toISOString().split('T')[0]}.xlsx`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                a.remove();
                showAlert('Shifts exported to Excel successfully!', 'success');
            } catch (error) {
                showAlert('Failed to export shifts', 'error');
            }
        }

        // Close modal when clicking outside
        window.onclick = function (event) {
            const shiftModal = document.getElementById('shiftModal');
            if (event.target === shiftModal) {
                closeShiftModal();
            }
            const tradePostModal = document.getElementById('tradePostModal');
            if (event.target === tradePostModal) {
                closeTradePostModal();
            }
        }

        function updateEmployeeOptionsCache() {
            const select = document.getElementById('shiftEmployee');
            if (select) {
                allEmployeeOptions = Array.from(select.options).map(opt => ({ value: opt.value, text: opt.textContent }));
            }
        }
        document.addEventListener('DOMContentLoaded', function () {
            // After employees are loaded, cache all options
            setTimeout(() => {
                updateEmployeeOptionsCache();
                const select = document.getElementById('shiftEmployee');
                if (select) {
                    select.addEventListener('change', function () {
                        showSelectedEmployeeAvailability();
                    });
                }
            }, 500);
            const searchInput = document.getElementById('employeeSearch');
            if (searchInput) {
                searchInput.addEventListener('input', function () {
                    const term = searchInput.value.toLowerCase();
                    const select = document.getElementById('shiftEmployee');
                    if (!select) return;
                    // If search is empty, restore all options
                    if (!term) {
                        select.innerHTML = '';
                        allEmployeeOptions.forEach(opt => {
                            const option = document.createElement('option');
                            option.value = opt.value;
                            option.textContent = opt.text;
                            select.appendChild(option);
                        });
                        closeAvailabilityMiniModal();
                        return;
                    }
                    let filtered = allEmployeeOptions.filter(opt => opt.text.toLowerCase().includes(term));
                    // If no match, restore all options
                    if (filtered.length === 0) {
                        select.innerHTML = '';
                        allEmployeeOptions.forEach(opt => {
                            const option = document.createElement('option');
                            option.value = opt.value;
                            option.textContent = opt.text;
                            select.appendChild(option);
                        });
                        closeAvailabilityMiniModal();
                        return;
                    }
                    select.innerHTML = '';
                    filtered.forEach(opt => {
                        const option = document.createElement('option');
                        option.value = opt.value;
                        option.textContent = opt.text;
                        select.appendChild(option);
                    });
                    // Auto-select if exact match
                    const exact = filtered.find(opt => opt.text.toLowerCase() === term);
                    if (exact) {
                        select.value = exact.value;
                        showSelectedEmployeeAvailability();
                    } else {
                        closeAvailabilityMiniModal();
                    }
                });
            }
        });
        // Update cache after employees are loaded
        function populateEmployeeSelects() {
            const selects = ['employeeFilter', 'shiftEmployee'];
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (selectId === 'employeeFilter') {
                    select.innerHTML = '<option value="">All Employees</option>';
                } else {
                    select.innerHTML = '<option value="">Select Employee</option>';
                }
                employees.forEach(emp => {
                    const option = document.createElement('option');
                    option.value = emp.id;
                    option.textContent = `${emp.firstName} ${emp.lastName}`;
                    select.appendChild(option);
                });
            });
            updateEmployeeOptionsCache();
        }
    </script>
</body>

</html>