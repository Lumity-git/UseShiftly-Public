<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Change Password - Shiftly Scheduler</title>
    <link rel="stylesheet" href="style.css">
</head>
<body class="login-page">
    <div class="login-container">
        <div class="login-right">
            <div class="login-header">
                <h2>Change Your Password</h2>
                <p>For security, you must set a new password before continuing.</p>
            </div>
            <div id="alert" class="alert"></div>
            <form id="changePasswordForm">
                <div class="form-group">
                    <label for="newPassword">New Password</label>
                    <input type="password" id="newPassword" name="newPassword" autocomplete="new-password" required placeholder="Enter new password">
                </div>
                <div class="form-group">
                    <label for="confirmPassword">Confirm New Password</label>
                    <input type="password" id="confirmPassword" name="confirmPassword" autocomplete="new-password" required placeholder="Confirm new password">
                </div>
                <button type="submit" class="login-btn" id="changeBtn">Change Password</button>
            </form>
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <span>Updating password...</span>
            </div>
        </div>
    </div>
    <script>
        const API_BASE_URL = window.location.origin + '/api';
        const changeForm = document.getElementById('changePasswordForm');
        const newPasswordInput = document.getElementById('newPassword');
        const confirmPasswordInput = document.getElementById('confirmPassword');
        const changeBtn = document.getElementById('changeBtn');
        const alertDiv = document.getElementById('alert');
        const loadingDiv = document.getElementById('loading');

        function showAlert(message, type = 'error') {
            alertDiv.textContent = message;
            alertDiv.className = `alert ${type}`;
            alertDiv.style.display = 'block';
        }
        function hideAlert() {
            alertDiv.style.display = 'none';
        }
        function showLoading() {
            changeBtn.style.display = 'none';
            loadingDiv.style.display = 'block';
        }
        function hideLoading() {
            changeBtn.style.display = 'block';
            loadingDiv.style.display = 'none';
        }

        changeForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const newPassword = newPasswordInput.value.trim();
            const confirmPassword = confirmPasswordInput.value.trim();
            if (!newPassword || !confirmPassword) {
                showAlert('Please fill in all fields');
                return;
            }
            if (newPassword !== confirmPassword) {
                showAlert('Passwords do not match');
                return;
            }
            // Password policy: 1 special char, 1 uppercase, 1 number, min 8 chars
            const passwordPolicy = /^(?=.*[A-Z])(?=.*\d)(?=.*[!@#$%^&*()_+\-=[\]{};':"\\|,.<>/?]).{8,}$/;
            if (!passwordPolicy.test(newPassword)) {
                showAlert('Password must be at least 8 characters, include 1 uppercase letter, 1 number, and 1 special character.');
                return;
            }
            showLoading();
            hideAlert();
            
            // Debug: Log current authentication state
            const sessionToken = localStorage.getItem('authToken');
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const token = urlParams.get('token');
            
            console.log('Change password debug info:');
            console.log('Session token present:', !!sessionToken);
            console.log('URL code present:', !!code);
            console.log('URL token present:', !!token);
            console.log('Current URL:', window.location.href);
            
            let apiHeaders = { 'Content-Type': 'application/json' };
            let body = { newPassword };
            
            // PRIORITY: If code/token are in URL (password reset link), use them regardless of session
            if (code && token) {
                console.log('Using password reset link (code/token) - will change password for the invited employee');
                body.code = code;
                body.token = token;
                // Do NOT include Authorization header for password reset links
            } else if (sessionToken) {
                console.log('Using session token - will change password for currently logged in user');
                apiHeaders['Authorization'] = `Bearer ${sessionToken}`;
            } else {
                showAlert('Invalid or missing password reset link, and you are not logged in.');
                hideLoading();
                return;
            }
            try {
                console.log('Making change password request with headers:', apiHeaders);
                console.log('Request body:', body);
                
                const response = await fetch(`${API_BASE_URL}/auth/change-password`, {
                    method: 'POST',
                    headers: apiHeaders,
                    body: JSON.stringify(body)
                });
                
                console.log('Response status:', response.status);
                console.log('Response headers:', response.headers);
                
                const data = await response.json();
                console.log('Response data:', data);
                console.log('Response data message:', data.message);
                console.log('Response data error details:', data.error);
                
                if (response.ok) {
                    if (code && token) {
                        showAlert('Employee password changed successfully! The reset link is now invalid.', 'success');
                        // For password reset links, redirect to login page
                        setTimeout(() => {
                            window.location.href = '/frontend/login';
                        }, 2000);
                    } else {
                        showAlert('Password changed successfully!', 'success');
                        // For authenticated users, log out and redirect to login
                        localStorage.removeItem('authToken');
                        localStorage.removeItem('userInfo');
                        setTimeout(() => {
                            window.location.href = '/frontend/login';
                        }, 1200);
                    }
                } else {
                    if (response.status === 401) {
                        if (code && token) {
                            showAlert('Invalid or expired password reset link. Please request a new one.');
                        } else if (sessionToken) {
                            showAlert('Your session has expired. Please log in again and try changing your password.');
                            // Clear expired token and redirect to login
                            localStorage.removeItem('authToken');
                            localStorage.removeItem('userInfo');
                            setTimeout(() => {
                                window.location.href = '/frontend/login';
                            }, 2000);
                        } else {
                            showAlert('Authentication failed. Please log in and try again.');
                        }
                    } else {
                        showAlert(data.message || 'Failed to change password');
                    }
                }
            } catch (error) {
                console.error('Request error:', error);
                showAlert('Unable to connect to server. Please try again.');
            } finally {
                hideLoading();
            }
        });

        async function checkAuth() {
            // No-op for invitation-based password reset
            return true;
        }
        newPasswordInput.addEventListener('input', hideAlert);
        confirmPasswordInput.addEventListener('input', hideAlert);
        window.addEventListener('load', () => {
            newPasswordInput.focus();
        });
    </script>
</body>
</html>
