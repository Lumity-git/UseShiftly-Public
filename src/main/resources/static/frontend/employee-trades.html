<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Shift Trades - Shiftly Scheduler</title>
    <link rel="stylesheet" href="style.css" />
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        document.body.classList.add("employee-trades");
      });
    </script>
  </head>
  <body>
    <div id="headerContainer"></div>
    <script src="nav-manager.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        fetch("header.html")
          .then((res) => res.text())
          .then((html) => {
            document.getElementById("headerContainer").innerHTML = html;
            renderNavLinks("employee-trades.html");
            initEmployeeTradesPage();
          });
      });
    </script>

    <div class="container">
      <div class="tabs">
        <button class="tab-btn active" onclick="showTab('available')">
          Available Shifts
        </button>
        <button class="tab-btn" onclick="showTab('my-trades')">
          My Trade Requests
        </button>
        <button class="tab-btn" onclick="showTab('incoming-trades')">
          Shifts Sent To Me
        </button>
      </div>

      <div id="available-tab" class="tab-content active">
        <div id="availableLoading" class="loading">
          <div class="spinner"></div>
          <p>Loading available shifts...</p>
        </div>

        <div
          id="availableShiftsContainer"
          class="trades-grid"
          style="display: none"
        >
          <!-- Available shifts will be loaded here -->
        </div>

        <div id="noAvailableShifts" class="no-trades" style="display: none">
          <div class="no-trades-icon">üîÑ</div>
          <h3 class="no-trades-title">No Available Shifts</h3>
          <p class="no-trades-text">
            There are no shifts available for pickup at the moment. Check back
            later!
          </p>
        </div>
      </div>

      <div id="my-trades-tab" class="tab-content">
        <div id="tradesLoading" class="loading">
          <div class="spinner"></div>
          <p>Loading your trade requests...</p>
        </div>

        <div id="myTradesContainer" class="trades-grid" style="display: none">
          <!-- User's trade requests will be loaded here -->
        </div>

        <div id="noMyTrades" class="no-trades" style="display: none">
          <div class="no-trades-icon">üíº</div>
          <h3 class="no-trades-title">No Trade Requests</h3>
          <p class="no-trades-text">
            You haven't made any shift trade requests yet. Go to "My Shifts" to
            give away a shift.
          </p>
        </div>
      </div>

      <div id="incoming-trades-tab" class="tab-content">
        <div id="incomingTradesLoading" class="loading">
          <div class="spinner"></div>
          <p>Loading incoming shift trades...</p>
        </div>

        <div
          id="incomingTradesContainer"
          class="trades-grid"
          style="display: none"
        >
          <!-- Incoming trades will be loaded here -->
        </div>

        <div id="noIncomingTrades" class="no-trades" style="display: none">
          <div class="no-trades-icon">üì•</div>
          <h3 class="no-trades-title">No Incoming Trades</h3>
          <p class="no-trades-text">
            You have not received any shift trades yet.
          </p>
        </div>
      </div>
    </div>

    <script src="auto-logout.js"></script>
    <script src="auth-manager.js"></script>
    <script>
      // Pick up available shift
      window.pickupShift = async function (shiftId) {
        if (!confirm("Are you sure you want to pick up this shift?")) return;
        const token = localStorage.getItem("authToken");
        const container = document.getElementById("availableShiftsContainer");
        let pickedShift = null;
        if (window._lastAvailableShifts) {
          pickedShift = window._lastAvailableShifts.find(
            (s) => s.id === shiftId
          );
        }
        try {
          const response = await fetch(
            `${API_BASE_URL}/shifts/${shiftId}/pick-up`,
            {
              method: "POST",
              headers: {
                Authorization: `Bearer ${token}`,
                "Content-Type": "application/json",
              },
            }
          );
          if (response.ok) {
            // Update status to PENDING_APPROVAL and remove card from UI
            if (pickedShift) {
              pickedShift.status = "PENDING_APPROVAL";
              // Remove from available shifts
              window._lastAvailableShifts = window._lastAvailableShifts.filter(
                (s) => s.id !== shiftId
              );
              displayAvailableShifts(window._lastAvailableShifts);
              // Optionally, show a temporary card or message before removal (not required)
            }
            // Add to my trades as pending approval
            const userInfo = authManager.getUserInfo();
            const pendingTrade = {
              id: Date.now(), // temp id
              status: "PENDING_APPROVAL",
              shift: pickedShift,
              requestingEmployeeId: userInfo.id,
              requestingEmployee: userInfo,
              pickupEmployeeId: userInfo.id,
              pickupEmployee: userInfo,
              pickupEmployeeName: userInfo.firstName + " " + userInfo.lastName,
              shiftId: pickedShift ? pickedShift.id : shiftId,
            };
            if (!window._myTrades) window._myTrades = [];
            window._myTrades.unshift(pendingTrade);
            displayMyTrades(window._myTrades);
            alert("Shift pickup request submitted! Pending manager approval.");
            // Reload from backend after short delay to ensure sync
            setTimeout(() => {
              loadAvailableShifts();
              loadMyTrades();
            }, 1200);
          } else {
            const error = await response.json();
            alert(error.message || "Failed to pick up shift");
          }
        } catch (error) {
          alert("Error picking up shift. Please try again.");
        }
      };
      const API_BASE_URL = window.location.origin + "/api";
      let authToken = localStorage.getItem("authToken");
      let userInfo = JSON.parse(localStorage.getItem("userInfo") || "{}");

      // Check authentication and role
      async function checkAuth(role) {
        const token = localStorage.getItem("authToken");
        const userInfo = localStorage.getItem("userInfo");
        if (!token || !userInfo) {
          window.location.href = "login.html";
          return false;
        }
        try {
          const response = await fetch(`${API_BASE_URL}/auth/validate`, {
            method: "GET",
            headers: {
              Authorization: `Bearer ${token}`,
              "Content-Type": "application/json",
            },
          });
          if (response.status === 401) {
            // Try to refresh token if backend supports
            const refreshResponse = await fetch(
              `${API_BASE_URL}/auth/refresh`,
              {
                method: "POST",
                headers: {
                  Authorization: `Bearer ${token}`,
                  "Content-Type": "application/json",
                },
              }
            );
            if (refreshResponse.ok) {
              const data = await refreshResponse.json();
              if (data.token) {
                localStorage.setItem("authToken", data.token);
                if (data.userInfo) {
                  localStorage.setItem(
                    "userInfo",
                    JSON.stringify(data.userInfo)
                  );
                }
                // Check role after refresh
                const refreshedUser =
                  data.userInfo ||
                  JSON.parse(localStorage.getItem("userInfo") || "{}");
                if (refreshedUser.role !== role) {
                  window.location.href = "login.html";
                  return false;
                }
                return true;
              }
            }
            localStorage.removeItem("authToken");
            localStorage.removeItem("userInfo");
            window.location.href = "login.html";
            return false;
          }
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          const data = await response.json();
          if (data.token) {
            localStorage.setItem("authToken", data.token);
          }
          if (data.userInfo) {
            localStorage.setItem("userInfo", JSON.stringify(data.userInfo));
          }
          // Check role
          const validatedUser =
            data.userInfo ||
            JSON.parse(localStorage.getItem("userInfo") || "{}");
          if (validatedUser.role !== role) {
            window.location.href = "login.html";
            return false;
          }
          return true;
        } catch (error) {
          console.error("Auth validation failed:", error);
          localStorage.removeItem("authToken");
          localStorage.removeItem("userInfo");
          window.location.href = "login.html";
          return false;
        }
      }

      // Initialize page
      async function initEmployeeTradesPage() {
        const isAuthenticated = await checkAuth("EMPLOYEE");
        if (!isAuthenticated) return;

        const userInfo = authManager.getUserInfo();
        document.getElementById(
          "userName"
        ).textContent = `${userInfo.firstName} ${userInfo.lastName}`;

        // Ensure only the available tab is visible on load
        document
          .querySelectorAll(".tab-content")
          .forEach((tab) => tab.classList.remove("active"));
        document.getElementById("available-tab").classList.add("active");
        document
          .querySelectorAll(".tab-btn")
          .forEach((btn) => btn.classList.remove("active"));
        document.querySelector(".tab-btn.active")?.classList.remove("active");
        document.querySelector(".tab-btn").classList.add("active");

        loadAvailableShifts();
      }

      // Show tab
      function showTab(tabName) {
        // Hide all tabs
        document.querySelectorAll(".tab-content").forEach((tab) => {
          tab.classList.remove("active");
        });

        // Remove active class from all buttons
        document.querySelectorAll(".tab-btn").forEach((btn) => {
          btn.classList.remove("active");
        });

        // Show selected tab
        document.getElementById(`${tabName}-tab`).classList.add("active");
        event.target.classList.add("active");

        // Load data for the selected tab
        if (tabName === "available") {
          loadAvailableShifts();
        } else if (tabName === "my-trades") {
          loadMyTrades();
        } else if (tabName === "incoming-trades") {
          loadIncomingTrades();
        }
      }

      // Load available shifts
      async function loadAvailableShifts() {
        try {
          const shifts = await authManager.apiRequest("/shifts/available");
          displayAvailableShifts(shifts);
        } catch (error) {
          console.error("Error loading available shifts:", error);
          document.getElementById("availableLoading").innerHTML =
            "<p>Error loading available shifts. Please try again later.</p>";
        }
      }

      // Load user's trade requests
      async function loadMyTrades() {
        try {
          // Fetch all trades visible to the user
          const allTrades = await authManager.apiRequest("/shifts/trades");
          // Filter for trades where the current user is the requesting employee (robust for both id field types)
          const userInfo = authManager.getUserInfo();
          const myTrades = Array.isArray(allTrades)
            ? allTrades.filter(
                (trade) =>
                  (trade.requestingEmployeeId &&
                    trade.requestingEmployeeId === userInfo.id) ||
                  (trade.requestingEmployee &&
                    trade.requestingEmployee.id === userInfo.id)
              )
            : [];
          displayMyTrades(myTrades);
        } catch (error) {
          console.error("Error loading trade requests:", error);
          document.getElementById("tradesLoading").innerHTML =
            "<p>Error loading trade requests. Please try again later.</p>";
        }
      }

      // Display available shifts
      function displayAvailableShifts(shifts) {
        window._lastAvailableShifts = Array.isArray(shifts) ? [...shifts] : [];
        document.getElementById("availableLoading").style.display = "none";

        if (!Array.isArray(shifts) || shifts.length === 0) {
          document.getElementById("noAvailableShifts").style.display = "block";
          return;
        }

        const container = document.getElementById("availableShiftsContainer");
        container.style.display = "grid";

        container.innerHTML = shifts
          .map((shift) => {
            // Store shift JSON for optimistic UI update
            const shiftJson = JSON.stringify(shift);
            const start = new Date(shift.startTime);
            const end = new Date(shift.endTime);
            const formattedTimes = `${start.toLocaleString()} - ${end.toLocaleString()}`;
            const department =
              shift.departmentName ||
              (shift.department && shift.department.name) ||
              "No Deplook wartment";
            const position = shift.position || "General Staff";
            // Use shift.employeeName or shift.createdByName for poster name
            const posterName =
              shift.employeeName || shift.createdByName || "Unknown";
            return `
                    <div class="trade-card" data-shift-id="${
                      shift.id
                    }" data-shift-json='${shiftJson}'>
                        <div class="trade-header">
                            <div class="trade-title">${start.toLocaleDateString(
                              "en-US",
                              {
                                weekday: "long",
                                year: "numeric",
                                month: "long",
                                day: "numeric",
                              }
                            )}</div>
                            <div class="trade-status status-pending">Available</div>
                        </div>
                        <div class="trade-details">
                            <div class="detail-item">
                                <div class="detail-icon">üïê</div>
                                <div class="detail-text">${formattedTimes}</div>
                            ${
                              status === "PENDING_APPROVAL"
                                ? `<div style="margin-top: 8px;">${cancelPickupBtn}</div>`
                                : ""
                            }
                            <div class="detail-item">
                                <div class="detail-icon">üè¢</div>
                                <div class="detail-text">${department}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-icon">üìç</div>
                                <div class="detail-text">${position}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-icon">üë§</div>
                                <div class="detail-text">Posted by: ${posterName}</div>
                            </div>
                        </div>
                        <div class="trade-actions">
                            <button class="action-btn btn-success" onclick="pickupShift(${
                              shift.id
                            })">
                                Pick Up This Shift
                            </button>
                        </div>
                    </div>
                `;
          })
          .join("");
      }

      // Display user's trade requests
      function displayMyTrades(trades) {
        document.getElementById("tradesLoading").style.display = "none";
        document.getElementById("noMyTrades").style.display = "none";

        if (!trades || trades.length === 0) {
          document.getElementById("noMyTrades").style.display = "block";
          document.getElementById("myTradesContainer").innerHTML = "";
          return;
        }

        const container = document.getElementById("myTradesContainer");
        container.style.display = "grid";

        container.innerHTML = trades
          .map((trade) => {
            // User-friendly status label
            let statusLabel = trade.status;
            let statusClass = `status-${
              trade.status ? trade.status.toLowerCase() : "pending"
            }`;
            if (trade.status === "PENDING_APPROVAL") {
              statusLabel = "Pending Manager Approval";
              statusClass = "status-pending";
            } else if (trade.status === "APPROVED") {
              statusLabel = "Approved";
              statusClass = "status-approved";
            } else if (trade.status === "REJECTED") {
              statusLabel = "Rejected";
              statusClass = "status-rejected";
            } else if (trade.status === "CANCELLED") {
              statusLabel = "Cancelled";
              statusClass = "status-rejected";
            } else if (trade.status === "PENDING") {
              statusLabel = "Pending";
              statusClass = "status-pending";
            }
            // Show recipient info if available
            let recipientInfo = "";
            if (trade.pickupEmployeeName) {
              recipientInfo = `<div class=\"detail-item\"><div class=\"detail-icon\">‚û°Ô∏è</div><div class=\"detail-text\">Sent to: ${trade.pickupEmployeeName}</div></div>`;
            } else if (trade.pickupEmployee) {
              recipientInfo = `<div class=\"detail-item\"><div class=\"detail-icon\">‚û°Ô∏è</div><div class=\"detail-text\">Sent to: ${trade.pickupEmployee.firstName} ${trade.pickupEmployee.lastName}</div></div>`;
            } else if (trade.status === "POSTED_TO_EVERYONE") {
              recipientInfo = `<div class=\"detail-item\"><div class=\"detail-icon\">üåê</div><div class=\"detail-text\">Posted to Everyone</div></div>`;
            }
            return `
                <div class=\"trade-card\">
                    <div class=\"trade-header\">
                        <div class=\"trade-title\">${formatDate(
                          trade.shift.shiftDate
                        )}</div>
                        <div class=\"trade-status ${statusClass}\">${statusLabel}</div>
                    </div>
                    <div class=\"trade-details\">
                        <div class=\"detail-item\">
                            <div class=\"detail-icon\">üïê</div>
                            <div class=\"detail-text\">${
                              trade.shift.startTime
                            } - ${trade.shift.endTime}</div>
                        </div>
                        <div class=\"detail-item\">
                            <div class=\"detail-icon\">üè¢</div>
                            <div class=\"detail-text\">${
                              trade.shift.department?.name || "No Department"
                            }</div>
                        </div>
                        <div class=\"detail-item\">
                            <div class=\"detail-icon\">üìç</div>
                            <div class=\"detail-text\">${
                              trade.shift.position || "General Staff"
                            }</div>
                        </div>
                        ${recipientInfo}
                        ${
                          trade.pickedUpBy
                            ? `
                        <div class=\"detail-item\">
                            <div class=\"detail-icon\">üë§</div>
                            <div class=\"detail-text\">Picked up by: ${trade.pickedUpBy.firstName} ${trade.pickedUpBy.lastName}</div>
                        </div>
                        `
                            : ""
                        }
                    </div>
                    <div class=\"trade-actions\">
                        ${
                          trade.status === "PENDING"
                            ? `
                            <button class=\"action-btn btn-danger\" onclick=\"cancelTrade(${trade.id})\">
                                Cancel Request
                            </button>
                        `
                            : ""
                        }
                        ${
                          trade.status === "PENDING_APPROVAL"
                            ? `
                            <button class=\"action-btn btn-danger oval-cancel\" style=\"background: #e74c3c; color: #fff; border-radius: 20px; padding: 6px 18px; font-weight: bold;\" onclick=\"cancelPickup(${trade.id})\">
                                Cancel Pickup
                            </button>
                        `
                            : ""
                        }
                    </div>
                </div>
            `;
          })
          .join("");
      }

      // Load incoming trades (shifts sent to the logged-in employee)
      async function loadIncomingTrades() {
        try {
          const trades = await authManager.apiRequest(
            "/shifts/trades/incoming"
          );
          displayIncomingTrades(trades);
        } catch (error) {
          console.error("Error loading incoming trades:", error);
          document.getElementById("incomingTradesLoading").innerHTML =
            "<p>Error loading incoming trades. Please try again later.</p>";
        }
      }

      // Display incoming trades
      function displayIncomingTrades(trades) {
        // Hide loading spinner
        document.getElementById("incomingTradesLoading").style.display = "none";
        // Hide both containers initially
        document.getElementById("incomingTradesContainer").style.display =
          "none";
        document.getElementById("noIncomingTrades").style.display = "none";

        if (!Array.isArray(trades) || trades.length === 0) {
          document.getElementById("noIncomingTrades").style.display = "block";
          document.getElementById("incomingTradesContainer").innerHTML = "";
          return;
        }
        // Filter out trades with status CANCELLED or REJECTED
        const visibleTrades = trades.filter(
          (trade) => trade.status !== "CANCELLED" && trade.status !== "REJECTED"
        );
        const container = document.getElementById("incomingTradesContainer");
        container.style.display = "grid";
        container.innerHTML = visibleTrades
          .map((trade) => {
            const start = new Date(trade.startTime);
            const end = new Date(trade.endTime);
            const formattedTimes = `${start.toLocaleString()} - ${end.toLocaleString()}`;
            const department =
              trade.departmentName ||
              (trade.department && trade.department.name) ||
              "No Department";
            const position = trade.position || "General Staff";
            const senderName =
              trade.requestingEmployeeName ||
              (trade.requestingEmployee && trade.requestingEmployee.firstName
                ? `${trade.requestingEmployee.firstName} ${trade.requestingEmployee.lastName}`
                : "Unknown");
            const status = trade.status
              ? trade.status.toUpperCase()
              : "PENDING";
            let statusLabel = status;
            let showActions = true;
            let cancelPickupBtn = "";
            if (status === "PENDING_APPROVAL") {
              statusLabel = "Pending Manager Approval";
              // Show Cancel Pickup button for PENDING_APPROVAL trades
              cancelPickupBtn = `<button class=\"action-btn btn-danger oval-cancel\" style=\"background: #e74c3c; color: #fff; border-radius: 20px; padding: 6px 18px; font-weight: bold;\" onclick=\"cancelPickup(${trade.id})\">Cancel Pickup</button>`;
              showActions = false;
            } else if (status === "APPROVED") {
              statusLabel = "Approved";
              showActions = false;
            } else if (status === "REJECTED" || status === "CANCELLED") {
              // Should not display, already filtered out
              return "";
            }
            return `
                <div class=\"trade-card\">\n                    <div class=\"trade-header\">\n                        <div class=\"trade-title\">${start.toLocaleDateString(
                  "en-US",
                  {
                    weekday: "long",
                    year: "numeric",
                    month: "long",
                    day: "numeric",
                  }
                )}</div>\n                        <div class=\"trade-status status-${status.toLowerCase()}\">${statusLabel}</div>\n                    </div>\n                    <div class=\"trade-details\">\n                        <div class=\"detail-item\">\n                            <div class=\"detail-icon\">üïê</div>\n                            <div class=\"detail-text\">${formattedTimes}</div>\n                        </div>\n                        <div class=\"detail-item\">\n                            <div class=\"detail-icon\">üè¢</div>\n                            <div class=\"detail-text\">${department}</div>\n                        </div>\n                        <div class=\"detail-item\">\n                            <div class=\"detail-icon\">üìç</div>\n                            <div class=\"detail-text\">${position}</div>\n                        </div>\n                        <div class=\"detail-item\" style=\"display: flex; align-items: center; justify-content: space-between;\">\n                            <div style=\"display: flex; align-items: center;\">\n                                <div class=\"detail-icon\">üë§</div>\n                                <div class=\"detail-text\">Sent by: ${senderName}</div>\n                            </div>\n                            ${
              status === "PENDING_APPROVAL" ? cancelPickupBtn : ""
            }\n                        </div>\n                    </div>\n                    <div class=\"trade-actions\">\n                        ${
              showActions
                ? `<button class=\"action-btn btn-success\" onclick=\"acceptTrade(${trade.id})\">Accept</button>\n                        <button class=\"action-btn btn-danger\" onclick=\"rejectTrade(${trade.id})\">Decline</button>`
                : ""
            }\n                    </div>\n                </div>\n            `;
          })
          .join("");
      }
      window.acceptTrade = async function (tradeId) {
        if (!confirm("Are you sure you want to accept this shift trade?"))
          return;
        const token = localStorage.getItem("authToken");
        try {
          const response = await fetch(
            `${API_BASE_URL}/shifts/trades/${tradeId}/accept`,
            {
              method: "POST",
              headers: {
                Authorization: `Bearer ${token}`,
                "Content-Type": "application/json",
              },
            }
          );
          if (response.ok) {
            alert("Trade accepted! Pending manager approval.");
            loadAvailableShifts();
            loadIncomingTrades(); // Will update card to show pending approval and remove buttons
          } else {
            const error = await response.json();
            alert(error.message || "Failed to accept trade");
          }
        } catch (error) {
          alert("Error accepting trade. Please try again.");
        }
      };
      window.rejectTrade = async function (tradeId) {
        if (!confirm("Are you sure you want to reject this shift trade?"))
          return;
        const token = localStorage.getItem("authToken");
        try {
          const response = await fetch(
            `${API_BASE_URL}/shifts/trades/${tradeId}/decline`,
            {
              method: "POST",
              headers: {
                Authorization: `Bearer ${token}`,
                "Content-Type": "application/json",
              },
            }
          );
          if (response.ok) {
            alert("Trade declined.");
            loadAvailableShifts();
            loadIncomingTrades(); // Will remove the card from the list
          } else {
            const error = await response.json();
            alert(error.message || "Failed to reject trade");
          }
        } catch (error) {
          alert("Error rejecting trade. Please try again.");
        }
      };

      // Format date for display
      function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString("en-US", {
          weekday: "long",
          year: "numeric",
          month: "long",
          day: "numeric",
        });
      }

      // Cancel trade request
      window.cancelTrade = async function (tradeId) {
        if (!confirm("Are you sure you want to cancel this trade request?"))
          return;
        const token = localStorage.getItem("authToken");
        try {
          const response = await fetch(
            `${API_BASE_URL}/shifts/trades/${tradeId}/cancel`,
            {
              method: "POST",
              headers: {
                Authorization: `Bearer ${token}`,
                "Content-Type": "application/json",
              },
            }
          );

          if (response.status === 401 || response.status === 403) {
            localStorage.removeItem("authToken");
            localStorage.removeItem("userInfo");
            window.location.href = "login.html";
            return;
          }

          if (response.ok) {
            alert("Trade request cancelled successfully!");
            setTimeout(loadMyTrades, 1000); // Auto-refresh after short delay
          } else {
            const error = await response.json();
            alert(error.message || "Failed to cancel trade request");
            setTimeout(loadMyTrades, 1000); // Try to refresh anyway
          }
        } catch (error) {
          console.error("Error cancelling trade request:", error);
          alert("Error cancelling trade request. Please try again.");
          setTimeout(loadMyTrades, 1000);
        }
      };

      // Cancel pickup (for PENDING_APPROVAL)
      window.cancelPickup = async function (tradeId) {
        if (!confirm("Are you sure you want to cancel this pickup?")) return;
        const token = localStorage.getItem("authToken");
        try {
          const response = await fetch(
            `${API_BASE_URL}/shifts/trades/${tradeId}`,
            {
              method: "DELETE",
              headers: {
                Authorization: `Bearer ${token}`,
                "Content-Type": "application/json",
              },
            }
          );
          if (response.status === 401 || response.status === 403) {
            localStorage.removeItem("authToken");
            localStorage.removeItem("userInfo");
            window.location.href = "login.html";
            return;
          }
          if (response.ok) {
            // Optimistically update UI: set status back to SCHEDULED and remove from trade lists
            if (window._myTrades) {
              window._myTrades = window._myTrades.filter(
                (trade) => trade.id !== tradeId
              );
              displayMyTrades(window._myTrades);
            }
            if (window._incomingTrades) {
              window._incomingTrades = window._incomingTrades.filter(
                (trade) => trade.id !== tradeId
              );
              displayIncomingTrades(window._incomingTrades);
            }
            alert("Pickup cancelled. Shift returned to scheduled status.");
            setTimeout(() => {
              loadMyTrades();
              loadIncomingTrades();
            }, 1000);
          } else {
            let errorMsg = "Failed to cancel pickup";
            try {
              const error = await response.json();
              errorMsg = error.message || errorMsg;
            } catch {}
            alert(errorMsg);
            setTimeout(loadMyTrades, 1000);
          }
        } catch (error) {
          alert("Error cancelling pickup. Please try again.");
          setTimeout(loadMyTrades, 1000);
        }
      };

      // Logout function
      function logout() {
        localStorage.removeItem("authToken");
        localStorage.removeItem("userInfo");
        window.location.href = "login.html";
      }

      // Initialize when page loads, after header is loaded
      // ...existing code...
    </script>
  </body>
</html>
