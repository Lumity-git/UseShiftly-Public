<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Profile - Shiftly Scheduler</title>
    <link rel="stylesheet" href="style.css">
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        document.body.classList.add('employee-profile');
      });
    </script>
</head>
<body>
    <div id="headerContainer"></div>
    <script src="nav-manager.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", function() {
        fetch("header.html")
          .then(res => res.text())
          .then(html => {
            document.getElementById("headerContainer").innerHTML = html;
            renderNavLinks("employee-profile.html");
            initEmployeeProfilePage();
          });
      });
    </script>

    <div class="container">
        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p>Loading your profile...</p>
        </div>

        <div id="profileContent" style="display: none;">
            <div class="profile-card">
                <div class="profile-header">
                    <div class="profile-avatar">üë§</div>
                    <div class="profile-name" id="profileName">Loading...</div>
                    <div class="profile-email" id="profileEmail">Loading...</div>
                </div>

                <div class="profile-body">

                    <h3 class="section-title">Personal Information</h3>
                    <div class="info-grid">
                        <div class="info-item">
                            <div class="info-label">
                                <span>üë§</span>
                                Full Name
                            </div>
                            <div class="info-value" id="fullName">Loading...</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">
                                <span>üìß</span>
                                Email Address
                            </div>
                            <div class="info-value" id="emailAddress">Loading...</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">
                                <span>üè¢</span>
                                Department
                            </div>
                            <div class="info-value" id="department">Loading...</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">
                                <span>üé≠</span>
                                Role
                            </div>
                            <div class="info-value" id="roleInfo">Loading...</div>
                        </div>
                    <div class="info-item">
                        <div class="info-label">
                            <span>üìÖ</span>
                            Date of Birth
                        </div>
                        <div class="info-value" id="dateOfBirth">Loading...</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">
                            <span>üè†</span>
                            Address
                        </div>
                        <div class="info-value" id="address">Loading...</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">
                            <span>‚úÖ</span>
                            Account Status
                        </div>
                        <div class="info-value" id="accountStatus">Active</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">
                            <span>üìû</span>
                            Phone Number
                        </div>
                        <div class="info-value" id="phoneNumber">Loading...</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">
                            <span>üö®</span>
                            Emergency Contact
                        </div>
                        <div class="info-value" id="emergencyContact">Loading...</div>
                    </div>
                    </div>

                    <h3 class="section-title">Quick Actions</h3>
                    <div class="action-buttons">
                        <a href="employee-shifts.html" class="action-btn btn-primary">
                            <span>üìÖ</span>
                            View My Shifts
                        </a>
                        <a href="employee-trades.html" class="action-btn btn-primary">
                            <span>üîÑ</span>
                            Manage Trades
                        </a>
                        <a href="employee-dashboard.html" class="action-btn btn-secondary">
                            <span>üè†</span>
                            Back to Dashboard
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="auto-logout.js"></script>
    <script src="auth-manager.js"></script>
    <script>
        const API_BASE_URL = window.location.origin + '/api';

        // Initialize page after header loads
        async function initEmployeeProfilePage() {
            const isAuthenticated = await checkAuth('EMPLOYEE');
            if (!isAuthenticated) return;

            const userInfo = authManager.getUserInfo();
            const userNameSpan = document.getElementById('userName');
            if (userNameSpan) {
                userNameSpan.textContent = `${userInfo.firstName} ${userInfo.lastName}`;
            }
            const userRoleSpan = document.getElementById('userRole');
            if (userRoleSpan) {
                userRoleSpan.textContent = userInfo.role || 'Employee';
            }
            loadProfile();
        }

        async function checkAuth(role) {
            const token = localStorage.getItem('authToken');
            const userInfo = localStorage.getItem('userInfo');
            if (!token || !userInfo) {
                window.location.href = 'login.html';
                return false;
            }
            try {
                const response = await fetch(`${API_BASE_URL}/auth/validate`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                if (response.status === 401) {
                    // Try to refresh token if backend supports
                    const refreshResponse = await fetch(`${API_BASE_URL}/auth/refresh`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    });
                    if (refreshResponse.ok) {
                        const data = await refreshResponse.json();
                        if (data.token) {
                            localStorage.setItem('authToken', data.token);
                            if (data.userInfo) {
                                localStorage.setItem('userInfo', JSON.stringify(data.userInfo));
                            }
                            // Check role after refresh
                            const refreshedUser = data.userInfo || JSON.parse(localStorage.getItem('userInfo') || '{}');
                            if (refreshedUser.role !== role) {
                                window.location.href = 'login.html';
                                return false;
                            }
                            return true;
                        }
                    }
                    localStorage.removeItem('authToken');
                    localStorage.removeItem('userInfo');
                    window.location.href = 'login.html';
                    return false;
                }
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                if (data.token) {
                    localStorage.setItem('authToken', data.token);
                }
                if (data.userInfo) {
                    localStorage.setItem('userInfo', JSON.stringify(data.userInfo));
                }
                // Check role
                const validatedUser = data.userInfo || JSON.parse(localStorage.getItem('userInfo') || '{}');
                if (validatedUser.role !== role) {
                    window.location.href = 'login.html';
                    return false;
                }
                return true;
            } catch (error) {
                console.error('Auth validation failed:', error);
                localStorage.removeItem('authToken');
                localStorage.removeItem('userInfo');
                window.location.href = 'login.html';
                return false;
            }
        }


        // Load user profile only
        async function loadProfile() {
            try {
                const profile = await authManager.apiRequest('/employees/profile');
                displayProfile(profile);
            } catch (error) {
                console.error('Error loading profile:', error);
                document.getElementById('loading').innerHTML = '<p>Error loading profile. Please try again later.</p>';
            }
        }

        // Display profile information
        function displayProfile(profile) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('profileContent').style.display = 'block';

            document.getElementById('profileName').textContent = `${profile.firstName || ''} ${profile.lastName || ''}`.trim();
            document.getElementById('profileEmail').textContent = profile.email || '';
            document.getElementById('fullName').textContent = `${profile.firstName || ''} ${profile.lastName || ''}`.trim();
            document.getElementById('emailAddress').textContent = profile.email || '';
            document.getElementById('department').textContent = profile.departmentName || 'Not Assigned';
            document.getElementById('roleInfo').textContent = profile.role || '';
            document.getElementById('dateOfBirth').textContent = profile.dateOfBirth ? formatDate(profile.dateOfBirth) : 'Not Provided';
            document.getElementById('address').textContent = profile.address || 'Not Provided';
            document.getElementById('accountStatus').textContent = profile.active ? 'Active' : 'Inactive';
            document.getElementById('phoneNumber').textContent = profile.phoneNumber || 'Not Provided';
            // Emergency contact: show name, relation, phone
            let emergency = '';
            if (profile.emergencyContactName || profile.emergencyContactRelation || profile.emergencyContactPhone) {
                emergency = `${profile.emergencyContactName || ''}`;
                if (profile.emergencyContactRelation) emergency += ` (${profile.emergencyContactRelation})`;
                if (profile.emergencyContactPhone) emergency += ` - ${profile.emergencyContactPhone}`;
            } else {
                emergency = 'Not Provided';
            }
            document.getElementById('emergencyContact').textContent = emergency;
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }

        function logout() {
            localStorage.removeItem('authToken');
            localStorage.removeItem('userInfo');
            window.location.href = 'login.html';
        }

        // ...existing code...
    </script>
</body>
</html>
