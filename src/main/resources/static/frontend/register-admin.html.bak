<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Register Building Admin - Shiftly Scheduler</title>
  <link rel="stylesheet" href="style.css">
  </style>
</head>

<body>

  <body class="login-page">
    <div class="login-container">
      <div class="login-left">
        <div class="logo">üè® Shiftly Scheduler</div>
        <div class="tagline">
          Professional employee scheduling made simple. Streamline your operations with our comprehensive shift
          management system.
        </div>
      </div>
      <div class="login-right">
        <div class="login-header">
          <h2>Register Admin Account</h2>
          <p>Create your admin account for UseShiftly. This is a free application for anyone to use.</p>
        </div>
        <form id="adminRegisterForm" class="form-card">
          <div class="form-group">
            <label for="ownerName">Owner Name <span class="required">*</span></label>
            <input type="text" id="ownerName" name="ownerName" required>
          </div>
          <div class="form-group">
            <label for="buildingName">Building/Business Name <span class="required">*</span></label>
            <input type="text" id="buildingName" name="buildingName" required>
          </div>
          <div class="form-group">
            <label for="buildingAddress">Building Address <span class="required">*</span></label>
            <input type="text" id="buildingAddress" name="buildingAddress" required>
          </div>
          <div class="form-group">
            <label for="email">Email <span class="required">*</span></label>
            <input type="email" id="email" name="email" required>
          </div>
          <div class="form-group">
            <label for="password">Password <span class="required">*</span></label>
            <input type="password" id="password" name="password" required minlength="8">
          </div>
          <div class="form-group" style="margin-bottom:0.5em;">
            <input type="checkbox" id="agreeTos" name="agreeTos" style="margin-right:8px;" required>
            <label for="agreeTos" style="display:inline;font-weight:400;">I agree to the <a href="#"
                onclick="openTosModal();return false;">Terms and Conditions</a> and Privacy Policy<span
                class="required">*</span></label>
          </div>
          <div class="form-actions">
            <button type="submit" class="btn-primary" id="registerBtn">Register</button>
          </div>
        </form>
        <div id="tosModal" class="modal" style="display:none;">
          <div class="modal-content">
            <span class="close" onclick="closeTosModal()">&times;</span>
            <h3>Terms of Service</h3>
            <p>By registering, you agree to abide by all local laws and regulations, provide accurate information, and
              use Shiftly Scheduler responsibly. Full terms coming soon.</p>
          </div>
        </div>
      </div>
    </div>
    </main>
    <script>
      // Utility: show alert message above form, then callback
      function showAlert(message, type, callback) {
        // Re-enable request button when email changes
        document.getElementById('email').addEventListener('input', function () {
          document.getElementById('requestAccessBtn').disabled = false;
          this.classList.remove('input-error');
        });
        // Remove any previous alert
        let prev = document.getElementById('customAlert');
        if (prev) prev.remove();
        const alertDiv = document.createElement('div');
        alertDiv.id = 'customAlert';
        alertDiv.className = `alert alert-${type}`;
        alertDiv.style = 'margin-bottom:18px;padding:1rem 1.5rem;border-radius:8px;font-size:1.1rem;text-align:center;background:#eaf6ea;color:#2d3a4a;border:1px solid #bcd0ee;box-shadow:0 2px 8px rgba(44,62,80,0.07);';
        alertDiv.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-triangle' : 'info-circle'}" style="margin-right:8px;"></i> ${message}`;
        loginRight.prepend(alertDiv);
        setTimeout(() => {
          alertDiv.remove();
          if (callback) callback();
        }, 1800);
      }

      // Real-time email availability check with 401 handling
      let emailCheckTimeout = null;
      document.getElementById('email').addEventListener('input', function () {
        clearTimeout(emailCheckTimeout);
        const emailInput = this;
        const email = emailInput.value.trim();
        document.getElementById('requestAccessBtn').disabled = false;
        emailInput.classList.remove('input-error');
        emailInput.dataset.registered = "false";
        emailInput.dataset.checkerror = "false";
        // Only check if email looks valid
        if (email && /^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(email)) {
          emailCheckTimeout = setTimeout(async () => {
            try {
              const resp = await fetch(window.location.origin + '/api/auth/check-email?email=' + encodeURIComponent(email));
              if (resp.status === 401) {
                showAlert('Unable to check email availability. Please try again later.', 'error');
                document.getElementById('requestAccessBtn').disabled = true;
                emailInput.classList.add('input-error');
                emailInput.dataset.checkerror = "true";
                return;
              }
              if (resp.ok) {
                const data = await resp.json();
                if (data.registered) {
                  showAlert('This email is already registered. Please use a different email.', 'error');
                  document.getElementById('requestAccessBtn').disabled = true;
                  emailInput.classList.add('input-error');
                  emailInput.dataset.registered = "true";
                }
              }
            } catch (err) {
              showAlert('Unable to check email availability. Please try again later.', 'error');
              document.getElementById('requestAccessBtn').disabled = true;
              emailInput.classList.add('input-error');
              emailInput.dataset.checkerror = "true";
            }
          }, 400);
        }
      });
      const form = document.getElementById('adminRegisterForm');
      const agreeTos = document.getElementById('agreeTos');
      const loginRight = document.querySelector('.login-right');

      form.addEventListener('submit', async function (e) {
        e.preventDefault();
        if (!agreeTos.checked) {
          showAlert('You must agree to the Terms and Conditions to continue.', 'error');
          return;
        }
        const ownerName = document.getElementById('ownerName').value.trim();
        const buildingName = document.getElementById('buildingName').value.trim();
        const buildingAddress = document.getElementById('buildingAddress').value.trim();
        const email = document.getElementById('email').value.trim();
        const password = document.getElementById('password').value;

        if (!ownerName || !buildingName || !buildingAddress || !email || !password) {
          showAlert('Please fill in all required fields.', 'error');
          return;
        }

        if (password.length < 8) {
          showAlert('Password must be at least 8 characters.', 'error');
          return;
        }

        document.getElementById('registerBtn').disabled = true;
        document.getElementById('registerBtn').textContent = 'Registering...';

        try {
          const response = await fetch(window.location.origin + '/api/auth/register-admin', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              ownerName,
              buildingName,
              buildingAddress,
              ownerEmail: email,
              password
            })
          });

          if (response.ok) {
            const data = await response.json();
            showAlert('Registration successful! Building ID: ' + data.message.split('Building ID: ')[1] + '. Redirecting to login...', 'success', () => {
              window.location.href = 'login.html';
            });
          } else {
            const error = await response.text();
            showAlert(error || 'Registration failed. Please try again.', 'error');
            document.getElementById('registerBtn').disabled = false;
            document.getElementById('registerBtn').textContent = 'Register';
          }
        } catch (err) {
          showAlert('Registration failed. Please try again.', 'error');
          document.getElementById('registerBtn').disabled = false;
          document.getElementById('registerBtn').textContent = 'Register';
        }
      });

      // Enable/disable Register button based on TOS checkbox
      agreeTos.addEventListener('change', function () {
        document.getElementById('registerBtn').disabled = !this.checked;
      });

      function showCodeEntry() {
        // ...existing code...
        // Replace form with 6 code boxes, styled for clean, centered look
        loginRight.innerHTML = `
            <div class="login-header" style="background: linear-gradient(90deg, #e0ecff 0%, #f7fafd 100%); border-radius: 12px; padding: 2rem 1rem; margin-bottom: 2rem; text-align: center;">
              <h2 style="font-size:2rem; font-weight:600; color:#2d3a4a; margin-bottom:0.5rem;">Enter Verification Code</h2>
              <p style="color:#4a5a6a; font-size:1.1rem; margin-bottom:0;">We've sent a 6-digit code to your email. Enter it below to continue registration.</p>
            </div>
            <form id="codeForm" class="form-card" style="display:flex; flex-direction:column; align-items:center; justify-content:center; background:transparent; box-shadow:none;">
              <div class="code-inputs" style="display:flex; gap:10px; justify-content:center; margin-bottom:24px;">
                <input type="text" maxlength="1" class="code-box" required pattern="[0-9]" style="width:32px;height:32px;font-size:1.2rem;text-align:center;border:1px solid #bcd0ee;border-radius:6px;outline:none;box-shadow:0 1px 4px rgba(44,62,80,0.07);background:#f7fafd;transition:border-color 0.2s;" />
                <input type="text" maxlength="1" class="code-box" required pattern="[0-9]" style="width:32px;height:32px;font-size:1.2rem;text-align:center;border:1px solid #bcd0ee;border-radius:6px;outline:none;box-shadow:0 1px 4px rgba(44,62,80,0.07);background:#f7fafd;transition:border-color 0.2s;" />
                <input type="text" maxlength="1" class="code-box" required pattern="[0-9]" style="width:32px;height:32px;font-size:1.2rem;text-align:center;border:1px solid #bcd0ee;border-radius:6px;outline:none;box-shadow:0 1px 4px rgba(44,62,80,0.07);background:#f7fafd;transition:border-color 0.2s;" />
                <input type="text" maxlength="1" class="code-box" required pattern="[0-9]" style="width:32px;height:32px;font-size:1.2rem;text-align:center;border:1px solid #bcd0ee;border-radius:6px;outline:none;box-shadow:0 1px 4px rgba(44,62,80,0.07);background:#f7fafd;transition:border-color 0.2s;" />
                <input type="text" maxlength="1" class="code-box" required pattern="[0-9]" style="width:32px;height:32px;font-size:1.2rem;text-align:center;border:1px solid #bcd0ee;border-radius:6px;outline:none;box-shadow:0 1px 4px rgba(44,62,80,0.07);background:#f7fafd;transition:border-color 0.2s;" />
                <input type="text" maxlength="1" class="code-box" required pattern="[0-9]" style="width:32px;height:32px;font-size:1.2rem;text-align:center;border:1px solid #bcd0ee;border-radius:6px;outline:none;box-shadow:0 1px 4px rgba(44,62,80,0.07);background:#f7fafd;transition:border-color 0.2s;" />
              </div>
              <div class="form-actions" style="width:100%;display:flex;justify-content:center;">
                <button type="submit" class="btn-primary" id="verifyCodeBtn" style="min-width:120px;font-size:1rem;">Verify Code</button>
              </div>
            </form>
          `;
        setupCodeForm();
      }

      function setupCodeForm() {
        // ...existing code...
        const codeBoxes = document.querySelectorAll('.code-box');
        codeBoxes.forEach((box, idx) => {
          box.addEventListener('input', function () {
            if (box.value.length === 1 && idx < codeBoxes.length - 1) {
              codeBoxes[idx + 1].focus();
            }
          });
          box.addEventListener('keydown', function (e) {
            if (e.key === 'Backspace' && box.value === '' && idx > 0) {
              codeBoxes[idx - 1].focus();
            }
          });
        });
        document.getElementById('codeForm').addEventListener('submit', async function (e) {
          e.preventDefault();
          let code = '';
          codeBoxes.forEach(box => code += box.value);
          if (code.length !== 6 || !/^[0-9]{6}$/.test(code)) {
            alert('Please enter the 6-digit code sent to your email.');
            return;
          }
          try {
            const response = await fetch(window.location.origin + '/api/auth/verify-admin-code', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({ email: requestedEmail, code })
            });
            if (response.ok) {
              localStorage.setItem('adminVerifiedEmail', requestedEmail);
              console.log('[register-admin.html] Set adminVerifiedEmail:', localStorage.getItem('adminVerifiedEmail'));
              setTimeout(() => {
                window.location.href = 'register.html';
              }, 300);
            } else {
              const error = await response.text();
              alert(error || 'Invalid or expired code. Please try again.');
            }
          } catch (err) {
            alert('Verification failed. Please try again.');
          }
          // Utility: show alert message above form, then callback
          function showAlert(message, type, callback) {
            // ...existing code...
            // Re-enable request button when email changes
            document.getElementById('email').addEventListener('input', function () {
              document.getElementById('requestAccessBtn').disabled = false;
              this.classList.remove('input-error');
            });
            // Remove any previous alert
            let prev = document.getElementById('customAlert');
            if (prev) prev.remove();
            const alertDiv = document.createElement('div');
            alertDiv.id = 'customAlert';
            alertDiv.className = `alert alert-${type}`;
            alertDiv.style = 'margin-bottom:18px;padding:1rem 1.5rem;border-radius:8px;font-size:1.1rem;text-align:center;background:#eaf6ea;color:#2d3a4a;border:1px solid #bcd0ee;box-shadow:0 2px 8px rgba(44,62,80,0.07);';
            alertDiv.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-triangle' : 'info-circle'}" style="margin-right:8px;"></i> ${message}`;
            loginRight.prepend(alertDiv);
            setTimeout(() => {
              alertDiv.remove();
              if (callback) callback();
            }, 1800);
          }
        });
      }
    </script>
  </body>

</html>