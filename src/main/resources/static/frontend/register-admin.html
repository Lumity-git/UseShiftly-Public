<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Register Admin Account - Shiftly Scheduler</title>
  <link rel="stylesheet" href="style.css">
</head>

<body>

  <body class="login-page">
    <div class="login-container">
      <div class="login-left">
        <div class="logo">üè® Shiftly Scheduler</div>
        <div class="tagline">
          Professional employee scheduling made simple. Streamline your operations with our comprehensive shift
          management system.
        </div>
      </div>
      <div class="login-right">
        <div class="login-header">
          <h2>Register Admin Account</h2>
          <p>Create your admin account for the hotel scheduler. This is a free application for anyone to use.</p>
        </div>
        <form id="adminRegisterForm" class="form-card">
          <div class="form-group">
            <label for="ownerName">Owner Name <span class="required">*</span></label>
            <input type="text" id="ownerName" name="ownerName" required>
          </div>
          <div class="form-group">
            <label for="buildingName">Building/Business Name <span class="required">*</span></label>
            <input type="text" id="buildingName" name="buildingName" required>
          </div>
          <div class="form-group">
            <label for="buildingAddress">Building Address <span class="required">*</span></label>
            <input type="text" id="buildingAddress" name="buildingAddress" required>
          </div>
          <div class="form-group">
            <label for="email">Email <span class="required">*</span></label>
            <input type="email" id="email" name="email" required>
          </div>
          <div class="form-group">
            <label for="password">Password <span class="required">*</span></label>
            <input type="password" id="password" name="password" required minlength="8">
          </div>
          <div class="form-group" style="margin-bottom:0.5em;">
            <input type="checkbox" id="agreeTos" name="agreeTos" style="margin-right:8px;" required>
            <label for="agreeTos" style="display:inline;font-weight:400;">I agree to the <a href="#"
                onclick="openTosModal();return false;">Terms and Conditions</a> and Privacy Policy<span
                class="required">*</span></label>
          </div>
          <div class="form-actions">
            <button type="submit" class="btn-primary" id="registerBtn">Register</button>
          </div>
        </form>
        <div id="tosModal" class="modal" style="display:none;">
          <div class="modal-content">
            <span class="close" onclick="closeTosModal()">&times;</span>
            <h3>Terms of Service</h3>
            <p>By registering, you agree to abide by all local laws and regulations, provide accurate information, and
              use Shiftly Scheduler responsibly. Full terms coming soon.</p>
          </div>
        </div>
      </div>
    </div>
    </main>
    <script>
      // Utility: show alert message above form, then callback
      function showAlert(message, type, callback) {
        // Remove any previous alert
        let prev = document.getElementById('customAlert');
        if (prev) prev.remove();
        const alertDiv = document.createElement('div');
        alertDiv.id = 'customAlert';
        alertDiv.className = `alert alert-${type}`;
        alertDiv.style = 'margin-bottom:18px;padding:1rem 1.5rem;border-radius:8px;font-size:1.1rem;text-align:center;background:#eaf6ea;color:#2d3a4a;border:1px solid #bcd0ee;box-shadow:0 2px 8px rgba(44,62,80,0.07);';
        alertDiv.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : (type === 'error' ? 'exclamation-triangle' : 'info-circle')}" style="margin-right:8px;"></i> ${message}`;
        const loginRight = document.querySelector('.login-right');
        loginRight.prepend(alertDiv);
        setTimeout(() => {
          alertDiv.remove();
          if (callback) callback();
        }, 1800);
      }

      // Real-time email availability check
      let emailCheckTimeout = null;
      document.getElementById('email').addEventListener('input', function () {
        clearTimeout(emailCheckTimeout);
        const emailInput = this;
        const email = emailInput.value.trim();
        emailInput.classList.remove('input-error');
        emailInput.dataset.registered = "false";
        emailInput.dataset.checkerror = "false";
        // Only check if email looks valid
        if (email && /^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(email)) {
          emailCheckTimeout = setTimeout(async () => {
            try {
              const resp = await fetch(window.location.origin + '/api/auth/check-email?email=' + encodeURIComponent(email));
              if (resp.ok) {
                const data = await resp.json();
                if (data.registered) {
                  showAlert('This email is already registered. Please use a different email.', 'error');
                  emailInput.classList.add('input-error');
                  emailInput.dataset.registered = "true";
                }
              }
            } catch (err) {
              showAlert('Unable to check email availability. Please try again later.', 'error');
              emailInput.classList.add('input-error');
              emailInput.dataset.checkerror = "true";
            }
          }, 400);
        }
      });

      const form = document.getElementById('adminRegisterForm');
      const agreeTos = document.getElementById('agreeTos');

      form.addEventListener('submit', async function (e) {
        e.preventDefault();
        if (!agreeTos.checked) {
          showAlert('You must agree to the Terms and Conditions to continue.', 'error');
          return;
        }
        const ownerName = document.getElementById('ownerName').value.trim();
        const buildingName = document.getElementById('buildingName').value.trim();
        const buildingAddress = document.getElementById('buildingAddress').value.trim();
        const email = document.getElementById('email').value.trim();
        const password = document.getElementById('password').value;

        if (!ownerName || !buildingName || !buildingAddress || !email || !password) {
          showAlert('Please fill in all required fields.', 'error');
          return;
        }

        if (password.length < 8) {
          showAlert('Password must be at least 8 characters.', 'error');
          return;
        }

        if (document.getElementById('email').dataset.registered === "true") {
          showAlert('This email is already registered. Please use a different email.', 'error');
          return;
        }

        document.getElementById('registerBtn').disabled = true;
        document.getElementById('registerBtn').textContent = 'Registering...';

        try {
          console.log('Submitting registration request:', {
            ownerName,
            buildingName,
            buildingAddress,
            ownerEmail: email,
            password: password.substring(0, 3) + '***' // Don't log full password
          });
          
          const response = await fetch(window.location.origin + '/api/auth/register-admin', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              ownerName,
              buildingName,
              buildingAddress,
              ownerEmail: email,
              password
            })
          });

          console.log('Registration response status:', response.status);
          console.log('Registration response headers:', Object.fromEntries(response.headers.entries()));

          if (response.ok) {
            const data = await response.json();
            console.log('Registration successful:', data);
            
            // Hide the form and show success message
            document.getElementById('adminRegisterForm').style.display = 'none';
            document.querySelector('.login-header h2').textContent = 'Registration Successful!';
            document.querySelector('.login-header p').textContent = 'Your admin account has been created successfully.';
            
            // Create success content
            const successDiv = document.createElement('div');
            successDiv.id = 'registrationSuccess';
            successDiv.innerHTML = `
              <div style="text-align: center; padding: 2rem;">
                <div style="font-size: 4rem; margin-bottom: 1rem;">‚úÖ</div>
                <h3 style="color: #2d3a4a; margin-bottom: 1rem;">Welcome to Shiftly Scheduler!</h3>
                <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem; text-align: left;">
                  <h4 style="margin-top: 0; color: #2d3a4a;">Account Details:</h4>
                  <p><strong>Owner:</strong> ${ownerName}</p>
                  <p><strong>Building:</strong> ${buildingName}</p>
                  <p><strong>Email:</strong> ${email}</p>
                  <p><strong>Status:</strong> <span style="color: #28a745; font-weight: bold;">Active Admin Account</span></p>
                </div>
                <p style="color: #6c757d; margin-bottom: 1.5rem;">
                  You can now log in with your email and password to manage your scheduling system.
                </p>
                <div style="margin-bottom: 1.5rem;">
                  <button onclick="window.location.href='login.html'" class="btn-primary" style="padding: 12px 24px; font-size: 1.1rem;">
                    Continue to Login
                  </button>
                </div>
                <p style="font-size: 0.9rem; color: #6c757d;">
                  Redirecting to login page in <span id="countdown">5</span> seconds...
                </p>
              </div>
            `;
            
            document.querySelector('.login-right').appendChild(successDiv);
            
            // Countdown timer
            let countdown = 5;
            const countdownElement = document.getElementById('countdown');
            const timer = setInterval(() => {
              countdown--;
              countdownElement.textContent = countdown;
              if (countdown <= 0) {
                clearInterval(timer);
                window.location.href = 'login.html';
              }
            }, 1000);
            
          } else {
            const error = await response.text();
            console.error('Registration failed:', response.status, error);
            showAlert(error || 'Registration failed. Please try again.', 'error');
            document.getElementById('registerBtn').disabled = false;
            document.getElementById('registerBtn').textContent = 'Register';
          }
        } catch (err) {
          console.error('Registration error:', err);
          showAlert('Registration failed. Please try again.', 'error');
          document.getElementById('registerBtn').disabled = false;
          document.getElementById('registerBtn').textContent = 'Register';
        }
      });

      // Enable/disable Register button based on TOS checkbox
      agreeTos.addEventListener('change', function () {
        document.getElementById('registerBtn').disabled = !this.checked;
      });

      function openTosModal() {
        document.getElementById('tosModal').style.display = 'block';
      }
      function closeTosModal() {
        document.getElementById('tosModal').style.display = 'none';
      }
    </script>
  </body>

</html>
