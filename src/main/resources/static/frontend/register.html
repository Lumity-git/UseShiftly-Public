<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Employee Registration - Shiftly Scheduler</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <main class="container registration-container">
        <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
        </div>
        <div id="alertContainer"></div>
        <section class="invitation-info card" id="invitationInfo" style="display: none;">
            <h3><i class="fas fa-envelope-open"></i> Invitation Details</h3>
            <p>You've been invited to join <strong id="buildingName">Grand Hotel</strong> as a <strong id="invitedRole">Employee</strong> in the <strong id="invitedDepartment">Front Desk</strong> department.</p>
            <p>Invited by: <strong id="invitedBy">Manager Name</strong> on <strong id="invitationDate">March 15, 2024</strong></p>
        </section>
        <form id="registrationForm" class="card form-card">
            <input type="hidden" id="invitationCode" name="invitationCode">
            <input type="hidden" id="invitationToken" name="invitationToken">
            <div class="dashboard-grid">
                <div>
                    <!-- Personal Information -->
                    <section class="form-section">
                        <h3><i class="fas fa-user"></i> Personal Info</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="firstName">First Name <span class="required" style="color:#e74c3c">*</span></label>
                                <input type="text" id="firstName" name="firstName" required>
                            </div>
                            <div class="form-group">
                                <label for="lastName">Last Name <span class="required" style="color:#e74c3c">*</span></label>
                                <input type="text" id="lastName" name="lastName" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="email">Email <span class="required" style="color:#e74c3c">*</span></label>
                                <input type="email" id="email" name="email" required readonly>
                            </div>
                            <div class="form-group">
                                <label for="phone">Phone <span class="required" style="color:#e74c3c">*</span></label>
                                <input type="tel" id="phone" name="phone" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="dateOfBirth">DOB <span class="required" style="color:#e74c3c">*</span></label>
                                <input type="date" id="dateOfBirth" name="dateOfBirth" required>
                            </div>
                            <div class="form-group">
                                <label for="address">Address <span class="required" style="color:#e74c3c">*</span></label>
                                <textarea id="address" name="address" placeholder="Street address, city, state, ZIP code" required></textarea>
                            </div>
                        </div>
                    </section>
                    <!-- Emergency Contact -->
                    <section class="form-section">
                        <h3><i class="fas fa-phone"></i> Emergency Contact</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="emergencyName">Contact Name <span class="required" style="color:#e74c3c">*</span></label>
                                <input type="text" id="emergencyName" name="emergencyName" required>
                            </div>
                            <div class="form-group">
                                <label for="emergencyRelation">Relationship <span class="required" style="color:#e74c3c">*</span></label>
                                <select id="emergencyRelation" name="emergencyRelation" required>
                                    <option value="">Select relationship</option>
                                    <option value="spouse">Spouse</option>
                                    <option value="parent">Parent</option>
                                    <option value="sibling">Sibling</option>
                                    <option value="child">Child</option>
                                    <option value="friend">Friend</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="emergencyPhone">Emergency Phone <span class="required" style="color:#e74c3c">*</span></label>
                            <input type="tel" id="emergencyPhone" name="emergencyPhone" required>
                        </div>
                    </section>
                </div>
                <div>
                    <!-- Account Setup -->
                    <section class="form-section">
                        <h3><i class="fas fa-key"></i> Account Setup</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="password">Password <span class="required" style="color:#e74c3c">*</span></label>
                                <input type="password" id="password" name="password" required minlength="8" autocomplete="new-password">
                                <small class="form-hint">Min 8 chars, include uppercase, lowercase, number, special</small>
                            </div>
                            <div class="form-group">
                                <label for="confirmPassword">Confirm Password <span class="required" style="color:#e74c3c">*</span></label>
                                <input type="password" id="confirmPassword" name="confirmPassword" required autocomplete="new-password">
                            </div>
                        </div>
                    </section>
                </div>
            </div>
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="goBack()">
                    <i class="fas fa-arrow-left"></i> Cancel
                </button>
                <button type="submit" class="btn btn-primary" id="submitBtn" disabled>
                    <i class="fas fa-user-plus"></i> Complete Registration
                </button>
            </div>
        </form>
    </main>

    <script>
        let invitationData = null;
        let uploadedFiles = {};

        document.addEventListener('DOMContentLoaded', async function() {
            // Debug logs
            console.log('---[register.html debug]---');
            console.log('window.location.href:', window.location.href);
            console.log('localStorage.adminVerifiedEmail:', localStorage.getItem('adminVerifiedEmail'));
            const isAuthenticated = await checkAuth();
            console.log('isAuthenticated:', isAuthenticated);
            if (!isAuthenticated) return;
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const token = urlParams.get('token');
            console.log('code:', code, 'token:', token);
            let adminEmail = localStorage.getItem('adminVerifiedEmail');
            let isAdminMode = !code && !token && adminEmail;
            // Fallback: if form is hidden and adminVerifiedEmail is set, force admin mode
            if (!isAdminMode && adminEmail) {
                isAdminMode = true;
                console.log('[register.html fallback] Forcing admin mode due to adminVerifiedEmail present.');
            }
            console.log('isAdminMode:', isAdminMode, 'adminEmail:', adminEmail);
            if (isAdminMode) {
                // Always show registration form for admin
                document.getElementById('registrationForm').style.display = '';
                setupAdminRegistration(adminEmail);
            } else if (code && token) {
                validateInvitation();
            } else {
                // If neither mode, show error
                console.log('Registration error: Invalid registration link or session.');
                disablePage('Invalid registration link or session. Please use a valid invitation or admin code.');
            }
            setupEventListeners();
            updateProgress();
        });

        async function checkAuth() {
            const token = localStorage.getItem('authToken');
            const userInfo = localStorage.getItem('userInfo');
            if (!token || !userInfo) {
                return true; // Allow registration if not logged in
            }
            try {
                const response = await fetch(`${API_BASE_URL}/auth/validate`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                if (response.status === 401) {
                    // Try to refresh token if backend supports
                    const refreshResponse = await fetch(`${API_BASE_URL}/auth/refresh`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    });
                    if (refreshResponse.ok) {
                        const data = await refreshResponse.json();
                        if (data.token) {
                            localStorage.setItem('authToken', data.token);
                            if (data.userInfo) {
                                localStorage.setItem('userInfo', JSON.stringify(data.userInfo));
                            }
                            return true;
                        }
                    }
                    localStorage.removeItem('authToken');
                    localStorage.removeItem('userInfo');
                    return true;
                }
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                if (data.token) {
                    localStorage.setItem('authToken', data.token);
                }
                if (data.userInfo) {
                    localStorage.setItem('userInfo', JSON.stringify(data.userInfo));
                }
                return true;
            } catch (error) {
                console.error('Auth validation failed:', error);
                localStorage.removeItem('authToken');
                localStorage.removeItem('userInfo');
                return true;
            }
        }

        function togglePanel(panelId) {
            const panel = document.getElementById(panelId);
            if (panel.style.display === 'none' || panel.style.display === '') {
                panel.style.display = 'block';
            } else {
                panel.style.display = 'none';
            }
        }

        function validateInvitation() {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const token = urlParams.get('token');
            const registrationForm = document.getElementById('registrationForm');
            if (!code || !token) {
                registrationForm.style.display = 'none';
                document.getElementById('invitationInfo').style.display = 'none';
                return;
            }
            // Validate invitation code
            validateInvitationCode(code, token);
        }

        function setupAdminRegistration() {
            // Hide invitation info section
            document.getElementById('invitationInfo').style.display = 'none';
            // Show registration form
            const registrationForm = document.getElementById('registrationForm');
            registrationForm.style.display = '';
            // Hide invitationCode and invitationToken fields
            document.getElementById('invitationCode').value = '';
            document.getElementById('invitationToken').value = '';
            // Set email field from adminVerifiedEmail and make it editable
            if (document.getElementById('email')) {
                document.getElementById('email').value = arguments[0] || '';
                document.getElementById('email').readOnly = false;
            }
        }

        const API_BASE_URL = window.location.origin + '/api';

        async function validateInvitationCode(code, token) {
    try {
        const response = await fetch(`${API_BASE_URL}/auth/validate-invitation?code=${encodeURIComponent(code)}&token=${encodeURIComponent(token)}`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        const registrationForm = document.getElementById('registrationForm');
        if (response.ok) {
            invitationData = await response.json();
            displayInvitationInfo();
            if (document.getElementById('invitationCode')) document.getElementById('invitationCode').value = code;
            if (document.getElementById('invitationToken')) document.getElementById('invitationToken').value = invitationData.invitationToken || token;
            if (document.getElementById('email')) {
                document.getElementById('email').value = invitationData.email || '';
                document.getElementById('email').readOnly = true;
            }
            if (registrationForm) registrationForm.style.display = '';
        } else {
            const error = await response.text();
            disablePage(error || 'Invalid or expired invitation. Please contact your manager.');
        }
    } catch (error) {
        console.error('Error validating invitation:', error);
        disablePage('Unable to validate invitation. Please contact your manager for a valid invitation.');
    }
}
        function displayInvitationInfo() {
            document.getElementById('buildingName').textContent = invitationData.buildingName;
            document.getElementById('invitedRole').textContent = invitationData.role;
            document.getElementById('invitedDepartment').textContent = invitationData.departmentName;
            document.getElementById('invitedBy').textContent = invitationData.invitedBy;
            document.getElementById('invitationDate').textContent = new Date(invitationData.invitationDate).toLocaleDateString();
            document.getElementById('invitationInfo').style.display = 'block';
        }

        function setupEventListeners() {
            // Defensive: only add listeners if elements exist
            const passwordInput = document.getElementById('password');
            if (passwordInput) passwordInput.addEventListener('input', validatePassword);
            const confirmPasswordInput = document.getElementById('confirmPassword');
            if (confirmPasswordInput) confirmPasswordInput.addEventListener('input', validatePasswordMatch);
            const phoneInput = document.getElementById('phone');
            if (phoneInput) phoneInput.addEventListener('input', formatPhoneNumber);
            const emergencyPhoneInput = document.getElementById('emergencyPhone');
            if (emergencyPhoneInput) emergencyPhoneInput.addEventListener('input', formatPhoneNumber);
            const registrationForm = document.getElementById('registrationForm');
            if (registrationForm) {
                registrationForm.addEventListener('input', validateForm);
                registrationForm.addEventListener('change', validateForm);
                registrationForm.addEventListener('submit', function(event) {
                    event.preventDefault();
                    handleSubmit(event);
                });
            }
        }

        function handleFileUpload(input, listId) {
            const file = input.files[0];
            const listContainer = document.getElementById(listId);
            
            if (file) {
                // Validate file
                if (!validateFile(file)) {
                    input.value = '';
                    return;
                }

                uploadedFiles[input.name] = file;
                
                listContainer.innerHTML = `
                    <div class="file-item">
                        <span><i class="fas fa-file"></i> ${file.name} (${formatFileSize(file.size)})</span>
                        <button type="button" onclick="removeFile('${input.name}', '${listId}')" style="background: none; border: none; color: #dc3545; cursor: pointer;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
            }
            updateProgress();
        }

        function validateFile(file) {
            const maxSize = 5 * 1024 * 1024; // 5MB
            const allowedTypes = ['application/pdf', 'image/jpeg', 'image/jpg', 'image/png'];

            if (file.size > maxSize) {
                showAlert('File size must be less than 5MB.', 'error');
                return false;
            }

            if (!allowedTypes.includes(file.type)) {
                showAlert('Only PDF, JPG, and PNG files are allowed.', 'error');
                return false;
            }

            return true;
        }

        function removeFile(fileName, listId) {
            delete uploadedFiles[fileName];
            document.getElementById(listId).innerHTML = '';
            document.querySelector(`[name="${fileName}"]`).value = '';
            updateProgress();
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function formatPhoneNumber(event) {
            let value = event.target.value.replace(/\D/g, '');
            if (value.length >= 6) {
                value = value.replace(/(\d{3})(\d{3})(\d{4})/, '($1) $2-$3');
            } else if (value.length >= 3) {
                value = value.replace(/(\d{3})(\d{3})/, '($1) $2');
            }
            event.target.value = value;
        }


        function validatePassword() {
            const password = document.getElementById('password').value;
            const minLength = password.length >= 8;
            const hasUpper = /[A-Z]/.test(password);
            const hasLower = /[a-z]/.test(password);
            const hasNumber = /\d/.test(password);
            const hasSpecial = /[!@#$%^&*(),.?":{}|<>]/.test(password);

            const isValid = minLength && hasUpper && hasLower && hasNumber && hasSpecial;
            
            const input = document.getElementById('password');
            if (password && !isValid) {
                input.style.borderColor = '#dc3545';
            } else {
                input.style.borderColor = '#ddd';
            }

            validatePasswordMatch();
            return isValid;
        }

        function validatePasswordMatch() {
            const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const input = document.getElementById('confirmPassword');

            if (confirmPassword && password !== confirmPassword) {
                input.style.borderColor = '#dc3545';
                return false;
            } else {
                input.style.borderColor = '#ddd';
                return true;
            }
        }

        function validateForm() {
            const form = document.getElementById('registrationForm');
            const requiredFields = form.querySelectorAll('[required]');
            const checkboxes = form.querySelectorAll('input[type="checkbox"][required]');
            
            let allValid = true;

            // Check required fields
            requiredFields.forEach(field => {
                if (field.type === 'checkbox') {
                    if (!field.checked) allValid = false;
                } else if (field.type === 'file') {
                    if (!uploadedFiles[field.name]) allValid = false;
                } else {
                    if (!field.value.trim()) allValid = false;
                }
            });

            // Check password validation
            if (!validatePassword() || !validatePasswordMatch()) {
                allValid = false;
            }

            document.getElementById('submitBtn').disabled = !allValid;
            updateProgress();
        }

        function updateProgress() {
            const form = document.getElementById('registrationForm');
            const requiredFields = form.querySelectorAll('[required]');
            let completedFields = 0;

            requiredFields.forEach(field => {
                if (field.type === 'checkbox') {
                    if (field.checked) completedFields++;
                } else if (field.type === 'file') {
                    if (uploadedFiles[field.name]) completedFields++;
                } else {
                    if (field.value.trim()) completedFields++;
                }
            });

            const progress = (completedFields / requiredFields.length) * 100;
            document.getElementById('progressFill').style.width = progress + '%';
        }

        async function handleSubmit(event) {
            // Validate and highlight missing fields
            const form = document.getElementById('registrationForm');
            const requiredFields = form.querySelectorAll('[required]');
            let allValid = true;
            requiredFields.forEach(field => {
                field.style.borderColor = '#ddd';
                if (field.type === 'checkbox') {
                    if (!field.checked) {
                        allValid = false;
                        field.focus();
                        field.parentElement.style.boxShadow = '0 0 0 2px #e74c3c';
                    } else {
                        field.parentElement.style.boxShadow = '';
                    }
                } else if (field.type === 'file') {
                    if (!uploadedFiles[field.name]) {
                        allValid = false;
                        field.parentElement.style.boxShadow = '0 0 0 2px #e74c3c';
                    } else {
                        field.parentElement.style.boxShadow = '';
                    }
                } else {
                    if (!field.value.trim()) {
                        allValid = false;
                        field.style.borderColor = '#e74c3c';
                        field.focus();
                    }
                }
            });

            if (!validatePassword() || !validatePasswordMatch()) {
                allValid = false;
                document.getElementById('password').style.borderColor = '#e74c3c';
                document.getElementById('confirmPassword').style.borderColor = '#e74c3c';
            }

            // Debug: log all field values and registration mode
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const token = urlParams.get('token');
            const adminEmail = localStorage.getItem('adminVerifiedEmail');
            const isAdminMode = !code && !token && adminEmail;
            console.log('[handleSubmit] isAdminMode:', isAdminMode, 'adminEmail:', adminEmail);
            console.log('[handleSubmit] code:', code, 'token:', token);
            console.log('[handleSubmit] form values:', {
                firstName: document.getElementById('firstName').value,
                lastName: document.getElementById('lastName').value,
                email: document.getElementById('email').value,
                phone: document.getElementById('phone').value,
                dateOfBirth: document.getElementById('dateOfBirth').value,
                address: document.getElementById('address').value,
                emergencyName: document.getElementById('emergencyName').value,
                emergencyRelation: document.getElementById('emergencyRelation').value,
                emergencyPhone: document.getElementById('emergencyPhone').value
            });

            if (!allValid) {
                showAlert('Please complete all required fields before submitting.', 'error');
                var loadingOverlay = document.getElementById('loadingOverlay');
                if (loadingOverlay && loadingOverlay.style) loadingOverlay.style.display = 'none';
                return;
            }

            var loadingOverlay = document.getElementById('loadingOverlay');
            if (loadingOverlay && loadingOverlay.style) loadingOverlay.style.display = 'flex';

            try {
                const formData = new FormData();
                const inputs = form.querySelectorAll('input, select, textarea');
                inputs.forEach(input => {
                    if (input.type === 'file') {
                        if (uploadedFiles[input.name]) {
                            formData.append(input.name, uploadedFiles[input.name]);
                        }
                    } else if (input.type === 'checkbox') {
                        formData.append(input.name, input.checked);
                    } else if (input.name === 'invitationToken' || input.name === 'invitationCode') {
                        // Skip hidden input, will set below
                    } else if (input.name === 'emergencyName') {
                        formData.append('emergencyContactName', input.value);
                    } else if (input.name === 'emergencyRelation') {
                        formData.append('emergencyContactRelation', input.value);
                    } else if (input.name === 'emergencyPhone') {
                        formData.append('emergencyContactPhone', input.value);
                    } else {
                        formData.append(input.name, input.value);
                    }
                });

                if (!isAdminMode) {
                    // Employee registration: set invitationCode and invitationToken
                    const invitationCodeValue = (invitationData && invitationData.invitationCode) ? invitationData.invitationCode : document.getElementById('invitationCode').value;
                    const invitationTokenValue = (invitationData && invitationData.invitationToken) ? invitationData.invitationToken : document.getElementById('invitationToken').value;
                    formData.append('invitationCode', invitationCodeValue);
                    formData.append('invitationToken', invitationTokenValue);
                } else {
                    // Admin registration: remove invitation fields, add admin flag
                    formData.append('adminRegistration', 'true');
                    // Always send the email field for admin registration
                    formData.set('email', document.getElementById('email').value);
                }

                const response = await fetch(`${API_BASE_URL}/auth/register`, {
                    method: 'POST',
                    body: formData,
                    credentials: 'omit'
                });

                if (response.ok) {
                    const container = document.getElementById('alertContainer');
                    container.innerHTML = '';
                    showAlert('Account created successfully! Redirecting to login...', 'success');
                    container.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    if (!isAdminMode) {
                        try {
                            const code = document.getElementById('invitationCode').value;
                            let savedInvites = JSON.parse(localStorage.getItem('invitationLinks') || '[]');
                            savedInvites = savedInvites.filter(link => !link.includes(code));
                            localStorage.setItem('invitationLinks', JSON.stringify(savedInvites));
                        } catch (e) {}
                    } else {
                        localStorage.removeItem('adminVerifiedEmail');
                    }
                    setTimeout(() => {
                        window.location.href = 'login.html';
                    }, 2500);
                } else {
                    const error = await response.text();
                    showAlert(error || 'Registration failed. Please try again.', 'error');
                }
            } catch (error) {
                console.error('Registration error:', error);
                showAlert('Registration failed. Please try again.', 'error');
            } finally {
                var loadingOverlay = document.getElementById('loadingOverlay');
                if (loadingOverlay && loadingOverlay.style) loadingOverlay.style.display = 'none';
            }
        }

        function showAlert(message, type) {
            const container = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-triangle' : 'info-circle'}"></i> ${message}`;
            container.appendChild(alert);
            setTimeout(() => {
                if (container.contains(alert)) {
                    container.removeChild(alert);
                }
            }, 8000);
        }

        function disablePage(message) {
            // Hide registration container
            const regContainer = document.querySelector('.registration-container');
            if (regContainer) regContainer.style.display = 'none';
            // Show full-page error
            const errorDiv = document.createElement('div');
            errorDiv.style.position = 'fixed';
            errorDiv.style.top = '0';
            errorDiv.style.left = '0';
            errorDiv.style.width = '100vw';
            errorDiv.style.height = '100vh';
            errorDiv.style.display = 'flex';
            errorDiv.style.alignItems = 'center';
            errorDiv.style.justifyContent = 'center';
            errorDiv.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
            errorDiv.innerHTML = `<div style="background:rgba(255,255,255,0.97);padding:2.5rem 2.5rem;border-radius:18px;box-shadow:0 10px 30px rgba(0,0,0,0.13);text-align:center;max-width:500px;"><i class='fas fa-exclamation-triangle' style='font-size:2.5rem;color:#e74c3c;'></i><h2 style='color:#e74c3c;margin:1rem 0;'>Registration Error</h2><p style='color:#333;font-size:1.15rem;'>${message}</p></div>`;
            document.body.appendChild(errorDiv);
        }

        function goBack() {
            if (confirm('Are you sure you want to cancel registration? All entered data will be lost.')) {
                window.location.href = 'login.html';
            }
        }
    </script>
</body>
</html>
