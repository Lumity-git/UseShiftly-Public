<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Shiftly Scheduler - Login</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body class="login-page">
    <div class="login-container">
      <div class="login-left">
        <div class="logo">üè® Shiftly Scheduler</div>
        <div class="tagline">
          Professional employee scheduling made simple. Streamline your
          operations with our comprehensive shift management system.
        </div>
      </div>

      <div class="login-right">
        <div class="login-header">
          <h2>Welcome Back</h2>
          <p>Sign in to access your dashboard</p>
        </div>

        <div id="alert" class="alert"></div>

        <form id="loginForm">
          <div class="form-group">
            <label for="email">Email Address</label>
            <input
              type="email"
              id="email"
              name="email"
              required
              placeholder="Enter your email address"
            />
          </div>

          <div class="form-group">
            <label for="password">Password</label>
            <input
              type="password"
              id="password"
              name="password"
              required
              placeholder="Enter your password"
            />
          </div>

          <button type="submit" class="login-btn" id="loginBtn">Sign In</button>
        </form>

        <div class="loading" id="loading">
          <div class="spinner"></div>
          <span>Signing you in...</span>
        </div>
      </div>
    </div>

    <script>
      // Always clear localStorage on login page load to prevent stale tokens
      localStorage.removeItem("authToken");
      localStorage.removeItem("userInfo");
      const API_BASE_URL = window.location.origin + "/api";

      // Form elements
      const loginForm = document.getElementById("loginForm");
      const emailInput = document.getElementById("email");
      const passwordInput = document.getElementById("password");
      const loginBtn = document.getElementById("loginBtn");
      const alertDiv = document.getElementById("alert");
      const loadingDiv = document.getElementById("loading");

      // Fill credentials for demo accounts
      function fillCredentials(email, password) {
        emailInput.value = email;
        passwordInput.value = password;
        hideAlert();
      }

      // Show alert message
      function showAlert(message, type = "error") {
        alertDiv.textContent = message;
        alertDiv.className = `alert ${type}`;
        alertDiv.style.display = "block";
      }

      // Hide alert message
      function hideAlert() {
        alertDiv.style.display = "none";
      }

      // Show loading state
      function showLoading() {
        loginBtn.style.display = "none";
        loadingDiv.style.display = "block";
      }

      // Hide loading state
      function hideLoading() {
        loginBtn.style.display = "block";
        loadingDiv.style.display = "none";
      }

      // Handle form submission
      loginForm.addEventListener("submit", async (e) => {
        e.preventDefault();

        const email = emailInput.value.trim();
        const password = passwordInput.value.trim();

        if (!email || !password) {
          showAlert("Please fill in all fields");
          return;
        }

        showLoading();
        hideAlert();

        try {
          const response = await fetch(`${API_BASE_URL}/auth/login`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              email: email,
              password: password,
            }),
          });

          const data = await response.json();

          if (response.ok) {
            // Prepare user info object with all details, including id
            const userInfo = {
              id: data.id,
              email: data.email,
              firstName: data.firstName,
              lastName: data.lastName,
              role: data.role,
              buildingId: data.buildingId,
              buildingName: data.buildingName,
              mustChangePassword: data.mustChangePassword
            };
            // Check if mustChangePassword is true
            if (
              data.mustChangePassword === true ||
              data.mustChangePassword === "true"
            ) {
              localStorage.setItem("authToken", data.token);
              localStorage.setItem("userInfo", JSON.stringify(userInfo));
              showAlert(
                "You must change your password before continuing.",
                "error"
              );
              setTimeout(() => {
                window.location.href = "/frontend/change-password.html";
              }, 1200);
              return;
            }
            // Store token and user info
            localStorage.setItem("authToken", data.token);
            localStorage.setItem("userInfo", JSON.stringify(userInfo));

            showAlert(`Welcome back, ${data.firstName}!`, "success");
            // Redirect based on user role after short delay
            setTimeout(() => {
              if (data.role === "EMPLOYEE") {
                window.location.href = "/frontend/employee-dashboard.html";
              } else {
                window.location.href = "/frontend/dashboard.html";
              }
            }, 1500);
          } else {
            showAlert(data.message || "Invalid email or password");
          }
        } catch (error) {
          console.error("Login error:", error);
          showAlert("Unable to connect to server. Please try again.");
        } finally {
          hideLoading();
        }
      });

      // Clear alert when user starts typing
      emailInput.addEventListener("input", hideAlert);
      passwordInput.addEventListener("input", hideAlert);

      // Check if user is already logged in
      if (localStorage.getItem("authToken")) {
        const userInfo = JSON.parse(localStorage.getItem("userInfo") || "{}");
        showAlert(
          `You're already logged in as ${userInfo.firstName || "User"}`,
          "success"
        );
        setTimeout(() => {
          if (userInfo.role === "EMPLOYEE") {
            window.location.href = "/frontend/employee-dashboard.html";
          } else {
            window.location.href = "/frontend/dashboard.html";
          }
        }, 2000);
      }

      // Focus on email field when page loads
      window.addEventListener("load", () => {
        emailInput.focus();
      });
    </script>
  </body>
</html>
