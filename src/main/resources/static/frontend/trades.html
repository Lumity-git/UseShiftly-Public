<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shift Trading - Shiftly Scheduler</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div id="headerContainer"></div>
    <script src="nav-manager.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", function() {
        fetch("header.html")
          .then(res => res.text())
          .then(html => {
            document.getElementById("headerContainer").innerHTML = html;
            renderNavLinks("trades.html");
            initTradesPage();
          });
      });
    </script>
    <div class="container">
        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('my-trades')">
                <i class="fas fa-user"></i> My Trades
            </button>
            <button class="tab-btn" onclick="switchTab('available-trades')">
                <i class="fas fa-shopping-cart"></i> Available Trades
            </button>
            <button class="tab-btn" onclick="switchTab('pending-approval')" id="pendingTab" style="display: none;">
                <i class="fas fa-clock"></i> Pending Approval
            </button>
        </div>

        <div class="filters">
            <div class="filter-group">
                <label>Status</label>
                <select id="statusFilter" onchange="applyFilters()">
                    <option value="">All Statuses</option>
                    <option value="PENDING">Pending</option>
                    <option value="APPROVED">Approved</option>
                    <option value="REJECTED">Rejected</option>
                    <option value="COMPLETED">Completed</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Department</label>
                <select id="departmentFilter" onchange="applyFilters()">
                    <option value="">All Departments</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Date From</label>
                <input type="date" id="dateFromFilter" onchange="applyFilters()">
            </div>
            <div class="filter-group">
                <label>Date To</label>
                <input type="date" id="dateToFilter" onchange="applyFilters()">
            </div>
            <div class="filter-group">
                <label></label>
                <button class="btn btn-primary" onclick="clearFilters()">
                    <i class="fas fa-times"></i> Clear Filters
                </button>
            </div>
        </div>

        <!-- My Trades Tab -->
        <div id="my-trades" class="tab-content active">
            <div id="myTradesList">
                <div class="no-data">
                    <i class="fas fa-spinner fa-spin"></i>
                    <p>Loading your trades...</p>
                </div>
            </div>
        </div>

        <!-- Available Trades Tab -->
        <div id="available-trades" class="tab-content">
            <div id="availableTradesList">
                <div class="no-data">
                    <i class="fas fa-spinner fa-spin"></i>
                    <p>Loading available trades...</p>
                </div>
            </div>
        </div>

        <!-- Pending Approval Tab -->
        <div id="pending-approval" class="tab-content">
            <div id="pendingApprovalList">
                <div class="no-data">
                    <i class="fas fa-spinner fa-spin"></i>
                    <p>Loading pending approvals...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Trade Request Button -->
    <button class="create-trade-btn" onclick="openCreateTradeModal()" title="Create Trade Request">
        <i class="fas fa-plus"></i>
    </button>

    <!-- Create Trade Modal -->
    <div id="createTradeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-plus"></i> Create Trade Request</h2>
                <button class="close-btn" onclick="closeCreateTradeModal()">&times;</button>
            </div>
            <form id="createTradeForm">
                <div class="form-group">
                    <label for="shiftSelect">Select Shift to Trade</label>
                    <select id="shiftSelect" required>
                        <option value="">Select a shift...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="tradeReason">Reason for Trade</label>
                    <textarea id="tradeReason" placeholder="Please provide a reason for this trade request..." required></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeCreateTradeModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Trade Request</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let currentUser = null;
        let allTrades = [];
        let myTrades = [];
        let availableTrades = [];
        let pendingApprovals = [];
        let departments = [];
        let myShifts = [];

        // Check authentication and load data after header loads
        async function initTradesPage() {
            const isAuthenticated = await checkAuth();
            if (!isAuthenticated) return;
        }

        async function checkAuth() {
            const token = localStorage.getItem('authToken');
            const user = localStorage.getItem('userInfo');
            
            if (!token || !user) {
                window.location.href = 'login.html';
                return false;
            }

            let userObj = JSON.parse(user);
            // Redirect employees to their own trades page
            if (userObj.role === 'EMPLOYEE') {
                window.location.href = 'employee-trades.html';
                return false;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/auth/validate`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                if (response.status === 401) {
                    // Try to refresh token if backend supports
                    const refreshResponse = await fetch(`${API_BASE_URL}/auth/refresh`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    });
                    if (refreshResponse.ok) {
                        const data = await refreshResponse.json();
                        if (data.token) {
                            localStorage.setItem('authToken', data.token);
                            if (data.userInfo) {
                                localStorage.setItem('userInfo', JSON.stringify(data.userInfo));
                                userObj = data.userInfo;
                            }
                            // Check role after refresh
                            if (userObj.role === 'EMPLOYEE') {
                                window.location.href = 'employee-trades.html';
                                return false;
                            }
                            if (userObj.role === 'MANAGER' || userObj.role === 'ADMIN') {
                                document.getElementById('pendingTab').style.display = 'block';
                            }
                            currentUser = userObj;
                            document.getElementById('userName').textContent = currentUser.firstName + ' ' + currentUser.lastName;
    
                            loadData();
                            return true;
                        }
                    }
                    localStorage.removeItem('authToken');
                    localStorage.removeItem('userInfo');
                    window.location.href = 'login.html';
                    return false;
                }
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                if (data.token) {
                    localStorage.setItem('authToken', data.token);
                }
                if (data.userInfo) {
                    localStorage.setItem('userInfo', JSON.stringify(data.userInfo));
                    userObj = data.userInfo;
                }
                // Check role
                if (userObj.role === 'EMPLOYEE') {
                    window.location.href = 'employee-trades.html';
                    return false;
                }
                if (userObj.role === 'MANAGER' || userObj.role === 'ADMIN') {
                    document.getElementById('pendingTab').style.display = 'block';
                }
                currentUser = userObj;
                document.getElementById('userName').textContent = currentUser.firstName + ' ' + currentUser.lastName;
                loadData();
                return true;
            } catch (error) {
                console.error('Auth validation failed:', error);
                localStorage.removeItem('authToken');
                localStorage.removeItem('userInfo');
                window.location.href = 'login.html';
                return false;
            }
        }


        async function loadData() {
            await Promise.all([
                loadTrades(),
                loadDepartments(),
                loadMyShifts()
            ]);
        }

        // Update API endpoints to match ShiftController
        const API_BASE_URL = window.location.origin + '/api';

        async function loadTrades() {
            try {
                const token = localStorage.getItem('authToken');
                // Use /api/shifts/trades for all trades
                const response = await fetch(`${API_BASE_URL}/shifts/trades`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    if (!Array.isArray(data)) {
                        showError('Invalid trades data received');
                        allTrades = [];
                    } else {
                        allTrades = data;
                    }
                    filterTrades();
                } else {
                    showError('Failed to load trades');
                    allTrades = [];
                    filterTrades();
                }
            } catch (error) {
                console.error('Error loading trades:', error);
                showError('Error loading trades');
                allTrades = [];
                filterTrades();
            }
        }

        async function loadDepartments() {
            try {
                const token = localStorage.getItem('authToken');
                // Use /api/departments for departments
                const response = await fetch(`${API_BASE_URL}/departments`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    departments = await response.json();
                    populateDepartmentFilter();
                }
            } catch (error) {
                console.error('Error loading departments:', error);
            }
        }

        async function loadMyShifts() {
            try {
                const token = localStorage.getItem('authToken');
                // Use /api/shifts/my-shifts for user's shifts
                const response = await fetch(`${API_BASE_URL}/shifts/my-shifts`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    myShifts = await response.json();
                    populateShiftSelect();
                }
            } catch (error) {
                console.error('Error loading shifts:', error);
            }
        }

        function filterTrades() {
            // Defensive: skip undefined trades and nested objects
            // Backend now returns ShiftTradeResponse DTOs, so adapt accordingly
            const safeTrades = Array.isArray(allTrades) ? allTrades.filter(trade => trade && trade.shiftId) : [];
            if (currentUser.role === 'MANAGER' || currentUser.role === 'ADMIN') {
                myTrades = safeTrades.filter(trade => trade.requestingEmployeeId === currentUser.id || trade.pickupEmployeeId === currentUser.id);
                // Show all trades with status AVAILABLE_FOR_PICKUP, except those posted by the current user
                availableTrades = safeTrades.filter(trade => trade.status === 'AVAILABLE_FOR_PICKUP' && trade.requestingEmployeeId !== currentUser.id);
                // Pending approval: show all trades with status PENDING_APPROVAL and a pickupEmployeeId
                pendingApprovals = safeTrades.filter(trade => trade.status === 'PENDING_APPROVAL' && trade.pickupEmployeeId);
            } else {
                myTrades = safeTrades.filter(trade => trade.requestingEmployeeId === currentUser.id || trade.pickupEmployeeId === currentUser.id);
                availableTrades = safeTrades.filter(trade => trade.status === 'AVAILABLE_FOR_PICKUP' && trade.requestingEmployeeId !== currentUser.id);
                pendingApprovals = [];
            }
            displayTrades();
        }

        function displayTrades() {
            displayMyTrades();
            displayAvailableTrades();
            if (currentUser.role === 'MANAGER' || currentUser.role === 'ADMIN') {
                displayPendingApprovals();
            }
        }

        function displayMyTrades() {
            const container = document.getElementById('myTradesList');
            if (myTrades.length === 0) {
                container.innerHTML = `
                    <div class="no-data">
                        <i class="fas fa-exchange-alt"></i>
                        <p>No trade requests found</p>
                    </div>
                `;
                return;
            }
            container.innerHTML = '';
            const batchSize = 20;
            let i = 0;
            function renderBatch() {
                const end = Math.min(i + batchSize, myTrades.length);
                for (; i < end; i++) {
                    const cardHtml = createTradeCard(myTrades[i], 'my');
                    const div = document.createElement('div');
                    div.innerHTML = cardHtml;
                    // Flatten if cardHtml is a single root
                    while (div.firstChild) container.appendChild(div.firstChild);
                }
                if (i < myTrades.length) {
                    setTimeout(renderBatch, 0);
                }
            }
            renderBatch();
        }

        function displayAvailableTrades() {
            const container = document.getElementById('availableTradesList');
            if (availableTrades.length === 0) {
                container.innerHTML = `
                    <div class="no-data">
                        <i class="fas fa-shopping-cart"></i>
                        <p>No available trades at the moment</p>
                    </div>
                `;
                return;
            }
            container.innerHTML = '';
            const batchSize = 20;
            let i = 0;
            function renderBatch() {
                const end = Math.min(i + batchSize, availableTrades.length);
                for (; i < end; i++) {
                    const cardHtml = createTradeCard(availableTrades[i], 'available');
                    const div = document.createElement('div');
                    div.innerHTML = cardHtml;
                    while (div.firstChild) container.appendChild(div.firstChild);
                }
                if (i < availableTrades.length) {
                    setTimeout(renderBatch, 0);
                }
            }
            renderBatch();
        }

        function displayPendingApprovals() {
            const container = document.getElementById('pendingApprovalList');
            if (pendingApprovals.length === 0) {
                container.innerHTML = `
                    <div class="no-data">
                        <i class="fas fa-clock"></i>
                        <p>No trades pending approval</p>
                    </div>
                `;
                return;
            }
            container.innerHTML = '';
            const batchSize = 20;
            let i = 0;
            function renderBatch() {
                const end = Math.min(i + batchSize, pendingApprovals.length);
                for (; i < end; i++) {
                    const cardHtml = createTradeCard(pendingApprovals[i], 'approval');
                    const div = document.createElement('div');
                    div.innerHTML = cardHtml;
                    while (div.firstChild) container.appendChild(div.firstChild);
                }
                if (i < pendingApprovals.length) {
                    setTimeout(renderBatch, 0);
                }
            }
            renderBatch();
        }

        function createTradeCard(trade, context) {
            // Adapt to ShiftTradeResponse DTO
            const isOwner = trade.requestingEmployeeId === currentUser.id;
            const isPickup = trade.pickupEmployeeId === currentUser.id;
            // Map backend enums to display text and CSS class
            let statusText = '';
            let statusClass = '';
            switch (trade.status) {
                case 'AVAILABLE_FOR_PICKUP':
                    statusText = 'Available for Pickup';
                    statusClass = 'status-available';
                    break;
                case 'ACCEPTED':
                    statusText = 'Accepted';
                    statusClass = 'status-accepted';
                    break;
                case 'DENIED':
                    statusText = 'Denied';
                    statusClass = 'status-denied';
                    break;
                case 'PENDING_APPROVAL':
                    statusText = 'Pending Approval by Manager';
                    statusClass = 'status-pending';
                    break;
                case 'SCHEDULED':
                    statusText = 'Scheduled';
                    statusClass = 'status-scheduled';
                    break;
                case 'CANCELLED':
                    statusText = 'Cancelled';
                    statusClass = 'status-cancelled';
                    break;
                case 'PENDING':
                    statusText = 'Pending';
                    statusClass = 'status-pending';
                    break;
                case 'APPROVED':
                    statusText = 'Approved';
                    statusClass = 'status-approved';
                    break;
                case 'REJECTED':
                    statusText = 'Rejected';
                    statusClass = 'status-rejected';
                    break;
                default:
                    statusText = trade.status || 'Unknown';
                    statusClass = `status-${(trade.status || 'unknown').toLowerCase()}`;
            }
            return `
                <div class="trade-card">
                    <div class="trade-header">
                        <h3>Shift #${trade.shiftId} ${trade.requestedAt ? '- ' + formatDate(trade.requestedAt) : ''}</h3>
                        <span class="status-badge ${statusClass}">${statusText}</span>
                    </div>
                    <div class="trade-info">
                        <div class="info-item">
                            <i class="fas fa-user"></i>
                            <span>Requested by: ${trade.requestingEmployeeName || 'Unknown'}</span>
                        </div>
                        ${trade.pickupEmployeeName ? `
                            <div class="info-item">
                                <i class="fas fa-user-plus"></i>
                                <span>Pickup: ${trade.pickupEmployeeName}</span>
                            </div>
                        ` : ''}
                        <div class="info-item">
                            <i class="fas fa-comment"></i>
                            <span>Status: ${statusText}</span>
                        </div>
                        ${trade.requestedAt ? `
                            <div class="info-item">
                                <i class="fas fa-clock"></i>
                                <span>Requested: ${formatDate(trade.requestedAt)}</span>
                            </div>
                        ` : ''}
                    </div>
                    <div class="trade-actions">
                        ${getTradeActions(trade, context, isOwner, isPickup)}
                    </div>
                </div>
            `;
        }

        function getTradeActions(trade, context, isOwner, isPickup) {
            let actions = [];
            // Hide all actions if trade is scheduled, rejected, or cancelled
            if (trade.status === 'SCHEDULED' || trade.status === 'REJECTED' || trade.status === 'CANCELLED') {
                return '';
            }
            if (context === 'approval') {
                // Only show approve/reject for trades with status PENDING_APPROVAL and a pickupEmployeeId
                if (trade.status === 'PENDING_APPROVAL' && trade.pickupEmployeeId) {
                    actions.push(`<button class="btn btn-success" onclick="approveTrade(${trade.id})">
                        <i class="fas fa-check"></i> Approve
                    </button>`);
                    actions.push(`<button class="btn btn-danger" onclick="rejectTrade(${trade.id})">
                        <i class="fas fa-times"></i> Reject
                    </button>`);
                }
            }
            
            return actions.join('');
        }
        async function acceptTrade(tradeId) {
            if (!confirm('Are you sure you want to accept this shift trade?')) return;
            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch(`${API_BASE_URL}/shifts/trades/${tradeId}/accept`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                if (response.ok) {
                    showSuccess('Trade accepted!');
                    loadTrades();
                } else {
                    const error = await response.text();
                    showError(error || 'Failed to accept trade');
                }
            } catch (error) {
                showError('Error accepting trade');
            }
        }

        // Decline trade
        async function declineTrade(tradeId) {
            if (!confirm('Are you sure you want to decline this shift trade?')) return;
            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch(`${API_BASE_URL}/shifts/trades/${tradeId}/decline`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                if (response.ok) {
                    showSuccess('Trade declined');
                    loadTrades();
                } else {
                    const error = await response.text();
                    showError(error || 'Failed to decline trade');
                }
            } catch (error) {
                showError('Error declining trade');
            }
        }

        async function approveTrade(tradeId) {
            if (!confirm('Are you sure you want to approve this trade?')) return;
            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch(`${API_BASE_URL}/shifts/trades/${tradeId}/approve`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                if (response.ok) {
                    showSuccess('Trade approved successfully');
                    // UI: Remove approve/reject buttons and update status
                    await loadTrades();
                } else {
                    const error = await response.text();
                    showError(error || 'Failed to approve trade');
                }
            } catch (error) {
                showError('Error approving trade');
            }
        }

        async function rejectTrade(tradeId) {
            const reason = prompt('Please provide a reason for rejecting this trade:');
            if (!reason) return;
            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch(`${API_BASE_URL}/shifts/trades/${tradeId}/reject`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ reason })
                });
                if (response.ok) {
                    showSuccess('Trade rejected');
                    // UI: Remove approve/reject buttons and update status
                    await loadTrades();
                } else {
                    const error = await response.text();
                    showError(error || 'Failed to reject trade');
                }
            } catch (error) {
                showError('Error rejecting trade');
            }
        }

        // Cancel trade
        async function cancelTrade(tradeId) {
            if (!confirm('Are you sure you want to cancel this trade request?')) return;
            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch(`${API_BASE_URL}/shifts/trades/${tradeId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                if (response.ok) {
                    showSuccess('Trade request cancelled');
                    loadTrades();
                } else {
                    const error = await response.text();
                    showError(error || 'Failed to cancel trade');
                }
            } catch (error) {
                showError('Error cancelling trade');
            }
        }

        function switchTab(tabName) {
            // Remove active class from all tabs and content
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            // Add active class to clicked tab and corresponding content
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
        }

        function openCreateTradeModal() {
            document.getElementById('createTradeModal').style.display = 'block';
        }

        function closeCreateTradeModal() {
            document.getElementById('createTradeModal').style.display = 'none';
            document.getElementById('createTradeForm').reset();
        }

        function populateShiftSelect() {
            const select = document.getElementById('shiftSelect');
            const today = new Date();

            // Filter future shifts that don't already have trade requests
            const availableShifts = myShifts.filter(shift => {
                const shiftDate = new Date(shift.date);
                const hasActiveTrade = myTrades.some(trade => {
                    // Defensive: check trade.shift and shift.id
                    if (!trade || typeof trade.shiftId === 'undefined') return false;
                    return trade.shiftId === shift.id && (trade.status === 'PENDING' || trade.status === 'APPROVED');
                });
                return shiftDate >= today && !hasActiveTrade;
            });

            select.innerHTML = '<option value="">Select a shift...</option>' +
                availableShifts.map(shift => `
                    <option value="${shift.id}">
                        ${formatDate(shift.date)} - ${formatTime(shift.startTime)} to ${formatTime(shift.endTime)} (${shift.department.name})
                    </option>
                `).join('');
        }

        function populateDepartmentFilter() {
            const select = document.getElementById('departmentFilter');
            select.innerHTML = '<option value="">All Departments</option>' +
                departments.map(dept => `<option value="${dept.id}">${dept.name}</option>`).join('');
        }

        document.getElementById('createTradeForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const shiftId = document.getElementById('shiftSelect').value;
            const reason = document.getElementById('tradeReason').value;

            if (!shiftId || !reason) {
                showError('Please fill in all required fields');
                return;
            }

            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch(`${API_BASE_URL}/shifts/trades`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        shiftId: parseInt(shiftId),
                        reason: reason
                    })
                });

                if (response.ok) {
                    showSuccess('Trade request created successfully');
                    closeCreateTradeModal();
                    loadTrades();
                    loadMyShifts(); // Refresh to update available shifts
                } else {
                    const error = await response.text();
                    showError(error || 'Failed to create trade request');
                }
            } catch (error) {
                console.error('Error creating trade:', error);
                showError('Error creating trade request');
            }
        });

        function applyFilters() {
            loadTrades();
        }

        function clearFilters() {
            document.getElementById('statusFilter').value = '';
            document.getElementById('departmentFilter').value = '';
            document.getElementById('dateFromFilter').value = '';
            document.getElementById('dateToFilter').value = '';
            applyFilters();
        }

        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('en-US', {
                weekday: 'short',
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }

        function formatTime(timeString) {
            return new Date(`2000-01-01T${timeString}`).toLocaleTimeString('en-US', {
                hour: 'numeric',
                minute: '2-digit',
                hour12: true
            });
        }

        function showSuccess(message) {
            // Simple alert for now - could be replaced with a toast notification
            alert('Success: ' + message);
        }

        function showError(message) {
            // Simple alert for now - could be replaced with a toast notification
            alert('Error: ' + message);
        }

        function logout() {
            localStorage.removeItem('authToken');
            localStorage.removeItem('userInfo');
            window.location.href = 'login.html';
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('createTradeModal');
            if (event.target === modal) {
                closeCreateTradeModal();
            }
        }
    </script>
</body>
</html>
