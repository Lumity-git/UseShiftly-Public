<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Log Review - Hotel Scheduler</title>
    <link rel="stylesheet" href="employee-shifts.html">
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f4f6fa; }
        .container { max-width: 1200px; margin: 40px auto; background: white; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.08); padding: 30px; }
        h1 { color: #2c3e50; margin-bottom: 20px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px 8px; border-bottom: 1px solid #eee; text-align: left; }
        th { background: #667eea; color: white; }
        tr:hover { background: #f8f9fa; }
        .filter-bar { margin-bottom: 20px; display: flex; gap: 20px; }
        .btn { padding: 8px 16px; border: none; border-radius: 6px; background: #3498db; color: white; cursor: pointer; font-weight: 500; }
        .btn:hover { background: #2980b9; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸ”’ Admin Log Review</h1>
        <div class="filter-bar">
            <input type="text" id="userSearch" placeholder="Search by User Email or UUID">
            <select id="roleFilter">
                <option value="">All Roles</option>
                <option value="EMPLOYEE">Employee</option>
                <option value="MANAGER">Manager</option>
                <option value="ADMIN">Admin</option>
            </select>
            <button class="btn" onclick="loadLogs()">Filter</button>
        </div>
        <table id="logsTable">
            <thead>
                <tr>
                    <th>Timestamp</th>
                    <th>Action</th>
                    <th>User Email</th>
                    <th>User UUID</th>
                    <th>Role</th>
                    <th>Building</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
    <script src="auth-manager.js"></script>
    <script>
        const API_BASE_URL = window.location.origin + '/api';
        let currentUser = null;
        document.addEventListener('DOMContentLoaded', async function() {
            const isAuthenticated = await checkAuth();
            if (!isAuthenticated) return;
            loadUserInfo();
            loadLogs();
        });

        async function checkAuth() {
            const token = localStorage.getItem('authToken');
            const userInfo = localStorage.getItem('userInfo');
            if (!token || !userInfo) {
                window.location.href = 'login.html';
                return false;
            }
            try {
                const response = await fetch(`${API_BASE_URL}/auth/validate`, {
                    method: 'GET',
                    headers: {
                        Authorization: `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                if (response.status === 401) {
                    // Try to refresh token if backend supports
                    const refreshResponse = await fetch(`${API_BASE_URL}/auth/refresh`, {
                        method: 'POST',
                        headers: {
                            Authorization: `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    });
                    if (refreshResponse.ok) {
                        const data = await refreshResponse.json();
                        if (data.token) {
                            localStorage.setItem('authToken', data.token);
                            if (data.userInfo) {
                                localStorage.setItem('userInfo', JSON.stringify(data.userInfo));
                            }
                            return true;
                        }
                    }
                    localStorage.removeItem('authToken');
                    localStorage.removeItem('userInfo');
                    window.location.href = 'login.html';
                    return false;
                }
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                if (data.token) {
                    localStorage.setItem('authToken', data.token);
                }
                if (data.userInfo) {
                    localStorage.setItem('userInfo', JSON.stringify(data.userInfo));
                }
                return true;
            } catch (error) {
                console.error('Auth validation failed:', error);
                localStorage.removeItem('authToken');
                localStorage.removeItem('userInfo');
                window.location.href = 'login.html';
                return false;
            }
        }
        function loadUserInfo() {
            const userInfo = localStorage.getItem('userInfo');
            if (userInfo) {
                currentUser = JSON.parse(userInfo);
            }
        }
        async function loadLogs() {
            const userSearch = document.getElementById('userSearch').value.trim();
            const roleFilter = document.getElementById('roleFilter').value;
            let url = `${API_BASE_URL}/logs/building/${currentUser.building.id}`;
            if (userSearch) {
                url = `${API_BASE_URL}/logs/user/${userSearch}`;
            } else if (roleFilter) {
                url = `${API_BASE_URL}/logs/role/${roleFilter}`;
            }
            const token = localStorage.getItem('authToken');
            const res = await fetch(url, {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });
            if (res.ok) {
                const logs = await res.json();
                renderLogs(logs);
            } else {
                document.querySelector('#logsTable tbody').innerHTML = '<tr><td colspan="6">Failed to load logs.</td></tr>';
            }
        }
        function renderLogs(logs) {
            const tbody = document.querySelector('#logsTable tbody');
            if (!logs || logs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6">No logs found.</td></tr>';
                return;
            }
            tbody.innerHTML = logs.map(log => `
                <tr>
                    <td>${new Date(log.timestamp).toLocaleString()}</td>
                    <td>${log.action}</td>
                    <td>${log.userEmail}</td>
                    <td>${log.userUuid}</td>
                    <td>${log.role}</td>
                    <td>${log.buildingName}</td>
                </tr>
            `).join('');
        }
    </script>
</body>
</html>
