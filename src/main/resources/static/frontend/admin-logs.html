<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Log Review - Hotel Scheduler</title>
    <link rel="stylesheet" href="style.css" />
</head>
<body>
    <div id="headerContainer"></div>
    <script src="nav-manager.js"></script>
    <script src="auth-manager.js"></script>
    <script>
      const API_BASE_URL = window.location.origin + '/api';
      let currentUser = null;

      document.addEventListener("DOMContentLoaded", function() {
        fetch("header.html")
          .then(res => res.text())
          .then(html => {
            document.getElementById("headerContainer").innerHTML = html;
            renderNavLinks("admin-logs.html");
            initAdminLogsPage();
          });
        document.querySelector('.btn[onclick="loadLogs()"]')?.addEventListener('click', loadLogs);
      });

      async function initAdminLogsPage() {
        const isAuthenticated = await checkAuth();
        if (!isAuthenticated) return;
        loadUserInfo();
        loadLogs();
      }

      async function checkAuth() {
        const token = localStorage.getItem('authToken');
        const userInfo = localStorage.getItem('userInfo');
        if (!token || !userInfo) {
          window.location.href = 'login.html';
          return false;
        }
        try {
          const response = await fetch(`${API_BASE_URL}/auth/validate`, {
            method: 'GET',
            headers: {
              Authorization: `Bearer ${token}`,
              'Content-Type': 'application/json'
            }
          });
          if (response.status === 401) {
            const refreshResponse = await fetch(`${API_BASE_URL}/auth/refresh`, {
              method: 'POST',
              headers: {
                Authorization: `Bearer ${token}`,
                'Content-Type': 'application/json'
              }
            });
            if (refreshResponse.ok) {
              const data = await refreshResponse.json();
              if (data.token) {
                localStorage.setItem('authToken', data.token);
                if (data.userInfo) {
                  localStorage.setItem('userInfo', JSON.stringify(data.userInfo));
                }
                return true;
              }
            }
            localStorage.removeItem('authToken');
            localStorage.removeItem('userInfo');
            window.location.href = 'login.html';
            return false;
          }
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          const data = await response.json();
          if (data.token) {
            localStorage.setItem('authToken', data.token);
          }
          if (data.userInfo) {
            localStorage.setItem('userInfo', JSON.stringify(data.userInfo));
          }
          return true;
        } catch (error) {
          console.error('Auth validation failed:', error);
          localStorage.removeItem('authToken');
          localStorage.removeItem('userInfo');
          window.location.href = 'login.html';
          return false;
        }
      }

      function loadUserInfo() {
        const userInfo = localStorage.getItem('userInfo');
        if (userInfo) {
          currentUser = JSON.parse(userInfo);
        }
      }

      async function loadLogs() {
        if (!currentUser || !currentUser.building || !currentUser.building.id) {
          document.querySelector('#logsTable tbody').innerHTML = '<tr><td colspan="6">No building context found.</td></tr>';
          return;
        }
        const userSearch = document.getElementById('userSearch').value.trim();
        const roleFilter = document.getElementById('roleFilter').value;
        let url = `${API_BASE_URL}/logs/building/${currentUser.building.id}`;
        if (userSearch) {
          url = `${API_BASE_URL}/logs/user/${encodeURIComponent(userSearch)}`;
        } else if (roleFilter) {
          url = `${API_BASE_URL}/logs/role/${encodeURIComponent(roleFilter)}`;
        }
        const token = localStorage.getItem('authToken');
        try {
          const res = await fetch(url, {
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            }
          });
          if (res.ok) {
            const logs = await res.json();
            renderLogs(logs);
          } else {
            document.querySelector('#logsTable tbody').innerHTML = '<tr><td colspan="6">Failed to load logs.</td></tr>';
          }
        } catch (error) {
          document.querySelector('#logsTable tbody').innerHTML = '<tr><td colspan="6">Error loading logs.</td></tr>';
        }
      }

      function renderLogs(logs) {
        const tbody = document.querySelector('#logsTable tbody');
        if (!logs || logs.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6">No logs found.</td></tr>';
          return;
        }
        tbody.innerHTML = logs.map(log => `
          <tr>
            <td>${new Date(log.timestamp).toLocaleString()}</td>
            <td>${log.action}</td>
            <td>${log.userEmail}</td>
            <td>${log.userUuid}</td>
            <td>${log.role}</td>
            <td>${log.buildingName}</td>
          </tr>
        `).join('');
      }
    </script>
</body>
</html>
