<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Employee Directory - Shiftly Scheduler</title>
    <link rel="stylesheet" href="style.css" />
    <style>
      /* Make all modal and input edges rounded */
      .modal-content {
        border-radius: 16px !important;
        box-shadow: 0 4px 24px rgba(0,0,0,0.12);
      }
      .modal-header, .modal-title, .form-group input, .form-group select, .form-group textarea, .form-row, .form-group, .action-buttons button {
        border-radius: 12px !important;
      }
      .form-group input, .form-group select, .form-group textarea {
        border: 1px solid #ccc;
        padding: 0.5em;
      }
      .modal-header {
        position: relative;
      }
      /* Move X button outside modal header for Edit Employee */
      #employeeModal .close {
        position: absolute;
        top: -18px;
        right: -18px;
        background: #fff;
        border-radius: 50%;
        box-shadow: 0 2px 8px rgba(0,0,0,0.12);
        border: 1px solid #ccc;
        width: 36px;
        height: 36px;
        font-size: 1.5em;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        z-index: 10;
      }
      #employeeModal .modal-header {
        border-radius: 16px 16px 0 0 !important;
      }
      #employeeModal .modal-content {
        border-radius: 16px !important;
      }
    </style>
  </head>
  <body>
    <div id="headerContainer">
      <script>
          // Use nav-manager.js to load header and navigation
          document.addEventListener("DOMContentLoaded", function() {
            fetch("header.html")
              .then(res => res.text())
              .then(html => {
                document.getElementById("headerContainer").innerHTML = html;
                if (window.renderNavLinks) {
                  renderNavLinks("employees.html");
                }
                if (window.highlightCurrentNavLink) {
                  highlightCurrentNavLink("employees.html");
                }
                initEmployeesPage();
              });
          });
      </script>
    </div>
    <div class="container">
      <div class="filters">
        <div class="filter-row">
          <div class="filter-group" style="min-width: 180px">
            <label for="searchTerm">Search Employee</label>
            <input
              type="text"
              id="searchTerm"
              placeholder="Search by name, email, or phone"
            />
          </div>
          <div class="filter-group" style="min-width: 140px">
            <label for="buildingFilter">Building</label>
            <select id="buildingFilter">
              <option value="">All Buildings</option>
            </select>
          </div>
          <div class="filter-group" style="min-width: 140px">
            <label for="departmentFilter">Department</label>
            <select id="departmentFilter">
              <option value="">All Departments</option>
            </select>
          </div>
          <div class="filter-group" style="min-width: 120px">
            <label for="roleFilter">Role</label>
            <select id="roleFilter">
              <option value="">All Roles</option>
              <option value="ADMIN">Admin</option>
              <option value="MANAGER">Manager</option>
              <option value="EMPLOYEE">Employee</option>
            </select>
          </div>
          <div class="filter-group" style="min-width: 120px">
            <label for="statusFilter">Status</label>
            <select id="statusFilter">
              <option value="">All Statuses</option>
              <option value="true">Active</option>
              <option value="false">Inactive</option>
            </select>
          </div>
          <div
            class="action-buttons"
            id="actionButtons"
            style="
              display: flex;
              gap: 0.5em;
              align-items: flex-end;
              min-width: 420px;
            "
          >
            <!-- Buttons will be populated based on user role -->
          </div>
        </div>
      </div>

      <div id="alertContainer"></div>

      <div id="employeesContainer">
        <div class="loading">
          <div class="spinner"></div>
          <p>Loading employees...</p>
        </div>
      </div>



    <!-- Employee Modal -->
    <div id="employeeModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title" id="employeeModalTitle">Employee Details</h3>
          <button class="close" onclick="closeEmployeeModal()">&times;</button>
        </div>
        <form id="employeeForm">
          <div class="form-row">
            <div class="form-group">
              <label for="firstName">First Name</label>
              <input type="text" id="firstName" name="firstName" required />
            </div>
            <div class="form-group">
              <label for="lastName">Last Name</label>
              <input type="text" id="lastName" name="lastName" required />
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="email">Email Address</label>
              <input type="email" id="email" name="email" required />
            </div>
            <div class="form-group">
              <label for="phoneNumber">Phone Number</label>
              <input type="tel" id="phoneNumber" name="phoneNumber" />
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="dateOfBirth">Date of Birth</label>
              <input type="date" id="dateOfBirth" name="dateOfBirth" />
            </div>
            <div class="form-group">
              <label for="address">Address</label>
              <input type="text" id="address" name="address" />
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="emergencyContactName">Emergency Contact Name</label>
              <input
                type="text"
                id="emergencyContactName"
                name="emergencyContactName"
              />
            </div>
            <div class="form-group">
              <label for="emergencyContactRelation"
                >Emergency Contact Relation</label
              >
              <input
                type="text"
                id="emergencyContactRelation"
                name="emergencyContactRelation"
              />
            </div>
            <div class="form-group">
              <label for="emergencyContactPhone">Emergency Contact Phone</label>
              <input
                type="tel"
                id="emergencyContactPhone"
                name="emergencyContactPhone"
              />
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="role">Role</label>
              <select id="role" name="role" required>
                <option value="EMPLOYEE">Employee</option>
                <option value="MANAGER">Manager</option>
                <option value="ADMIN">Admin</option>
              </select>
            </div>
            <div class="form-group">
              <label for="department">Department</label>
              <select id="department" name="departmentId">
                <option value="">Select Department</option>
              </select>
            </div>
            <div class="form-group" id="buildingGroup" style="display: none">
              <label for="employeeBuilding">Building</label>
              <select id="employeeBuilding" name="buildingId">
                <option value="">Select Building</option>
              </select>
            </div>
          </div>
          <div class="form-group">
            <label for="active">Status</label>
            <select id="active" name="active">
              <option value="true">Active</option>
              <option value="false">Inactive</option>
            </select>
          </div>
          <div class="action-buttons">
            <button type="submit" class="btn btn-primary">
              üíæ Save Employee
            </button>
            <button
              type="button"
              class="btn btn-secondary"
              onclick="closeEmployeeModal()"
            >
              ‚úñ Cancel
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Invitation Modal -->
    <div id="invitationModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title">Create Employee Invitation</h3>
          <button class="close" onclick="closeInvitationModal()">
            &times;
          </button>
        </div>
        <form id="invitationForm">
          <div class="form-row">
            <div class="form-group">
              <label for="inviteFirstName">First Name</label>
              <input
                type="text"
                id="inviteFirstName"
                name="firstName"
                required
              />
            </div>
            <div class="form-group">
              <label for="inviteLastName">Last Name</label>
              <input type="text" id="inviteLastName" name="lastName" required />
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="inviteEmail">Email Address</label>
              <input type="email" id="inviteEmail" name="email" required />
            </div>
            <div class="form-group">
              <label for="invitePhone">Phone Number</label>
              <input type="tel" id="invitePhone" name="phoneNumber" required />
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="inviteRole">Default Role</label>
              <select id="inviteRole" name="role" required>
                <option value="EMPLOYEE">Employee</option>
                <option value="MANAGER">Manager</option>
              </select>
            </div>
            <div class="form-group">
              <label for="inviteDepartment">Department</label>
              <select id="inviteDepartment" name="departmentId" required>
                <option value="">Select Department</option>
              </select>
            </div>
          </div>
          <div class="form-group">
            <label for="inviteNotes">Notes for HR/Legal</label>
            <textarea
              id="inviteNotes"
              name="notes"
              rows="3"
              placeholder="Documentation requirements, position details, etc."
            ></textarea>
          </div>
          <div class="form-group">
            <label for="expiryDays">Invitation Expires In (Days)</label>
            <select id="expiryDays" name="expiryDays">
              <option value="7">7 Days</option>
              <option value="14" selected>14 Days</option>
              <option value="30">30 Days</option>
            </select>
          </div>
          <div class="action-buttons">
            <button type="submit" class="btn btn-primary">
              üìß Generate Invitation Link
            </button>
            <button
              type="button"
              class="btn btn-secondary"
              onclick="closeInvitationModal()"
            >
              ‚ùå Cancel
            </button>
          </div>
        </form>
      </div>
    </div>

    <script src="auto-logout.js"></script>
    <script src="auth-manager.js"></script>
    <script src="nav-manager.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", function() {
        fetch("header.html")
          .then(res => res.text())
          .then(html => {
            document.getElementById("headerContainer").innerHTML = html;
            renderNavLinks("employees.html");
            // Page initialization after header loads
            // Use the same init function name as notifications.html for consistency
            if (typeof initEmployeesPage === "function") {
              initEmployeesPage();
            }
          });
      });
    </script>
    <script>




      // Password reset invitation link generation for employees
      async function generateChangePasswordLinkFor(employeeId, employeeEmail) {
        try {
        // Prepare invitation data for password reset
        const invitationData = {
          email: employeeEmail,
          employeeId: employeeId,
          type: "PASSWORD_RESET"
        };
        const response = await apiRequest("/auth/generate-invitation", {
          method: "POST",
          body: JSON.stringify(invitationData)
        });
        // Build the reset link
        const resetUrl = `${window.location.origin}/change-password.html?code=${response.invitationCode}&token=${response.invitationToken}`;
        // Show and set the link in the input for copy
        const linkInput = document.getElementById(`changePasswordLink_${employeeId}`);
        linkInput.value = resetUrl;
        linkInput.style.display = "inline-block";
        linkInput.style.width = "80%";
        // Show the copy button
        const copyBtn = document.getElementById(`copyChangePasswordBtn_${employeeId}`);
        copyBtn.style.display = "inline-block";
        showAlert("Password reset link generated! Click copy to copy the link.", "success");
      } catch (error) {
        showAlert("Failed to generate password reset link.", "error");
      }
      }

      function copyChangePasswordLinkFor(employeeId) {
        const linkInput = document.getElementById(`changePasswordLink_${employeeId}`);
        if (linkInput && linkInput.value) {
          navigator.clipboard.writeText(linkInput.value)
            .then(() => {
              showAlert("Password reset link copied to clipboard!", "success");
            })
            .catch(() => {
              prompt("Copy this password reset link:", linkInput.value);
            });
        }
      }
      let currentUser = null;
      const API_BASE_URL = window.location.origin + "/api";

      // Initialize page
      document.addEventListener("DOMContentLoaded", async function () {
        const isAuthenticated = await checkAuth();
        if (!isAuthenticated) return;

        loadUserInfo();
        // Use currentUser (set by loadUserInfo) for all user.id checks
        if (currentUser && currentUser.id && !isNaN(Number(currentUser.id))) {
          await loadBuildingsByAdmin();
        } else {
          console.warn(
            "Skipping loadBuildingsByAdmin: currentUser.id is missing or invalid."
          );
        }
        await loadDepartments();
        await loadEmployees();
        setupEventListeners();
        setupActionButtons();

        // ...existing code...
      });
      let buildings = [];

      async function loadBuildingsByAdmin() {
        try {
          const userInfo = localStorage.getItem("userInfo");
          if (!userInfo) return;
          const user = JSON.parse(userInfo);
          let buildingsResult = [];
          // Defensive: ensure user.id is a valid number
          if (!user.id || isNaN(Number(user.id))) {
            console.error(
              "User ID is missing or invalid, cannot load buildings."
            );
            return;
          }
          if (user.role === "ADMIN" || user.role === "MANAGER") {
            buildingsResult = await apiRequest(
              `/buildings/by-admin/${user.id}`
            );
          }
          buildings = buildingsResult;
          populateBuildingSelect();
        } catch (error) {
          console.error("Failed to load buildings:", error);
        }
      }

      function populateBuildingSelect() {
        const select = document.getElementById("buildingFilter");
        if (!select) return;
        select.innerHTML = '<option value="">All Buildings</option>';
        buildings.forEach((building) => {
          const option = document.createElement("option");
          option.value = building.id;
          option.textContent = building.name;
          select.appendChild(option);
        });
      }

      function setupEventListeners() {
        document
          .getElementById("searchTerm")
          .addEventListener("input", filterEmployees);
        document
          .getElementById("buildingFilter")
          .addEventListener("change", async function () {
            await loadEmployees();
            filterEmployees();
          });
        document
          .getElementById("departmentFilter")
          .addEventListener("change", filterEmployees);
        document
          .getElementById("roleFilter")
          .addEventListener("change", filterEmployees);
        document
          .getElementById("statusFilter")
          .addEventListener("change", filterEmployees);
        document
          .getElementById("employeeForm")
          .addEventListener("submit", handleEmployeeSubmit);
        document
          .getElementById("invitationForm")
          .addEventListener("submit", handleInvitationSubmit);
      }

      function setupActionButtons() {
        const actionButtons = document.getElementById("actionButtons");
        if (canManageEmployees()) {
          let buildingBtn = "";
          if (currentUser && currentUser.role === "ADMIN") {
            buildingBtn = `<button class="btn btn-info" onclick="openCreateBuildingModal()">üè¢ Add Building</button>`;
          }
          actionButtons.innerHTML = `
            <button class="btn btn-primary" onclick="openCreateEmployeeModal()">
                ‚ûï Add Employee
            </button>
            <button class="btn btn-secondary" onclick="openBulkImportModal()">
                ‚ûï Add Employees by File
            </button>
            <button class="btn btn-secondary" onclick="refreshWithFilters()">
                üîÑ Refresh
            </button>
            <button class="btn btn-success" onclick="exportEmployeesFiltered()">
                üìä Export
            </button>
            ${buildingBtn}
          `;
        } else {
          actionButtons.innerHTML = `
            <button class="btn btn-secondary" onclick="refreshWithFilters()">
                üîÑ Refresh
            </button>
          `;
        }
      }

      // Refresh button that reloads and re-applies filters
      async function refreshWithFilters() {
        await loadEmployees();
        filterEmployees();
      }

      // Export only currently filtered employees
      function exportEmployeesFiltered() {
        // Get current filtered employees
        const searchTerm = document
          .getElementById("searchTerm")
          .value.toLowerCase();
        const buildingFilter = document.getElementById("buildingFilter").value;
        const departmentFilter =
          document.getElementById("departmentFilter").value;
        const roleFilter = document.getElementById("roleFilter").value;
        const statusFilter = document.getElementById("statusFilter").value;
        const filtered = employees.filter((employee) => {
          const matchesSearch =
            employee.firstName.toLowerCase().includes(searchTerm) ||
            employee.lastName.toLowerCase().includes(searchTerm) ||
            employee.email.toLowerCase().includes(searchTerm) ||
            (employee.phoneNumber && employee.phoneNumber.includes(searchTerm));
          const matchesBuilding =
            !buildingFilter || employee.buildingId == buildingFilter;
          const matchesDepartment =
            !departmentFilter || employee.departmentId == departmentFilter;
          const matchesRole = !roleFilter || employee.role === roleFilter;
          const matchesStatus =
            !statusFilter || employee.active.toString() === statusFilter;
          return (
            matchesSearch &&
            matchesBuilding &&
            matchesDepartment &&
            matchesRole &&
            matchesStatus
          );
        });
        // Update filterEmployees to include building filter
        function filterEmployees() {
          const searchTerm = document
            .getElementById("searchTerm")
            .value.toLowerCase();
          const buildingFilter =
            document.getElementById("buildingFilter").value;
          const departmentFilter =
            document.getElementById("departmentFilter").value;
          const roleFilter = document.getElementById("roleFilter").value;
          const statusFilter = document.getElementById("statusFilter").value;
          const filtered = employees.filter((employee) => {
            const matchesSearch =
              employee.firstName.toLowerCase().includes(searchTerm) ||
              employee.lastName.toLowerCase().includes(searchTerm) ||
              employee.email.toLowerCase().includes(searchTerm) ||
              (employee.phoneNumber &&
                employee.phoneNumber.includes(searchTerm));
            const matchesBuilding =
              !buildingFilter || employee.buildingId == buildingFilter;
            const matchesDepartment =
              !departmentFilter || employee.departmentId == departmentFilter;
            const matchesRole = !roleFilter || employee.role === roleFilter;
            const matchesStatus =
              !statusFilter || employee.active.toString() === statusFilter;
            return (
              matchesSearch &&
              matchesBuilding &&
              matchesDepartment &&
              matchesRole &&
              matchesStatus
            );
          });
          renderEmployees(filtered);
        }
        if (!filtered || filtered.length === 0) {
          showAlert("No employees to export.", "info");
          return;
        }
        const csvRows = [
          [
            "First Name",
            "Last Name",
            "Email",
            "Phone Number",
            "Date of Birth",
            "Address",
            "Emergency Contact Name",
            "Emergency Contact Relation",
            "Emergency Contact Phone",
            "Role",
            "Department",
            "Status",
            "Joined",
          ].join(","),
        ];
        filtered.forEach((emp) => {
          csvRows.push(
            [
              emp.firstName,
              emp.lastName,
              emp.email,
              emp.phoneNumber || "",
              emp.dateOfBirth || "",
              emp.address || "",
              emp.emergencyContactName || "",
              emp.emergencyContactRelation || "",
              emp.emergencyContactPhone || "",
              emp.role,
              emp.departmentName || "",
              emp.active ? "Active" : "Inactive",
              formatDate(emp.createdAt),
            ]
              .map((val) => `"${val}"`)
              .join(",")
          );
        });
        const csvContent = csvRows.join("\n");
        const blob = new Blob([csvContent], { type: "text/csv" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "employees_export.csv";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }

      // Authentication
      async function checkAuth() {
        const token = localStorage.getItem("authToken");
        const userInfo = localStorage.getItem("userInfo");
        if (!token || !userInfo) {
          window.location.href = "login.html";
          return false;
        }
        let user = JSON.parse(userInfo);
        // Only allow MANAGER and ADMIN
        if (!["MANAGER", "ADMIN"].includes(user.role)) {
          window.location.href = "login.html";
          return false;
        }
        try {
          const response = await fetch(`${API_BASE_URL}/auth/validate`, {
            method: "GET",
            headers: {
              Authorization: `Bearer ${token}`,
              "Content-Type": "application/json",
            },
          });
          if (response.status === 401) {
            // Try to refresh token if backend supports
            const refreshResponse = await fetch(
              `${API_BASE_URL}/auth/refresh`,
              {
                method: "POST",
                headers: {
                  Authorization: `Bearer ${token}`,
                  "Content-Type": "application/json",
                },
              }
            );
            if (refreshResponse.ok) {
              const data = await refreshResponse.json();
              if (data.token) {
                localStorage.setItem("authToken", data.token);
              }
              if (data.userInfo) {
                localStorage.setItem("userInfo", JSON.stringify(data.userInfo));
                user = data.userInfo;
              }
              if (!["MANAGER", "ADMIN"].includes(user.role)) {
                window.location.href = "login.html";
                return false;
              }
              return true;
            }
            localStorage.removeItem("authToken");
            localStorage.removeItem("userInfo");
            window.location.href = "login.html";
            return false;
          }
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          const data = await response.json();
          if (data.token) {
            localStorage.setItem("authToken", data.token);
          }
          if (data.userInfo) {
            localStorage.setItem("userInfo", JSON.stringify(data.userInfo));
            user = data.userInfo;
          }
          if (!["MANAGER", "ADMIN"].includes(user.role)) {
            window.location.href = "login.html";
            return false;
          }
          return true;
        } catch (error) {
          console.error("Auth validation failed:", error);
          localStorage.removeItem("authToken");
          localStorage.removeItem("userInfo");
          window.location.href = "login.html";
          return false;
        }
      }

      function loadUserInfo() {
        const userInfo = localStorage.getItem("userInfo");
        if (userInfo) {
          currentUser = JSON.parse(userInfo);
          // Defensive: force logout if id is missing or invalid
          if (!currentUser.id || isNaN(Number(currentUser.id))) {
            showAlert("Your session is invalid. Please log in again.", "error");
            setTimeout(() => {
              logout();
            }, 1200);
            return;
          }
          // Optionally display building info in header or elsewhere
          let userDisplay = `${currentUser.firstName} ${currentUser.lastName}`;
          if (currentUser.buildingName && currentUser.buildingName !== "null") {
            userDisplay += ` (${currentUser.buildingName})`;
          }
          const userNameElem = document.getElementById("userName");
          if (userNameElem) {
            userNameElem.textContent = userDisplay;
          }
          // Optionally, handle mustChangePassword flag
          if (
            currentUser.mustChangePassword === true ||
            currentUser.mustChangePassword === "true"
          ) {
            showAlert(
              "You must change your password before continuing.",
              "error"
            );
            setTimeout(() => {
              window.location.href = "/frontend/change-password.html";
            }, 1200);
            return;
          }
        }
      }

      // Navigation is now handled by header.html; remove old nav link code

      // Page initialization after header loads
      function initEmployeesPage() {
        // Authentication and user info
        checkAuth().then(isAuthenticated => {
          if (!isAuthenticated) return;
          loadUserInfo();
          if (currentUser && currentUser.id && !isNaN(Number(currentUser.id))) {
            loadBuildingsByAdmin();
          }
          loadDepartments();
          loadEmployees();
          setupEventListeners();
          setupActionButtons();
        });
      }

      async function loadBuildingsByAdmin() {
        try {
          const userInfo = localStorage.getItem("userInfo");
          if (!userInfo) return;
          let user = JSON.parse(userInfo);
          let buildingsResult = [];
          // Strict check for valid user.id
          if (!user.id || isNaN(Number(user.id))) {
            console.error(
              "User ID is missing or invalid, cannot load buildings."
            );
            return;
          }
          // Use buildingId from userInfo if available
          if (user.buildingId && user.buildingId !== "null") {
            buildingsResult = await apiRequest(
              `/buildings/by-admin/${user.id}`
            );
          } else if (
            (user.role === "ADMIN" || user.role === "MANAGER") &&
            user.id &&
            !isNaN(Number(user.id))
          ) {
            buildingsResult = await apiRequest(
              `/buildings/by-admin/${user.id}`
            );
          }
          buildings = buildingsResult;
          populateBuildingSelect();
        } catch (error) {
          console.error("Failed to load buildings:", error);
        }
        // Removed stray navLinks code from loadBuildingsByAdmin
      }

      function logout() {
        localStorage.removeItem("authToken");
        localStorage.removeItem("userInfo");
        window.location.href = "login.html";
      }

      // API Helpers
      async function apiRequest(endpoint, options = {}) {
        const token = localStorage.getItem("authToken");
        const url = `${API_BASE_URL}${endpoint}`;

        // Defensive: check for valid token
        if (!token || token === "null" || token === "undefined") {
          logout();
          return;
        }

        const config = {
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${token}`,
            ...options.headers,
          },
          ...options,
        };

        try {
          const response = await fetch(url, config);

          if (response.status === 401) {
            logout();
            return;
          }

          if (!response.ok) {
            // Try to parse error message from backend
            let errorMsg = `HTTP error! status: ${response.status}`;
            try {
              const text = await response.text();
              errorMsg = text || errorMsg;
            } catch {}
            showAlert(errorMsg, "error");
            throw new Error(errorMsg);
          }

          return await response.json();
        } catch (error) {
          console.error("API Request failed:", error);
          showAlert("Network error. Please check your connection.", "error");
          throw error;
        }
      }

      // Load data
      async function loadDepartments() {
        try {
          departments = await apiRequest("/departments");
          populateDepartmentSelects();
        } catch (error) {
          console.error("Failed to load departments:", error);
          departments = [];
          populateDepartmentSelects();
        }
      }

      let employees = [];

      async function loadEmployees() {
        try {
          let buildingId = "";
          const buildingFilter = document.getElementById("buildingFilter");
          if (buildingFilter) {
            buildingId = buildingFilter.value;
          }
          let endpoint = "/employees";
          if (buildingId) {
            endpoint = `/employees/by-building/${buildingId}`;
          } else if (
            currentUser &&
            currentUser.role === "MANAGER" &&
            buildings.length > 0
          ) {
            endpoint = `/employees/by-building/${buildings[0].id}`;
          }
          employees = await apiRequest(endpoint);
          if (!employees || !Array.isArray(employees)) employees = [];
          renderEmployees();
        } catch (error) {
          console.error("Failed to load employees:", error);
          employees = [];
          document.getElementById("employeesContainer").innerHTML =
            '<div class="alert alert-error">Failed to load employees. Please try again.</div>';
        }
      }

      async function loadPendingInvitations() {
        try {
          // Use correct backend API for active invitations
          const invitations = await apiRequest("/auth/active-invitations");
          renderPendingInvitations(invitations);
        } catch (error) {
          console.error("Failed to load active invitations:", error);
        }
      }

      // Populate selects
      function populateDepartmentSelects() {
        const selects = ["departmentFilter", "department", "inviteDepartment"];
        selects.forEach((selectId) => {
          const select = document.getElementById(selectId);
          if (!select) return;

          if (selectId === "departmentFilter") {
            select.innerHTML = '<option value="">All Departments</option>';
          } else {
            select.innerHTML = '<option value="">Select Department</option>';
          }

          departments.forEach((dept) => {
            const option = document.createElement("option");
            option.value = dept.id;
            option.textContent = dept.name;
            select.appendChild(option);
          });
        });
      }

      // Render employees
      // Pagination variables
      let currentPage = 1;
      const employeesPerPage = 9;

      function renderEmployees(filteredEmployees = employees) {
        const container = document.getElementById("employeesContainer");
        if (filteredEmployees.length === 0) {
          container.innerHTML =
            '<div class="alert alert-info">No employees found for the selected criteria.</div>';
          document.getElementById("paginationContainer")?.remove();
          return;
        }

        // Pagination logic
        const totalEmployees = filteredEmployees.length;
        const totalPages = Math.ceil(totalEmployees / employeesPerPage);
        if (currentPage > totalPages) currentPage = totalPages;
        if (currentPage < 1) currentPage = 1;
        const startIdx = (currentPage - 1) * employeesPerPage;
        const endIdx = startIdx + employeesPerPage;
        const employeesToShow = filteredEmployees.slice(startIdx, endIdx);

        const employeesHtml = employeesToShow
          .filter(function (employee) {
            // Managers cannot see admin accounts
            if (
              currentUser &&
              currentUser.role === "MANAGER" &&
              employee.role === "ADMIN"
            ) {
              return false;
            }
            return true;
          })
          .map(function (employee) {
            let html = '<div class="employee-card">';
            html += '<div class="employee-header">';
            html += "<div>";
            html +=
              '<div class="employee-name">' +
              employee.firstName +
              " " +
              employee.lastName +
              "</div>";
            html +=
              '<div class="employee-role role-' +
              employee.role.toLowerCase() +
              '">' +
              employee.role +
              "</div>";
            html += "</div>";
            html +=
              '<div class="employee-status">' +
              (employee.active ? "‚úÖ Active" : "‚ùå Inactive") +
              "</div>";
            html += "</div>";
            html += '<div class="employee-info">';
            html +=
              '<div class="employee-detail"><strong>Email:</strong> <span>' +
              employee.email +
              "</span></div>";
            html +=
              '<div class="employee-detail"><strong>Phone:</strong> <span>' +
              (employee.phoneNumber || "Not provided") +
              "</span></div>";
            html +=
              '<div class="employee-detail"><strong>Department:</strong> <span>' +
              (employee.departmentName || "Unassigned") +
              "</span></div>";
            html +=
              '<div class="employee-detail"><strong>Joined:</strong> <span>' +
              formatDate(employee.createdAt) +
              "</span></div>";
            html += "</div>";
            html += '<div class="employee-actions">';
            html +=
              '<button class="btn btn-primary btn-small" onclick="viewEmployeeSchedule(' +
              employee.id +
              ')">üìÖ Schedule</button>';
            if (
              canManageEmployees() &&
              !(
                currentUser &&
                currentUser.role === "MANAGER" &&
                employee.role === "ADMIN"
              )
            ) {
              html +=
                '<button class="btn btn-secondary btn-small" onclick="editEmployee(' +
                employee.id +
                ')">‚úèÔ∏è Edit</button>';
              html +=
                '<button class="btn ' +
                (employee.active ? "btn-warning" : "btn-success") +
                ' btn-small" onclick="toggleEmployeeStatus(' +
                employee.id +
                ", " +
                !employee.active +
                ')">' +
                (employee.active ? "‚è∏Ô∏è Deactivate" : "‚ñ∂Ô∏è Activate") +
                "</button>";
            }
            html +=
              '<button class="btn btn-warning btn-small" onclick="generateChangePasswordLinkFor(' +
              employee.id +
              ", '" +
              employee.email +
              "')\">üîí Change Password</button>";
            html +=
              '<button class="btn btn-info btn-small" id="copyChangePasswordBtn_' +
              employee.id +
              '" style="margin-left:4px;display:none;" onclick="copyChangePasswordLinkFor(' +
              employee.id +
              ')">üìã Copy</button>';
            html +=
              '<input type="text" id="changePasswordLink_' +
              employee.id +
              '" style="display:none;width:0;" readonly />';
            html += "</div>";
            html += "</div>";
            return html;
          })
          .join("");
        container.innerHTML =
          '<div class="employees-grid">' + employeesHtml + "</div>";

        // Pagination controls
        let paginationHtml = "";
        if (totalPages > 1) {
          paginationHtml += '<div class="pagination-controls">';
          paginationHtml += `<button class="btn btn-secondary" onclick="changeEmployeePage(-1)" ${
            currentPage === 1 ? "disabled" : ""
          }>&laquo; Prev</button>`;
          paginationHtml += `<span class="pagination-info"> Page ${currentPage} of ${totalPages} </span>`;
          paginationHtml += `<button class="btn btn-secondary" onclick="changeEmployeePage(1)" ${
            currentPage === totalPages ? "disabled" : ""
          }>Next &raquo;</button>`;
          paginationHtml += "</div>";
        }
        // Remove old pagination if exists
        document.getElementById("paginationContainer")?.remove();
        // Add new pagination
        const pagDiv = document.createElement("div");
        pagDiv.id = "paginationContainer";
        pagDiv.innerHTML = paginationHtml;
        container.parentNode.appendChild(pagDiv);
      }

      // Change page
      window.changeEmployeePage = function (delta) {
        currentPage += delta;
        renderEmployees();
      };

      function renderPendingInvitations(invitations) {
        // Removed, not needed
      }

      // Filter employees
      function filterEmployees() {
        const searchTerm = document
          .getElementById("searchTerm")
          .value.toLowerCase();
        const departmentFilter =
          document.getElementById("departmentFilter").value;
        const roleFilter = document.getElementById("roleFilter").value;
        const statusFilter = document.getElementById("statusFilter").value;

        const filtered = employees.filter((employee) => {
          const matchesSearch =
            employee.firstName.toLowerCase().includes(searchTerm) ||
            employee.lastName.toLowerCase().includes(searchTerm) ||
            employee.email.toLowerCase().includes(searchTerm) ||
            (employee.phoneNumber && employee.phoneNumber.includes(searchTerm));

          const matchesDepartment =
            !departmentFilter || employee.departmentId == departmentFilter;
          const matchesRole = !roleFilter || employee.role === roleFilter;
          const matchesStatus =
            !statusFilter || employee.active.toString() === statusFilter;

          return (
            matchesSearch && matchesDepartment && matchesRole && matchesStatus
          );
        });

        renderEmployees(filtered);
      }

      // Modal functions
      function openCreateEmployeeModal() {
        editingEmployeeId = null;
        document.getElementById("employeeModalTitle").textContent =
          "Add New Employee";
        document.getElementById("employeeForm").reset();
        document.getElementById("employeeModal").style.display = "block";
      }

      function closeEmployeeModal() {
        document.getElementById("employeeModal").style.display = "none";
        editingEmployeeId = null;
      }

      function openInvitationModal() {
        document.getElementById("invitationForm").reset();
        document.getElementById("invitationModal").style.display = "block";
        // Show building select for admins only
        if (currentUser && currentUser.role === "ADMIN") {
          document.getElementById("inviteBuildingGroup").style.display =
            "block";
          populateInviteBuildings();
        } else {
          document.getElementById("inviteBuildingGroup").style.display = "none";
        }
      }

      function closeInvitationModal() {
        document.getElementById("invitationModal").style.display = "none";
      }

      async function editEmployee(employeeId) {
        try {
          const employee = await apiRequest(`/employees/${employeeId}`);
          editingEmployeeId = employeeId;
          document.getElementById("employeeModalTitle").textContent =
            "Edit Employee";
          document.getElementById("firstName").value = employee.firstName;
          document.getElementById("lastName").value = employee.lastName;
          document.getElementById("email").value = employee.email;
          document.getElementById("phoneNumber").value =
            employee.phoneNumber || "";
          document.getElementById("dateOfBirth").value =
            employee.dateOfBirth || "";
          document.getElementById("address").value = employee.address || "";
          document.getElementById("emergencyContactName").value =
            employee.emergencyContactName || "";
          document.getElementById("emergencyContactRelation").value =
            employee.emergencyContactRelation || "";
          document.getElementById("emergencyContactPhone").value =
            employee.emergencyContactPhone || "";
          document.getElementById("role").value = employee.role;
          document.getElementById("department").value =
            employee.departmentId || "";
          document.getElementById("active").value = employee.active.toString();
          // Show building dropdown for admins
          const buildingGroup = document.getElementById("buildingGroup");
          const buildingSelect = document.getElementById("employeeBuilding");
          if (currentUser && currentUser.role === "ADMIN") {
            buildingGroup.style.display = "block";
            buildingSelect.innerHTML =
              '<option value="">Select Building</option>';
            buildings.forEach((b) => {
              const option = document.createElement("option");
              option.value = b.id;
              option.textContent = b.name;
              if (employee.buildingId == b.id) option.selected = true;
              buildingSelect.appendChild(option);
            });
          } else {
            buildingGroup.style.display = "none";
          }
          document.getElementById("employeeModal").style.display = "block";
          // Show the Generate Change Password Link button for admins/managers
          const generatePasswordLinkBtn = document.getElementById(
            "generatePasswordLinkBtn"
          );
          if (
            currentUser &&
            (currentUser.role === "ADMIN" || currentUser.role === "MANAGER")
          ) {
            generatePasswordLinkBtn.style.display = "inline-block";
          } else {
            generatePasswordLinkBtn.style.display = "none";
          }
          // Hide the link container by default
          document.getElementById("changePasswordLinkContainer").style.display =
            "none";
        } catch (error) {
          showAlert("Failed to load employee details", "error");
        }
      }

      async function handleEmployeeSubmit(e) {
        e.preventDefault();
        const form = e.target;
        const formData = new FormData(form);
        // Helper to trim and nullify empty strings
        function cleanField(val) {
          if (val === undefined || val === null) return null;
          if (typeof val !== "string") return val;
          const trimmed = val.trim();
          return trimmed === "" ? null : trimmed;
        }
        // Debug: log all form values
        console.debug(
          "handleEmployeeSubmit: formData",
          Object.fromEntries(formData.entries())
        );
        // Validate required fields
        const firstName = cleanField(formData.get("firstName"));
        const lastName = cleanField(formData.get("lastName"));
        const email = cleanField(formData.get("email"));
        let role = cleanField(formData.get("role"));
        if (!role) role = "EMPLOYEE";
        const validRoles = ["EMPLOYEE", "MANAGER", "ADMIN"];
        if (!firstName || !lastName || !email || !validRoles.includes(role)) {
          console.debug("Validation failed", {
            firstName,
            lastName,
            email,
            role,
          });
          showAlert(
            "Please fill all required fields and select a valid role.",
            "error"
          );
          return;
        }
        let departmentIdRaw = formData.get("departmentId");
        let departmentId = null;
        if (
          departmentIdRaw &&
          departmentIdRaw !== "" &&
          !isNaN(departmentIdRaw)
        ) {
          departmentId = parseInt(departmentIdRaw);
        }
        // Debug: log departmentId
        console.debug(
          "departmentIdRaw",
          departmentIdRaw,
          "departmentId",
          departmentId
        );
        // Ensure current admin/manager/employee has valid user ID
        const userInfo = localStorage.getItem("userInfo");
        let user = null;
        if (userInfo) {
          try {
            user = JSON.parse(userInfo);
          } catch (e) {
            user = null;
          }
        }
        // Debug: log user and user.id
        console.debug(
          "userInfo",
          userInfo,
          "user",
          user,
          "user.id",
          user && user.id
        );
        if (
          !user ||
          typeof user.id === "undefined" ||
          user.id === null ||
          isNaN(Number(user.id))
        ) {
          showAlert(
            "Your account is missing an employee ID. Please log out and log in again.",
            "error"
          );
          console.error("User validation failed: missing or invalid id", user);
          return;
        }
        // Always send departmentId as a number or null
        if (departmentId !== null) departmentId = Number(departmentId);
        // Send all employee fields to backend, and include admin/manager id for auditing if needed
        const employeeData = {
          firstName,
          lastName,
          email,
          phoneNumber: cleanField(formData.get("phoneNumber")),
          dateOfBirth: cleanField(formData.get("dateOfBirth")),
          address: cleanField(formData.get("address")),
          emergencyContactName: cleanField(
            formData.get("emergencyContactName")
          ),
          emergencyContactRelation: cleanField(
            formData.get("emergencyContactRelation")
          ),
          emergencyContactPhone: cleanField(
            formData.get("emergencyContactPhone")
          ),
          role,
          departmentId,
          // Optionally send admin/manager id for backend auditing
          adminId: user.id,
          // For admins, update buildingId/buildingName
          ...(currentUser && currentUser.role === "ADMIN"
            ? (() => {
                const buildingSelect =
                  document.getElementById("employeeBuilding");
                const buildingId = buildingSelect ? buildingSelect.value : null;
                const buildingName = buildingSelect
                  ? buildingSelect.options[buildingSelect.selectedIndex]
                      ?.text || ""
                  : "";
                return { buildingId, buildingName };
              })()
            : {}),
        };
        // Debug: log employeeData and adminId
        console.debug("employeeData", employeeData, "adminId", user.id);
        try {
          let apiResult;
          if (editingEmployeeId) {
            console.debug("Updating employee", editingEmployeeId);
            apiResult = await apiRequest(`/employees/${editingEmployeeId}`, {
              method: "PUT",
              body: JSON.stringify(employeeData),
            });
            console.debug("Update result", apiResult);
            showAlert("Employee updated successfully!", "success");
          } else {
            console.debug("Creating employee");
            apiResult = await apiRequest("/employees", {
              method: "POST",
              body: JSON.stringify(employeeData),
            });
            console.debug("Create result", apiResult);
            showAlert("Employee created successfully!", "success");
          }
          form.reset();
          closeEmployeeModal();
          await loadEmployees();
        } catch (error) {
          console.error("Failed to save employee", error);
          showAlert(
            "Failed to save employee. Please check required fields, role, and email uniqueness.",
            "error"
          );
        }
      }

      async function handleInvitationSubmit(e) {
        e.preventDefault();

        const formData = new FormData(e.target);
        const invitationData = {
          firstName: formData.get("firstName"),
          lastName: formData.get("lastName"),
          email: formData.get("email"),
          phoneNumber: formData.get("phoneNumber"),
          role: formData.get("role"),
          departmentId: parseInt(formData.get("departmentId")),
          notes: formData.get("notes"),
          expiryDays: parseInt(formData.get("expiryDays")),
        };
        // For admins, add buildingId/buildingName
        if (currentUser && currentUser.role === "ADMIN") {
          const buildingSelect = document.getElementById("inviteBuilding");
          const buildingId = buildingSelect.value;
          const buildingName =
            buildingSelect.options[buildingSelect.selectedIndex]?.text || "";
          invitationData.buildingId = buildingId;
          invitationData.buildingName = buildingName;
        }

        try {
          const response = await apiRequest("/auth/generate-invitation", {
            method: "POST",
            body: JSON.stringify(invitationData),
          });

          showAlert("Invitation created successfully!", "success");
          closeInvitationModal();
          loadPendingInvitations();

          // Show the invitation link
          const inviteUrl = `${window.location.origin}/register.html?code=${response.invitationCode}&token=${response.invitationToken}`;
          prompt(
            "Invitation link created! Copy this link to send to the employee:",
            inviteUrl
          );
        } catch (error) {
          showAlert("Failed to create invitation. Please try again.", "error");
        }
      }

      async function toggleEmployeeStatus(employeeId, active) {
        if (!active) {
          if (!confirm("Are you sure you want to deactivate this employee?"))
            return;
          try {
            await apiRequest(`/employees/${employeeId}/delete`, {
              method: "DELETE",
            });
            showAlert("Employee deactivated successfully!", "success");
            await loadEmployees();
            filterEmployees();
          } catch (error) {
            showAlert("Failed to deactivate employee", "error");
          }
        } else {
          // Optionally implement activation endpoint in backend, or show error
          showAlert(
            "Activation is not supported. Please contact admin.",
            "error"
          );
        }
      }

      function viewEmployeeSchedule(employeeId) {
        window.location.href = `shifts.html?employeeId=${employeeId}`;
      }

      async function copyInvitationLink(token, code) {
        const inviteUrl = `${window.location.origin}/register.html?code=${code}&token=${token}`;
        try {
          await navigator.clipboard.writeText(inviteUrl);
          showAlert("Invitation link copied to clipboard!", "success");
        } catch (error) {
          prompt("Copy this invitation link:", inviteUrl);
        }
      }

      async function resendInvitation(invitationId) {
        try {
          // No direct resend endpoint in backend, so just show info for now
          showAlert("Resend functionality not implemented in backend.", "info");
        } catch (error) {
          showAlert("Failed to resend invitation", "error");
        }
      }

      async function revokeInvitation(invitationId) {
        if (!confirm("Are you sure you want to revoke this invitation?"))
          return;
        try {
          await apiRequest(`/auth/delete-invitation/${invitationId}`, {
            method: "DELETE",
          });
          showAlert("Invitation revoked successfully!", "success");
          loadPendingInvitations();
        } catch (error) {
          showAlert("Failed to revoke invitation", "error");
        }
      }

      function showAlert(message, type = "info") {
        const alertContainer = document.getElementById("alertContainer");
        const alertClass = type === "error" ? "alert-error" : "alert-success";
        alertContainer.innerHTML = `
            <div class="alert ${alertClass}">
                ${message}
            </div>
        `;
        setTimeout(() => {
          alertContainer.innerHTML = "";
        }, 5000);
      }

      function formatDate(dateString) {
        if (!dateString) return "N/A";
        const date = new Date(dateString);
        if (isNaN(date.getTime())) return dateString;
        return date.toLocaleDateString() + " " + date.toLocaleTimeString();
      }

      function canManageEmployees() {
        return (
          currentUser &&
          (currentUser.role === "MANAGER" || currentUser.role === "ADMIN")
        );
      }

      // Bulk Import Modal
      // Building Creation Modal
      if (!document.getElementById("createBuildingModal")) {
        const buildingModalHtml = `
        <div id="createBuildingModal" class="modal">
          <div class="modal-content">
            <div class="modal-header">
              <h3 class="modal-title">Add New Building</h3>
              <button class="close" onclick="closeCreateBuildingModal()">&times;</button>
            </div>
            <form id="createBuildingForm">
              <div class="form-group">
                <label for="buildingName">Building Name</label>
                <input type="text" id="buildingName" name="buildingName" required />
              </div>
              <div class="action-buttons">
                <button type="submit" class="btn btn-primary">üè¢ Create Building</button>
                <button type="button" class="btn btn-secondary" onclick="closeCreateBuildingModal()">‚ùå Cancel</button>
              </div>
            </form>
            <div id="createBuildingResult" style="margin-top:1em;"></div>
          </div>
        </div>
        `;
        document.body.insertAdjacentHTML("beforeend", buildingModalHtml);
      }

      window.openCreateBuildingModal = function () {
        document.getElementById("createBuildingForm").reset();
        document.getElementById("createBuildingResult").innerHTML = "";
        document.getElementById("createBuildingModal").style.display = "block";
      };
      window.closeCreateBuildingModal = function () {
        document.getElementById("createBuildingModal").style.display = "none";
      };
      document
        .getElementById("createBuildingForm")
        ?.addEventListener("submit", async function (e) {
          e.preventDefault();
          const name = document.getElementById("buildingName").value.trim();
          if (!name) {
            document.getElementById(
              "createBuildingResult"
            ).innerHTML = `<div class='alert alert-error'>Building name is required.</div>`;
            return;
          }
          const token = localStorage.getItem("authToken");
          try {
            const response = await fetch(`${API_BASE_URL}/buildings`, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${token}`,
              },
              body: JSON.stringify({ name }),
            });
            const resultDiv = document.getElementById("createBuildingResult");
            if (response.status === 409) {
              // Duplicate building name
              const text = await response.text();
              resultDiv.innerHTML = `<div class='alert alert-error'>${text}</div>`;
              return;
            }
            if (!response.ok) {
              const text = await response.text();
              resultDiv.innerHTML = `<div class='alert alert-error'>Building creation failed: ${text}</div>`;
              return;
            }
            const data = await response.json();
            resultDiv.innerHTML = `<div class='alert alert-success'>Building created! Name: ${data.name}, ID: ${data.id}</div>`;
            closeCreateBuildingModal();
            await loadBuildingsByAdmin();
          } catch (err) {
            document.getElementById(
              "createBuildingResult"
            ).innerHTML = `<div class='alert alert-error'>Building creation failed. Please try again.</div>`;
          }
        });
      // Placed at the end of body for correct scope
      // Only one instance will be appended
      if (!document.getElementById("bulkImportModal")) {
        const modalHtml = `
        <div id="bulkImportModal" class="modal">
          <div class="modal-content">
            <div class="modal-header">
              <h3 class="modal-title">Bulk Import Employees</h3>
              <button class="close" onclick="closeBulkImportModal()">&times;</button>
            </div>
            <form id="bulkImportForm">
              <div class="form-group">
                <label for="bulkFile">Upload CSV File</label>
                <input type="file" id="bulkFile" name="bulkFile" accept=".csv" required />
              </div>
              <div class="form-group">
                <small>CSV must include: firstName, lastName, email, role, departmentId (optional: phoneNumber, dateOfBirth, address, emergencyContactName, emergencyContactRelation, emergencyContactPhone)</small>
              </div>
              <div class="action-buttons">
                <button type="submit" class="btn btn-primary">‚¨ÜÔ∏è Import</button>
                <button type="button" class="btn btn-secondary" onclick="closeBulkImportModal()">‚ùå Cancel</button>
              </div>
            </form>
            <div id="bulkImportResult" style="margin-top:1em;"></div>
          </div>
        </div>
      `;
        document.body.insertAdjacentHTML("beforeend", modalHtml);
      }

      // Bulk Import Modal JS
      window.openBulkImportModal = function () {
        document.getElementById("bulkImportForm").reset();
        document.getElementById("bulkImportResult").innerHTML = "";
        document.getElementById("bulkImportModal").style.display = "block";
      };
      window.closeBulkImportModal = function () {
        document.getElementById("bulkImportModal").style.display = "none";
      };
      document
        .getElementById("bulkImportForm")
        ?.addEventListener("submit", async function (e) {
          e.preventDefault();
          const fileInput = document.getElementById("bulkFile");
          if (!fileInput.files.length) return;
          const file = fileInput.files[0];
          const formData = new FormData();
          formData.append("file", file);
          const token = localStorage.getItem("authToken");
          try {
            const response = await fetch(
              `${API_BASE_URL}/employees/bulk-import`,
              {
                method: "POST",
                headers: { Authorization: `Bearer ${token}` },
                body: formData,
              }
            );
            const resultDiv = document.getElementById("bulkImportResult");
            if (!response.ok) {
              const text = await response.text();
              resultDiv.innerHTML = `<div class='alert alert-error'>Import failed: ${text}</div>`;
              return;
            }
            const data = await response.json();
            let html = `<div class='alert alert-success'>${data.successCount} employees imported.`;
            if (data.failures && data.failures.length > 0) {
              html += `<br>Failures:<ul>`;
              data.failures.forEach((f) => {
                html += `<li>${f.row}: ${f.reason}</li>`;
              });
              html += `</ul>`;
            }
            html += `</div>`;
            resultDiv.innerHTML = html;
            loadEmployees();
          } catch (err) {
            document.getElementById(
              "bulkImportResult"
            ).innerHTML = `<div class='alert alert-error'>Import failed. Please try again.</div>`;
          }
        });
    </script>
  </body>
</html>
