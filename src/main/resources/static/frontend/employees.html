<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Employee Directory - Hotel Scheduler</title>
    <link rel="stylesheet" href="style.css">
  </head>
  <body>
    <div class="header">
      <div class="header-content">
        <div class="logo">üè® Hotel Scheduler</div>
        <nav class="nav-links" id="navigation">
          <!-- Navigation will be populated based on user role -->
        </nav>
        <div class="user-info">
          <span id="userName">Loading...</span>
          <button class="btn btn-danger btn-small" onclick="logout()">
            Logout
          </button>
        </div>
      </div>
    </div>

    <div class="container">

      <div class="filters">
        <div class="filter-row" style="display: flex; flex-wrap: nowrap; align-items: flex-end; gap: 1em; overflow-x: auto;">
          <div class="filter-group" style="min-width: 180px;">
            <label for="searchTerm">Search Employee</label>
            <input
              type="text"
              id="searchTerm"
              placeholder="Search by name, email, or phone"
            />
          </div>
          <div class="filter-group" style="min-width: 140px;">
            <label for="buildingFilter">Building</label>
            <select id="buildingFilter">
              <option value="">All Buildings</option>
            </select>
          </div>
          <div class="filter-group" style="min-width: 140px;">
            <label for="departmentFilter">Department</label>
            <select id="departmentFilter">
              <option value="">All Departments</option>
            </select>
          </div>
          <div class="filter-group" style="min-width: 120px;">
            <label for="roleFilter">Role</label>
            <select id="roleFilter">
              <option value="">All Roles</option>
              <option value="ADMIN">Admin</option>
              <option value="MANAGER">Manager</option>
              <option value="EMPLOYEE">Employee</option>
            </select>
          </div>
          <div class="filter-group" style="min-width: 120px;">
            <label for="statusFilter">Status</label>
            <select id="statusFilter">
              <option value="">All Statuses</option>
              <option value="true">Active</option>
              <option value="false">Inactive</option>
            </select>
          </div>
          <div class="action-buttons" id="actionButtons" style="display: flex; gap: 0.5em; align-items: flex-end; min-width: 420px;">
            <!-- Buttons will be populated based on user role -->
          </div>
        </div>
      </div>

      <div id="alertContainer"></div>

      <div id="employeesContainer">
        <div class="loading">
          <div class="spinner"></div>
          <p>Loading employees...</p>
        </div>
      </div>

      <!-- Employee Registration Invitation Section (Admin/Manager only) -->
      <div
        id="invitationSection"
        class="invitation-section"
        style="display: none"
      >
        <h3 class="invitation-title">üìß Employee Registration Invitations</h3>
        <p>
          Create secure invitation links for new employees to register with
          proper documentation.
        </p>

        <button class="btn btn-primary" onclick="openInvitationModal()">
          ‚ûï Create Invitation Link
        </button>

        <div id="pendingInvitations" class="pending-invitations">
          <!-- Pending invitations will be loaded here -->
        </div>
      </div>
    </div>

    <!-- Employee Modal -->
    <div id="employeeModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title" id="employeeModalTitle">Employee Details</h3>
          <button class="close" onclick="closeEmployeeModal()">&times;</button>
        </div>
        <form id="employeeForm">
          <div class="form-row">
            <div class="form-group">
              <label for="firstName">First Name</label>
              <input type="text" id="firstName" name="firstName" required />
            </div>
            <div class="form-group">
              <label for="lastName">Last Name</label>
              <input type="text" id="lastName" name="lastName" required />
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="email">Email Address</label>
              <input type="email" id="email" name="email" required />
            </div>
            <div class="form-group">
              <label for="phoneNumber">Phone Number</label>
              <input type="tel" id="phoneNumber" name="phoneNumber" />
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="dateOfBirth">Date of Birth</label>
              <input type="date" id="dateOfBirth" name="dateOfBirth" />
            </div>
            <div class="form-group">
              <label for="address">Address</label>
              <input type="text" id="address" name="address" />
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="emergencyContactName">Emergency Contact Name</label>
              <input type="text" id="emergencyContactName" name="emergencyContactName" />
            </div>
            <div class="form-group">
              <label for="emergencyContactRelation">Emergency Contact Relation</label>
              <input type="text" id="emergencyContactRelation" name="emergencyContactRelation" />
            </div>
            <div class="form-group">
              <label for="emergencyContactPhone">Emergency Contact Phone</label>
              <input type="tel" id="emergencyContactPhone" name="emergencyContactPhone" />
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="role">Role</label>
              <select id="role" name="role" required>
                <option value="EMPLOYEE">Employee</option>
                <option value="MANAGER">Manager</option>
                <option value="ADMIN">Admin</option>
              </select>
            </div>
            <div class="form-group">
              <label for="department">Department</label>
              <select id="department" name="departmentId">
                <option value="">Select Department</option>
              </select>
            </div>
          </div>
          <div class="form-group">
            <label for="active">Status</label>
            <select id="active" name="active">
              <option value="true">Active</option>
              <option value="false">Inactive</option>
            </select>
          </div>
          <div class="action-buttons">
            <button type="submit" class="btn btn-primary">
              üíæ Save Employee
            </button>
            <button
              type="button"
              class="btn btn-secondary"
              onclick="closeEmployeeModal()"
            >
              ‚ùå Cancel
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Invitation Modal -->
    <div id="invitationModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title">Create Employee Invitation</h3>
          <button class="close" onclick="closeInvitationModal()">
            &times;
          </button>
        </div>
        <form id="invitationForm">
          <div class="form-row">
            <div class="form-group">
              <label for="inviteFirstName">First Name</label>
              <input
                type="text"
                id="inviteFirstName"
                name="firstName"
                required
              />
            </div>
            <div class="form-group">
              <label for="inviteLastName">Last Name</label>
              <input type="text" id="inviteLastName" name="lastName" required />
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="inviteEmail">Email Address</label>
              <input type="email" id="inviteEmail" name="email" required />
            </div>
            <div class="form-group">
              <label for="invitePhone">Phone Number</label>
              <input type="tel" id="invitePhone" name="phoneNumber" required />
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="inviteRole">Default Role</label>
              <select id="inviteRole" name="role" required>
                <option value="EMPLOYEE">Employee</option>
                <option value="MANAGER">Manager</option>
              </select>
            </div>
            <div class="form-group">
              <label for="inviteDepartment">Department</label>
              <select id="inviteDepartment" name="departmentId" required>
                <option value="">Select Department</option>
              </select>
            </div>
          </div>
          <div class="form-group">
            <label for="inviteNotes">Notes for HR/Legal</label>
            <textarea
              id="inviteNotes"
              name="notes"
              rows="3"
              placeholder="Documentation requirements, position details, etc."
            ></textarea>
          </div>
          <div class="form-group">
            <label for="expiryDays">Invitation Expires In (Days)</label>
            <select id="expiryDays" name="expiryDays">
              <option value="7">7 Days</option>
              <option value="14" selected>14 Days</option>
              <option value="30">30 Days</option>
            </select>
          </div>
          <div class="action-buttons">
            <button type="submit" class="btn btn-primary">
              üìß Generate Invitation Link
            </button>
            <button
              type="button"
              class="btn btn-secondary"
              onclick="closeInvitationModal()"
            >
              ‚ùå Cancel
            </button>
          </div>
        </form>
      </div>
    </div>

    <script src="auto-logout.js"></script>
    <script src="auth-manager.js"></script>
    <script>
      let currentUser = null;
      const API_BASE_URL = window.location.origin + '/api';

      // Initialize page
      document.addEventListener("DOMContentLoaded", async function () {
        if (!authManager.checkAuth(["MANAGER", "ADMIN"])) return;

        loadUserInfo();
        await loadBuildingsByAdmin();
        loadDepartments();
        loadEmployees();
        setupEventListeners();
        setupActionButtons();

        // Load invitations if user is admin/manager
        if (canManageEmployees()) {
          loadPendingInvitations();
          document.getElementById("invitationSection").style.display = "block";
        }
      });
      let buildings = [];

      async function loadBuildingsByAdmin() {
        try {
          const userInfo = localStorage.getItem("userInfo");
          if (!userInfo) return;
          const user = JSON.parse(userInfo);
          let buildingsResult = [];
          if (user.role === "ADMIN") {
            buildingsResult = await apiRequest(`/buildings/by-admin/${user.id}`);
          } else if (user.role === "MANAGER") {
            // For managers, only show buildings where they are the admin
            buildingsResult = await apiRequest(`/buildings/by-admin/${user.id}`);
          }
          buildings = buildingsResult;
          populateBuildingSelect();
        } catch (error) {
          console.error("Failed to load buildings:", error);
        }
      }

      function populateBuildingSelect() {
        const select = document.getElementById("buildingFilter");
        if (!select) return;
        select.innerHTML = '<option value="">All Buildings</option>';
        buildings.forEach((building) => {
          const option = document.createElement("option");
          option.value = building.id;
          option.textContent = building.name;
          select.appendChild(option);
        });
      }

      function setupEventListeners() {
        document
          .getElementById("searchTerm")
          .addEventListener("input", filterEmployees);
        document
          .getElementById("buildingFilter")
          .addEventListener("change", filterEmployees);
        document
          .getElementById("departmentFilter")
          .addEventListener("change", filterEmployees);
        document
          .getElementById("roleFilter")
          .addEventListener("change", filterEmployees);
        document
          .getElementById("statusFilter")
          .addEventListener("change", filterEmployees);
        document
          .getElementById("employeeForm")
          .addEventListener("submit", handleEmployeeSubmit);
        document
          .getElementById("invitationForm")
          .addEventListener("submit", handleInvitationSubmit);
      }

      function setupActionButtons() {
        const actionButtons = document.getElementById("actionButtons");
        if (canManageEmployees()) {
          actionButtons.innerHTML = `
                          <button class="btn btn-primary" onclick="openCreateEmployeeModal()">
                              ‚ûï Add Employee
                          </button>
                          <button class="btn btn-secondary" onclick="openBulkImportModal()">
                              ‚ûï Add Employees by File
                          </button>
                          <button class="btn btn-secondary" onclick="refreshWithFilters()">
                              üîÑ Refresh
                          </button>
                          <button class="btn btn-success" onclick="exportEmployeesFiltered()">
                              üìä Export
                          </button>
                      `;
        } else {
          actionButtons.innerHTML = `
                          <button class="btn btn-secondary" onclick="refreshWithFilters()">
                              üîÑ Refresh
                          </button>
                      `;
        }
      }

      // Refresh button that reloads and re-applies filters
      async function refreshWithFilters() {
        await loadEmployees();
        filterEmployees();
      }

      // Export only currently filtered employees
      function exportEmployeesFiltered() {
        // Get current filtered employees
        const searchTerm = document.getElementById("searchTerm").value.toLowerCase();
        const buildingFilter = document.getElementById("buildingFilter").value;
        const departmentFilter = document.getElementById("departmentFilter").value;
        const roleFilter = document.getElementById("roleFilter").value;
        const statusFilter = document.getElementById("statusFilter").value;
        const filtered = employees.filter((employee) => {
          const matchesSearch =
            employee.firstName.toLowerCase().includes(searchTerm) ||
            employee.lastName.toLowerCase().includes(searchTerm) ||
            employee.email.toLowerCase().includes(searchTerm) ||
            (employee.phoneNumber && employee.phoneNumber.includes(searchTerm));
          const matchesBuilding = !buildingFilter || employee.buildingId == buildingFilter;
          const matchesDepartment = !departmentFilter || employee.departmentId == departmentFilter;
          const matchesRole = !roleFilter || employee.role === roleFilter;
          const matchesStatus = !statusFilter || employee.active.toString() === statusFilter;
          return matchesSearch && matchesBuilding && matchesDepartment && matchesRole && matchesStatus;
        });
      // Update filterEmployees to include building filter
      function filterEmployees() {
        const searchTerm = document.getElementById("searchTerm").value.toLowerCase();
        const buildingFilter = document.getElementById("buildingFilter").value;
        const departmentFilter = document.getElementById("departmentFilter").value;
        const roleFilter = document.getElementById("roleFilter").value;
        const statusFilter = document.getElementById("statusFilter").value;
        const filtered = employees.filter((employee) => {
          const matchesSearch =
            employee.firstName.toLowerCase().includes(searchTerm) ||
            employee.lastName.toLowerCase().includes(searchTerm) ||
            employee.email.toLowerCase().includes(searchTerm) ||
            (employee.phoneNumber && employee.phoneNumber.includes(searchTerm));
          const matchesBuilding = !buildingFilter || employee.buildingId == buildingFilter;
          const matchesDepartment = !departmentFilter || employee.departmentId == departmentFilter;
          const matchesRole = !roleFilter || employee.role === roleFilter;
          const matchesStatus = !statusFilter || employee.active.toString() === statusFilter;
          return matchesSearch && matchesBuilding && matchesDepartment && matchesRole && matchesStatus;
        });
        renderEmployees(filtered);
      }
        if (!filtered || filtered.length === 0) {
          showAlert("No employees to export.", "info");
          return;
        }
        const csvRows = [
          [
            "First Name",
            "Last Name",
            "Email",
            "Phone Number",
            "Date of Birth",
            "Address",
            "Emergency Contact Name",
            "Emergency Contact Relation",
            "Emergency Contact Phone",
            "Role",
            "Department",
            "Status",
            "Joined"
          ].join(",")
        ];
        filtered.forEach(emp => {
          csvRows.push([
            emp.firstName,
            emp.lastName,
            emp.email,
            emp.phoneNumber || "",
            emp.dateOfBirth || "",
            emp.address || "",
            emp.emergencyContactName || "",
            emp.emergencyContactRelation || "",
            emp.emergencyContactPhone || "",
            emp.role,
            emp.departmentName || "",
            emp.active ? "Active" : "Inactive",
            formatDate(emp.createdAt)
          ].map(val => `"${val}"`).join(","));
        });
        const csvContent = csvRows.join("\n");
        const blob = new Blob([csvContent], { type: "text/csv" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "employees_export.csv";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }

      // Authentication
      async function checkAuth() {
        const token = localStorage.getItem("authToken");
        const userInfo = localStorage.getItem("userInfo");

        if (!token || !userInfo) {
          window.location.href = "login.html";
          return false;
        }

        const user = JSON.parse(userInfo);

        try {
          // Validate token by making a test API call
          const response = await fetch(
            "http://localhost:8080/api/auth/validate",
            {
              method: "GET",
              headers: {
                Authorization: `Bearer ${token}`,
                "Content-Type": "application/json",
              },
            }
          );

          if (!response.ok) {
                localStorage.removeItem("authToken");
                localStorage.removeItem("userInfo");
                window.location.href = "login.html";
            return false;
          }

          return true;
        } catch (error) {
          console.error("Auth validation failed:", error);
            localStorage.removeItem("authToken");
            localStorage.removeItem("userInfo");
            window.location.href = "login.html";
          return false;
        }
      }

      function loadUserInfo() {
        const userInfo = localStorage.getItem("userInfo");
        if (userInfo) {
          currentUser = JSON.parse(userInfo);
          document.getElementById(
            "userName"
          ).textContent = `${currentUser.firstName} ${currentUser.lastName}`;
          setupNavigation(currentUser.role);
        }
      }

      function setupNavigation(userRole) {
        const navigation = document.getElementById("navigation");
        let navLinks = "";

        // Common links for all users
        navLinks += '<a href="dashboard.html" class="nav-link">Dashboard</a>';
        navLinks += '<a href="shifts.html" class="nav-link">Shifts</a>';
        navLinks += '<a href="trades.html" class="nav-link">Trades</a>';
        navLinks +=
          '<a href="notifications.html" class="nav-link">Notifications</a>';

        // Manager and Admin only links
        if (userRole === "MANAGER" || userRole === "ADMIN") {
          navLinks +=
            '<a href="employees.html" class="nav-link active">Employees</a>';
          navLinks += '<a href="reports.html" class="nav-link">Reports</a>';
          navLinks +=
            '<a href="departments.html" class="nav-link">Departments</a>';
        }

        navigation.innerHTML = navLinks;
      }

      function logout() {
        localStorage.removeItem("authToken");
        localStorage.removeItem("userInfo");
        window.location.href = "login.html";
      }

      // API Helpers
      async function apiRequest(endpoint, options = {}) {
        const token = localStorage.getItem("authToken");
        const url = `${API_BASE_URL}${endpoint}`;
 
         const config = {
             headers: {
                 "Content-Type": "application/json",
                 Authorization: `Bearer ${token}`,
                 ...options.headers,
             },
             ...options,
         };

        try {
          const response = await fetch(url, config);

          if (response.status === 401) {
                logout();
            return;
          }

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          return await response.json();
        } catch (error) {
          console.error("API Request failed:", error);
          showAlert("Network error. Please check your connection.", "error");
          throw error;
        }
      }

      // Load data
      async function loadDepartments() {
        try {
          departments = await apiRequest("/departments");
          populateDepartmentSelects();
        } catch (error) {
          console.error("Failed to load departments:", error);
        }
      }

      async function loadEmployees() {
        try {
          employees = await apiRequest("/employees");
          console.log("Loaded employees:", employees); // Add this line
          renderEmployees();
        } catch (error) {
          console.error("Failed to load employees:", error);
          document.getElementById("employeesContainer").innerHTML =
            '<div class="alert alert-error">Failed to load employees. Please try again.</div>';
        }
      }

      async function loadPendingInvitations() {
        try {
          // Use correct backend API for active invitations
          const invitations = await apiRequest("/auth/active-invitations");
          renderPendingInvitations(invitations);
        } catch (error) {
          console.error("Failed to load active invitations:", error);
        }
      }

      // Populate selects
      function populateDepartmentSelects() {
        const selects = ["departmentFilter", "department", "inviteDepartment"];
        selects.forEach((selectId) => {
          const select = document.getElementById(selectId);
          if (!select) return;

          if (selectId === "departmentFilter") {
            select.innerHTML = '<option value="">All Departments</option>';
          } else {
            select.innerHTML = '<option value="">Select Department</option>';
          }

          departments.forEach((dept) => {
            const option = document.createElement("option");
            option.value = dept.id;
            option.textContent = dept.name;
            select.appendChild(option);
          });
        });
      }

      // Render employees
      // Pagination variables
      let currentPage = 1;
      const employeesPerPage = 9;

      function renderEmployees(filteredEmployees = employees) {
        const container = document.getElementById("employeesContainer");
        if (filteredEmployees.length === 0) {
          container.innerHTML =
            '<div class="alert alert-info">No employees found for the selected criteria.</div>';
          document.getElementById("paginationContainer")?.remove();
          return;
        }

        // Pagination logic
        const totalEmployees = filteredEmployees.length;
        const totalPages = Math.ceil(totalEmployees / employeesPerPage);
        if (currentPage > totalPages) currentPage = totalPages;
        if (currentPage < 1) currentPage = 1;
        const startIdx = (currentPage - 1) * employeesPerPage;
        const endIdx = startIdx + employeesPerPage;
        const employeesToShow = filteredEmployees.slice(startIdx, endIdx);

        const employeesHtml = employeesToShow
          .filter(function (employee) {
            // Managers cannot see admin accounts
            if (currentUser && currentUser.role === "MANAGER" && employee.role === "ADMIN") {
              return false;
            }
            return true;
          })
          .map(function (employee) {
            let html = '<div class="employee-card">';
            html += '<div class="employee-header">';
            html += "<div>";
            html +=
              '<div class="employee-name">' +
              employee.firstName +
              " " +
              employee.lastName +
              "</div>";
            html +=
              '<div class="employee-role role-' +
              employee.role.toLowerCase() +
              '">' +
              employee.role +
              "</div>";
            html += "</div>";
            html +=
              '<div class="employee-status">' +
              (employee.active ? "‚úÖ Active" : "‚ùå Inactive") +
              "</div>";
            html += "</div>";
            html += '<div class="employee-info">';
            html +=
              '<div class="employee-detail"><strong>Email:</strong> <span>' +
              employee.email +
              "</span></div>";
            html +=
              '<div class="employee-detail"><strong>Phone:</strong> <span>' +
              (employee.phoneNumber || "Not provided") +
              "</span></div>";
            html +=
              '<div class="employee-detail"><strong>Department:</strong> <span>' +
              (employee.departmentName || "Unassigned") +
              "</span></div>";
            html +=
              '<div class="employee-detail"><strong>Joined:</strong> <span>' +
              formatDate(employee.createdAt) +
              "</span></div>";
            html += "</div>";
            html += '<div class="employee-actions">';
            html +=
              '<button class="btn btn-primary btn-small" onclick="viewEmployeeSchedule(' +
              employee.id +
              ')">üìÖ Schedule</button>';
            if (canManageEmployees() && !(currentUser && currentUser.role === "MANAGER" && employee.role === "ADMIN")) {
              html +=
                '<button class="btn btn-secondary btn-small" onclick="editEmployee(' +
                employee.id +
                ')">‚úèÔ∏è Edit</button>';
              html +=
                '<button class="btn ' +
                (employee.active ? "btn-warning" : "btn-success") +
                ' btn-small" onclick="toggleEmployeeStatus(' +
                employee.id +
                ", " +
                !employee.active +
                ')">' +
                (employee.active ? "‚è∏Ô∏è Deactivate" : "‚ñ∂Ô∏è Activate") +
                "</button>";
            }
            html += "</div>";
            html += "</div>";
            return html;
          })
          .join("");
        container.innerHTML =
          '<div class="employees-grid">' + employeesHtml + "</div>";

        // Pagination controls
        let paginationHtml = '';
        if (totalPages > 1) {
          paginationHtml += '<div class="pagination-controls">';
          paginationHtml += `<button class="btn btn-secondary" onclick="changeEmployeePage(-1)" ${currentPage === 1 ? 'disabled' : ''}>&laquo; Prev</button>`;
          paginationHtml += `<span class="pagination-info"> Page ${currentPage} of ${totalPages} </span>`;
          paginationHtml += `<button class="btn btn-secondary" onclick="changeEmployeePage(1)" ${currentPage === totalPages ? 'disabled' : ''}>Next &raquo;</button>`;
          paginationHtml += '</div>';
        }
        // Remove old pagination if exists
        document.getElementById("paginationContainer")?.remove();
        // Add new pagination
        const pagDiv = document.createElement("div");
        pagDiv.id = "paginationContainer";
        pagDiv.innerHTML = paginationHtml;
        container.parentNode.appendChild(pagDiv);
      }

      // Change page
      window.changeEmployeePage = function (delta) {
        currentPage += delta;
        renderEmployees();
      }

      function renderPendingInvitations(invitations) {
        const container = document.getElementById("pendingInvitations");

        if (invitations.length === 0) {
          container.innerHTML = "<p>No pending invitations.</p>";
          return;
        }

        const invitationsHtml = invitations
          .map(function (invitation) {
            let html = '<div class="invitation-card">';
            html +=
              '<div class="employee-detail"><strong>Name:</strong> <span>' +
              invitation.firstName +
              " " +
              invitation.lastName +
              "</span></div>";
            html +=
              '<div class="employee-detail"><strong>Email:</strong> <span>' +
              invitation.email +
              "</span></div>";
            html +=
              '<div class="employee-detail"><strong>Role:</strong> <span>' +
              invitation.role +
              "</span></div>";
            html +=
              '<div class="employee-detail"><strong>Expires:</strong> <span>' +
              formatDate(invitation.expiresAt) +
              "</span></div>";
            html += '<div class="invitation-actions">';
            html +=
              '<button class="btn btn-primary btn-small" onclick="copyInvitationLink(\'' +
              invitation.token +
              "')\">üìã Copy Link</button>";
            html +=
              '<button class="btn btn-secondary btn-small" onclick="resendInvitation(\'' +
              invitation.id +
              "')\">üìß Resend</button>";
            html +=
              '<button class="btn btn-danger btn-small" onclick="revokeInvitation(\'' +
              invitation.id +
              "')\">üóëÔ∏è Revoke</button>";
            html += "</div>";
            html += "</div>";
            return html;
          })
          .join("");
        container.innerHTML = invitationsHtml;
      }

      // Filter employees
      function filterEmployees() {
        const searchTerm = document
          .getElementById("searchTerm")
          .value.toLowerCase();
        const departmentFilter =
          document.getElementById("departmentFilter").value;
        const roleFilter = document.getElementById("roleFilter").value;
        const statusFilter = document.getElementById("statusFilter").value;

        const filtered = employees.filter((employee) => {
          const matchesSearch =
            employee.firstName.toLowerCase().includes(searchTerm) ||
            employee.lastName.toLowerCase().includes(searchTerm) ||
            employee.email.toLowerCase().includes(searchTerm) ||
            (employee.phoneNumber && employee.phoneNumber.includes(searchTerm));

          const matchesDepartment =
            !departmentFilter || employee.departmentId == departmentFilter;
          const matchesRole = !roleFilter || employee.role === roleFilter;
          const matchesStatus =
            !statusFilter || employee.active.toString() === statusFilter;

          return (
            matchesSearch && matchesDepartment && matchesRole && matchesStatus
          );
        });

        renderEmployees(filtered);
      }

      // Modal functions
      function openCreateEmployeeModal() {
        editingEmployeeId = null;
        document.getElementById("employeeModalTitle").textContent =
          "Add New Employee";
        document.getElementById("employeeForm").reset();
        document.getElementById("employeeModal").style.display = "block";
      }

      function closeEmployeeModal() {
        document.getElementById("employeeModal").style.display = "none";
        editingEmployeeId = null;
      }

      function openInvitationModal() {
        document.getElementById("invitationForm").reset();
        document.getElementById("invitationModal").style.display = "block";
      }

      function closeInvitationModal() {
        document.getElementById("invitationModal").style.display = "none";
      }

      async function editEmployee(employeeId) {
        try {
          const employee = await apiRequest(`/employees/${employeeId}`);
          editingEmployeeId = employeeId;

          document.getElementById("employeeModalTitle").textContent =
            "Edit Employee";
          document.getElementById("firstName").value = employee.firstName;
          document.getElementById("lastName").value = employee.lastName;
          document.getElementById("email").value = employee.email;
          document.getElementById("phoneNumber").value = employee.phoneNumber || "";
          document.getElementById("dateOfBirth").value = employee.dateOfBirth || "";
          document.getElementById("address").value = employee.address || "";
          document.getElementById("emergencyContactName").value = employee.emergencyContactName || "";
          document.getElementById("emergencyContactRelation").value = employee.emergencyContactRelation || "";
          document.getElementById("emergencyContactPhone").value = employee.emergencyContactPhone || "";
          document.getElementById("role").value = employee.role;
          document.getElementById("department").value = employee.departmentId || "";
          document.getElementById("active").value = employee.active.toString();

          document.getElementById("employeeModal").style.display = "block";
        } catch (error) {
          showAlert("Failed to load employee details", "error");
        }
      }

      async function handleEmployeeSubmit(e) {
        e.preventDefault();

        const formData = new FormData(e.target);
        const employeeData = {
          firstName: formData.get("firstName"),
          lastName: formData.get("lastName"),
          email: formData.get("email"),
          phoneNumber: formData.get("phoneNumber") || null,
          dateOfBirth: formData.get("dateOfBirth") || null,
          address: formData.get("address") || null,
          emergencyContactName: formData.get("emergencyContactName") || null,
          emergencyContactRelation: formData.get("emergencyContactRelation") || null,
          emergencyContactPhone: formData.get("emergencyContactPhone") || null,
          role: formData.get("role"),
          departmentId: formData.get("departmentId")
            ? parseInt(formData.get("departmentId"))
            : null,
          active: formData.get("active") === "true",
        };

        try {
          if (editingEmployeeId) {
            await apiRequest(`/employees/${editingEmployeeId}`, {
              method: "PUT",
              body: JSON.stringify(employeeData),
            });
            showAlert("Employee updated successfully!", "success");
          } else {
            await apiRequest("/employees", {
              method: "POST",
              body: JSON.stringify(employeeData),
            });
            showAlert("Employee created successfully!", "success");
          }

          closeEmployeeModal();
          loadEmployees();
        } catch (error) {
          showAlert("Failed to save employee. Please try again.", "error");
        }
      }

      async function handleInvitationSubmit(e) {
        e.preventDefault();

        const formData = new FormData(e.target);
        const invitationData = {
          firstName: formData.get("firstName"),
          lastName: formData.get("lastName"),
          email: formData.get("email"),
          phoneNumber: formData.get("phoneNumber"),
          role: formData.get("role"),
          departmentId: parseInt(formData.get("departmentId")),
          notes: formData.get("notes"),
          expiryDays: parseInt(formData.get("expiryDays")),
        };

        try {
          const response = await apiRequest("/auth/generate-invitation", {
            method: "POST",
            body: JSON.stringify(invitationData),
          });

          showAlert("Invitation created successfully!", "success");
          closeInvitationModal();
          loadPendingInvitations();

          // Show the invitation link
          const inviteUrl = `${window.location.origin}/register.html?code=${response.invitationCode}&token=${response.invitationToken}`;
          prompt(
            "Invitation link created! Copy this link to send to the employee:",
            inviteUrl
          );
        } catch (error) {
          showAlert("Failed to create invitation. Please try again.", "error");
        }
      }

      async function toggleEmployeeStatus(employeeId, active) {
        if (!active) {
            if (!confirm("Are you sure you want to deactivate this employee?")) return;
            try {
                 await apiRequest(`/employees/${employeeId}/delete`, {
                     method: "DELETE"
                 });
                showAlert("Employee deactivated successfully!", "success");
                await loadEmployees();
                filterEmployees();
            } catch (error) {
                showAlert("Failed to deactivate employee", "error");
            }
        } else {
            // Optionally implement activation endpoint in backend, or show error
            showAlert("Activation is not supported. Please contact admin.", "error");
        }
      }

      function viewEmployeeSchedule(employeeId) {
        window.location.href = `shifts.html?employeeId=${employeeId}`;
      }

      async function copyInvitationLink(token, code) {
        const inviteUrl = `${window.location.origin}/register.html?code=${code}&token=${token}`;
        try {
          await navigator.clipboard.writeText(inviteUrl);
          showAlert("Invitation link copied to clipboard!", "success");
        } catch (error) {
          prompt("Copy this invitation link:", inviteUrl);
        }
      }

      async function resendInvitation(invitationId) {
        try {
          // No direct resend endpoint in backend, so just show info for now
          showAlert("Resend functionality not implemented in backend.", "info");
        } catch (error) {
          showAlert("Failed to resend invitation", "error");
        }
      }

      async function revokeInvitation(invitationId) {
        if (!confirm("Are you sure you want to revoke this invitation?")) return;
        try {
            await apiRequest(`/auth/delete-invitation/${invitationId}`, {
                method: "DELETE",
            });
            showAlert("Invitation revoked successfully!", "success");
            loadPendingInvitations();
        } catch (error) {
            showAlert("Failed to revoke invitation", "error");
        }
      }

      function showAlert(message, type = "info") {
        const alertContainer = document.getElementById("alertContainer");
        const alertClass = type === "error" ? "alert-error" : "alert-success";
        alertContainer.innerHTML = `
            <div class="alert ${alertClass}">
                ${message}
            </div>
        `;
        setTimeout(() => {
            alertContainer.innerHTML = "";
        }, 5000);
    }

    function formatDate(dateString) {
      if (!dateString) return "N/A";
      const date = new Date(dateString);
      if (isNaN(date.getTime())) return dateString;
      return date.toLocaleDateString() + " " + date.toLocaleTimeString();
    }

    function canManageEmployees() {
      return currentUser && (currentUser.role === "MANAGER" || currentUser.role === "ADMIN");
    }

    // Bulk Import Modal
    // Placed at the end of body for correct scope
    // Only one instance will be appended
    if (!document.getElementById('bulkImportModal')) {
      const modalHtml = `
        <div id="bulkImportModal" class="modal">
          <div class="modal-content">
            <div class="modal-header">
              <h3 class="modal-title">Bulk Import Employees</h3>
              <button class="close" onclick="closeBulkImportModal()">&times;</button>
            </div>
            <form id="bulkImportForm">
              <div class="form-group">
                <label for="bulkFile">Upload CSV File</label>
                <input type="file" id="bulkFile" name="bulkFile" accept=".csv" required />
              </div>
              <div class="form-group">
                <small>CSV must include: firstName, lastName, email, role, departmentId (optional: phoneNumber, dateOfBirth, address, emergencyContactName, emergencyContactRelation, emergencyContactPhone)</small>
              </div>
              <div class="action-buttons">
                <button type="submit" class="btn btn-primary">‚¨ÜÔ∏è Import</button>
                <button type="button" class="btn btn-secondary" onclick="closeBulkImportModal()">‚ùå Cancel</button>
              </div>
            </form>
            <div id="bulkImportResult" style="margin-top:1em;"></div>
          </div>
        </div>
      `;
      document.body.insertAdjacentHTML('beforeend', modalHtml);
    }

    // Bulk Import Modal JS
    window.openBulkImportModal = function() {
      document.getElementById('bulkImportForm').reset();
      document.getElementById('bulkImportResult').innerHTML = '';
      document.getElementById('bulkImportModal').style.display = 'block';
    }
    window.closeBulkImportModal = function() {
      document.getElementById('bulkImportModal').style.display = 'none';
    }
    document.getElementById('bulkImportForm')?.addEventListener('submit', async function(e) {
      e.preventDefault();
      const fileInput = document.getElementById('bulkFile');
      if (!fileInput.files.length) return;
      const file = fileInput.files[0];
      const formData = new FormData();
      formData.append('file', file);
      const token = localStorage.getItem('authToken');
      try {
        const response = await fetch(`${API_BASE_URL}/employees/bulk-import`, {
          method: 'POST',
          headers: { Authorization: `Bearer ${token}` },
          body: formData
        });
        const resultDiv = document.getElementById('bulkImportResult');
        if (!response.ok) {
          const text = await response.text();
          resultDiv.innerHTML = `<div class='alert alert-error'>Import failed: ${text}</div>`;
          return;
        }
        const data = await response.json();
        let html = `<div class='alert alert-success'>${data.successCount} employees imported.`;
        if (data.failures && data.failures.length > 0) {
          html += `<br>Failures:<ul>`;
          data.failures.forEach(f => {
            html += `<li>${f.row}: ${f.reason}</li>`;
          });
          html += `</ul>`;
        }
        html += `</div>`;
        resultDiv.innerHTML = html;
        loadEmployees();
      } catch (err) {
        document.getElementById('bulkImportResult').innerHTML = `<div class='alert alert-error'>Import failed. Please try again.</div>`;
      }
    });
    </script>
  </body>
</html>
